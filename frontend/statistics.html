<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–û–±—â–µ–∂–∏—Ç–∏–µ: –ë–ª–æ–∫–∏, –ö–æ–º–Ω–∞—Ç—ã, –°—Ç—É–¥–µ–Ω—Ç—ã –∏ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href='/css/statistics.css'>
    <script></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  </head>
<body>
    <header style="position: relative;">
      <h1>–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–æ–Ω–¥ "–ê—Å—Ç–∞–Ω–∞-20"</h1>

      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û –∏–ª–∏ –ò–ò–ù" />
      <!-- –ù–∞–π–¥–µ–Ω–æ: X ‚Äî —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ -->
      <div id="resultCount" style="margin-top: 4px; font-weight: bold;"></div>

      <button id="notificationsBtn" class="header-btn">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
      <button id="archiveBtn" class="header-btn">–ê—Ä—Ö–∏–≤ –≤—ã–±—ã–≤—à–∏—Ö</button>
      <button id="todayAddedBtn" class="header-btn">–°–µ–≥–æ–¥–Ω—è –¥–æ–±–∞–≤–∏–ª–∏</button>
      <button id="accountingBtn" class="header-btn">–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è</button>
      <button id="logoutBtn" class="header-btn" style="background-color: #d9534f; color: white; position: absolute; top: 10px; right: 10px;">–í—ã–π—Ç–∏</button>
    </header>

    <div id="loading" style="text-align: center; padding: 20px;">
      <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
    </div>
    <section class="stats-global" id="globalStats"></section>

    <div class="blocks-container" id="blocksContainer"></div>

    <div class="modal" id="dossierModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–ö–æ–º–Ω–∞—Ç–∞: <span id="dossierRoom"></span></h2>
          <span class="close" id="closeDossierModal">&times;</span>
        </div>
        <div class="modal-body">
          <div id="dossierContent"></div>
        </div>
      </div>
    </div>


    <div class="modal" id="departedModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–ê—Ä—Ö–∏–≤ –≤—ã–±—ã–≤—à–∏—Ö</h2>
          <span class="close" id="closeDepartedModal">&times;</span>
        </div>
        <div class="modal-body">
          <div id="departedContent"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="notificationsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
          <span class="close" id="closeNotificationsModal">&times;</span>
        </div>
        <div class="modal-body">
          <div class="tabs">
            <button id="expiredTab" class="tab-btn">–ò—Å—Ç–µ–∫–ª–∏</button>
            <button id="expiringTab" class="tab-btn">–ò—Å—Ç–µ–∫–∞—é—Ç</button>
            <button id="noCardTab" class="tab-btn">–ë–µ–∑ –∫–∞—Ä—Ç–æ—á–∫–∏</button>
          </div>
          <div id="expiredContent" class="tab-content"></div>
          <div id="expiringContent" class="tab-content" style="display: none;"></div>
          <div id="noCardContent" class="tab-content" style="display: none;"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="todayAddedModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–°–µ–≥–æ–¥–Ω—è –¥–æ–±–∞–≤–∏–ª–∏</h2>
          <span class="close" id="closeTodayAddedModal">&times;</span>
        </div>
        <div class="modal-body">
          <div id="todayAddedContent"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="accountingModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è</h2>
          <span class="close" id="closeAccountingModal">&times;</span>
        </div>
        <div class="modal-body">
          <button id="exportExcelBtn" style="
  background-color: #217346;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  margin: 12px auto;
  display: block;
  cursor: pointer;
">
  –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Excel
</button>
          <div class="tabs accounting-tabs">
            <button id="accountingTabDetails" class="tab-btn active">–ü–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º</button>
            <button id="accountingTabMonthly" class="tab-btn">–ü–æ –º–µ—Å—è—Ü–∞–º</button>
            <button id="accountingTabIncome" class="tab-btn">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</button>
          </div>
          <div class="tab-panels">
            <div id="accountingContentDetails" class="tab-content"></div>
            <div id="accountingContentMonthly" class="tab-content" style="display: none;"></div>
            <div id="accountingContentIncome" class="tab-content" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>


    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã -->
    <div class="modal" id="extendRentalModal">
      <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
        <h3>–ü—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤:</p>
        <div class="custom-select-wrapper" style="margin-top: 10px;">
          <div class="custom-select" id="displayExtendRental">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫</div>
          <div class="custom-options" id="optionsExtendRental">
            <div data-value="1">1 –º–µ—Å—è—Ü</div>
            <div data-value="2">2 –º–µ—Å—è—Ü–∞</div>
            <div data-value="3">3 –º–µ—Å—è—Ü–∞</div>
            <div data-value="4">4 –º–µ—Å—è—Ü–∞</div>
            <div data-value="5">5 –º–µ—Å—è—Ü–µ–≤</div>
            <div data-value="6">6 –º–µ—Å—è—Ü–µ–≤</div>
            <div data-value="7">7 –º–µ—Å—è—Ü–µ–≤</div>
            <div data-value="8">8 –º–µ—Å—è—Ü–µ–≤</div>
            <div data-value="9">9 –º–µ—Å—è—Ü–µ–≤</div>
            <div data-value="10">10 –º–µ—Å—è—Ü–µ–≤</div>
            <div data-value="11">11 –º–µ—Å—è—Ü–µ–≤</div>
            <div data-value="12">12 –º–µ—Å—è—Ü–µ–≤</div>
          </div>
          <input type="hidden" id="extendRentalHidden" />
        </div>
        <div style="margin-top: 20px; text-align: right;">
          <button class="btn btn-primary" onclick="confirmExtendRental()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
          <button class="btn btn-danger" onclick="closeExtendModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </body>
  <script>
    if (localStorage.getItem('auth') !== 'ok') {
      window.location.href = 'login.html';
    }
  </script>
  <script>
      // –í–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∫–æ–º–Ω–∞—Ç (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ allRooms –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
      let roomCapacities = {};

      // === –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –º–æ–¥–∞–ª–∫–∞—Ö) ===
      let currentRoom = "";

      // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
      let students = {}; // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
      let departedArchive = []; // –ê—Ä—Ö–∏–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞


      // --- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
      const state = {
        currentRoom: null,
        currentFiltered: null,
        searchQuery: "",
        modals: {
          dossier: false,
          departed: false,
          notifications: false,
          todayAdded: false
        }
      };

      function addMonths(date, months) {
        let d = new Date(date);
        d.setMonth(d.getMonth() + months);
        return d;
      }

      // --- LAZY LOADING ROOMS ---
      /**
       * –°–æ–∑–¥–∞—ë—Ç floorDiv —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –ø—É—Å—Ç—ã–º ul.room-list, –≥–¥–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ data-–∞—Ç—Ä–∏–±—É—Ç–∞—Ö ul
       */
      function createFloorDiv(block, floor, stats) {
        const floorDiv = document.createElement("div");
        floorDiv.classList.add("floor");
        const h3 = document.createElement("h3");
        h3.textContent = `–≠—Ç–∞–∂ ${floor}`;
        floorDiv.appendChild(h3);
        // –°–æ–±–∏—Ä–∞–µ–º –º–∞—Å—Å–∏–≤ –∫–æ–º–Ω–∞—Ç –∏ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ data-–∞—Ç—Ä–∏–±—É—Ç—ã
        const floorRooms = blocksData[block][floor];
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ data-–∞—Ç—Ä–∏–±—É—Ç–∞—Ö ul
        const ul = document.createElement("ul");
        ul.classList.add("room-list");
        ul.style.display = "none";
        ul.dataset.block = normalizeRoomId(block);
        ul.dataset.floor = floor;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –∫–æ–º–Ω–∞—Ç –∏ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ JSON –≤ data-rooms
        ul.dataset.rooms = JSON.stringify(
          floorRooms.map(room => ({
            room: normalizeRoomId(room),
            capacity: roomCapacities[room] || 5
          }))
        );
        // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —ç—Ç–∞–∂–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (stats) {
          ul.dataset.stats = JSON.stringify(stats);
        }
        floorDiv.appendChild(ul);
        return { floorDiv, ul, h3 };
      }

      /**
       * –°–æ–∑–¥–∞—ë—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –≤–Ω—É—Ç—Ä–∏ ul –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ –∏ students.
       * –ï—Å–ª–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç.
       * –¢–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã –∏ –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–æ–∏—Å–∫–∞.
       */
      function lazyLoadRooms(ul, stats) {
        if (ul.dataset.loaded === "true") return;
        let rooms = [];
        try {
          rooms = JSON.parse(ul.dataset.rooms);
        } catch (e) {
          return;
        }
        ul.innerHTML = "";
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ–º–Ω–∞—Ç –ø–æ –Ω–æ–º–µ—Ä—É (–¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
        rooms.sort((a, b) => {
          const aNum = parseInt(a.room.split("-")[1]);
          const bNum = parseInt(b.room.split("-")[1]);
          return aNum - bNum;
        });
        rooms.forEach(({ room, capacity }) => {
          const roomStudents = students[room] || [];
          const activeStudents = roomStudents.filter((s) => !s.left);
          // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (–∞–∫—Ç–∏–≤–Ω—ã—Ö)
          const displayCount = activeStudents.length;
          // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∫–æ–º–Ω–∞—Ç—ã
          const li = document.createElement("li");
          li.classList.add("room");
          li.innerHTML = createRoomStatusHTML({ id: room, occupied: displayCount, places: capacity });
          li.appendChild(createViewButton(room));
          ul.appendChild(li);
        });
        ul.dataset.loaded = "true";
      }

      /**
       * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç IntersectionObserver –¥–ª—è .floor, —á—Ç–æ–±—ã lazyLoadRooms –≤—ã–∑—ã–≤–∞–ª—Å—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ —ç—Ç–∞–∂–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
       * –¢–∞–∫–∂–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ –Ω–∞ —ç—Ç–∞–∂.
       */
      function setupLazyObserver() {
        const floors = document.querySelectorAll(".floor");
        const observer = new IntersectionObserver(
          (entries, obs) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const floorDiv = entry.target;
                const ul = floorDiv.querySelector("ul.room-list");
                if (ul && ul.dataset.loaded !== "true") {
                  lazyLoadRooms(ul);
                }
              }
            });
          },
          { root: null, rootMargin: "0px", threshold: 0.08 }
        );
        floors.forEach(floorDiv => {
          observer.observe(floorDiv);
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —ç—Ç–∞–∂–∞
          const h3 = floorDiv.querySelector("h3");
          const ul = floorDiv.querySelector("ul.room-list");
          if (h3 && ul) {
            h3.addEventListener("click", () => {
              // –°–∫—Ä—ã—Ç—å –≤—Å–µ room-list –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ
              const allLists = floorDiv.parentElement.querySelectorAll(".room-list");
              allLists.forEach(list => {
                if (list !== ul) list.style.display = "none";
              });
              // Lazy load –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏
              if (ul.dataset.loaded !== "true") {
                lazyLoadRooms(ul);
              }
              ul.style.display = ul.style.display === "none" ? "block" : "none";
            });
          }
        });
      }

      // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –∏ –∫–æ–º–Ω–∞—Ç –≤ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ ---
      function convertToCyrillic(letter) {
        if (letter === 'A') return '–ê';
        if (letter === 'B') return '–ë';
        if (letter === 'V') return '–í';
        return letter;
      }

      function convertRoomIdToCyrillic(roomId) {
        if (!roomId || typeof roomId !== 'string') return roomId;
        const parts = roomId.split('-');
        if (parts.length === 2) {
          return convertToCyrillic(parts[0]) + '-' + parts[1];
        }
        return roomId;
      }

      // –ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è generateBlocks() ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç allRooms {id, block, floor, places, occupied}
      function generateBlocks() {
        const container = document.getElementById("blocksContainer");
        container.innerHTML = "";

        if (typeof allRooms === "undefined" || !Array.isArray(allRooms)) {
          container.innerHTML = "<div style='color:red'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–Ω–∞—Ç–∞—Ö (allRooms –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω).</div>";
          return;
        }

        const blocks = {};
        allRooms.forEach(room => {
          const displayBlock = convertToCyrillic(room.block);
          if (!blocks[displayBlock]) blocks[displayBlock] = {};
          if (!blocks[displayBlock][room.floor]) blocks[displayBlock][room.floor] = [];
          blocks[displayBlock][room.floor].push(room);
        });

        let globalCapacity = 0;
        let globalOccupied = 0;

        for (let block in blocks) {
          const blockDiv = document.createElement("div");
          blockDiv.classList.add("block-column");
          blockDiv.innerHTML = `<h2>–ë–ª–æ–∫ ${convertToCyrillic(block)}</h2>`;

          let blockCapacity = 0;
          let blockOccupied = 0;

          for (let floor in blocks[block]) {
            const floorDiv = document.createElement("div");
            floorDiv.classList.add("floor");
            const h3 = document.createElement("h3");
            h3.textContent = `–≠—Ç–∞–∂ ${floor}`;
            const ul = document.createElement("ul");
            ul.classList.add("room-list");
            ul.style.display = "none";
            ul.dataset.block = normalizeRoomId(block);
            ul.dataset.floor = floor;
            ul.dataset.rooms = JSON.stringify(
              blocks[block][floor].map(roomObj => ({
                room: normalizeRoomId(roomObj.id),
                capacity: roomObj.places
              }))
            );
            // --- LOG ---
            // console.warn(`UL #${floor} ‚Äî {block: ${ul.dataset.block}, floor: ${ul.dataset.floor}, rooms: ${ul.dataset.rooms}}`);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ localStorage
            const storageKey = `floor-${block}-${floor}`;
            const isOpened = localStorage.getItem(storageKey) === "true";
            if (isOpened) {
              ul.style.display = "block";
              // ul.dataset.openedByStorage = "true";
            }

            // Sort rooms
            const roomsSorted = blocks[block][floor].slice().sort((a, b) => {
              const aNum = parseInt(a.id.split("-")[1]);
              const bNum = parseInt(b.id.split("-")[1]);
              return aNum - bNum;
            });

            roomsSorted.forEach(({ id, places }) => {
              const normalizedId = normalizeRoomId(id);
              const roomStudents = students[normalizedId] || [];
              const occupied = roomStudents.filter(s => !s.left).length;

              const li = document.createElement("li");
              li.classList.add("room");
              li.innerHTML = `
                <span class="room-number">${convertRoomIdToCyrillic(id)}</span>
                <span class="room-counter room-status ${occupied >= places ? "occupied" : "free"}">
                  ${occupied}/${places}
                </span>
              `;
              // --- –°–ü–ò–°–û–ö –°–¢–£–î–ï–ù–¢–û–í –í–ù–£–¢–†–ò –ö–ê–ñ–î–û–ô –ö–û–ú–ù–ê–¢–´ –£–î–ê–õ–Å–ù ---
              li.appendChild(createViewButton(id));
              ul.appendChild(li);
              // --- –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è ---
              li.classList.add("fade-in");
              setTimeout(() => li.classList.remove("fade-in"), 500);

              blockCapacity += places;
              blockOccupied += occupied;
            });

            h3.addEventListener("click", () => {
              const isNowVisible = ul.style.display === "none";
              ul.style.display = isNowVisible ? "block" : "none";
              const storageKey = `floor-${block}-${floor}`;
              if (isNowVisible) {
                localStorage.setItem(storageKey, "true");
              } else {
                localStorage.removeItem(storageKey);
              }
            });

            floorDiv.appendChild(h3);
            floorDiv.appendChild(ul);
            blockDiv.appendChild(floorDiv);
          }

          const blockFree = blockCapacity - blockOccupied;
          // –ù–æ–≤—ã–π –ø–æ–¥—Å—á—ë—Ç –≤—ã–±—ã–≤—à–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –±–ª–æ–∫–µ:
          const blockLeft = Object.entries(students)
            .filter(([room]) => normalizeRoomId(room).startsWith(normalizeRoomId(block)))
            .flatMap(([, arr]) => arr)
            .filter(s => s.left)
            .length;
          const statsHTML = `<div class="block-stats">–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${blockCapacity} –º–µ—Å—Ç | –ó–∞–Ω—è—Ç–æ: ${blockOccupied} | –°–≤–æ–±–æ–¥–Ω–æ: ${blockFree} | –í—ã–±—ã–≤—à–∏–µ: ${blockLeft}</div>`;
          blockDiv.insertAdjacentHTML("afterbegin", statsHTML);
          container.appendChild(blockDiv);

          globalCapacity += blockCapacity;
          globalOccupied += blockOccupied;
        }

        const globalFree = globalCapacity - globalOccupied;
        // –ù–æ–≤—ã–π –ø–æ–¥—Å—á—ë—Ç –≤—ã–±—ã–≤—à–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥–ª–æ–±–∞–ª—å–Ω–æ:
        const globalLeft = Object.values(students).flat().filter(s => s.left).length;
        const globalStats = document.getElementById("globalStats");
        globalStats.textContent = `–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${globalCapacity} –º–µ—Å—Ç | –ó–∞–Ω—è—Ç–æ: ${globalOccupied} | –°–≤–æ–±–æ–¥–Ω–æ: ${globalFree} | –í—ã–±—ã–≤—à–∏–µ: ${globalLeft}`;
      }

      // --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ roomId ---
      function normalizeRoomId(roomId = "") {
        return roomId
          .replace(/–ê/g, 'A')
          .replace(/–í/g, 'B')
          .replace(/–°/g, 'C')
          .replace(/–ï/g, 'E')
          .replace(/–ö/g, 'K')
          .replace(/–ú/g, 'M')
          .replace(/–ù/g, 'H')
          .replace(/–û/g, 'O')
          .replace(/–†/g, 'P')
          .replace(/–¢/g, 'T')
          .replace(/–•/g, 'X');
      }

      // --- WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã ---
      const socket = new WebSocket(`ws://${window.location.hostname}:3000`);

      socket.addEventListener("open", function () {
        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω (–ª–æ–≥ —É–¥–∞–ª—ë–Ω)
      });

socket.addEventListener("close", function () {
  console.warn("‚ö†Ô∏è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
  showToast("‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–µ—Ä–≤–∞–Ω–æ", "error");
});

socket.addEventListener("error", function (error) {
  console.error("‚ùå –û—à–∏–±–∫–∞ WebSocket:", error);
  showToast("‚ùå WebSocket –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ", "error");
});

socket.addEventListener("message", function (event) {
  // === –ù–æ–≤—ã–π –±–ª–æ–∫: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π markAsLeftSuccess/markAsLeftError ===
  if (event.data.includes('"type":"markAsLeftSuccess"')) {
    showToast("‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ", "success");
    return;
  }
  if (event.data.includes('"type":"markAsLeftError"')) {
    showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞", "error");
    return;
  }
  try {
    const data = JSON.parse(event.data);
    if (data.type === "roomUpdate" && data.roomId) {
            const rawRoomId = data.roomId;
            const normalizedRoomId = normalizeRoomId(rawRoomId);
            updateSingleRoom(normalizedRoomId, data.roomData);
            // generateBlocks(); // ‚ùå –£–¥–∞–ª–µ–Ω–æ: –º–µ—à–∞–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç—ã–º —ç—Ç–∞–∂–∞–º
          } else if (data.type === "newStudent" && data.student && data.roomId) {
            // --- [LOG] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö UL –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º –∫–æ–º–Ω–∞—Ç—ã ---
            // console.warn("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö UL –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º –∫–æ–º–Ω–∞—Ç—ã:");
            // document.querySelectorAll('ul.room-list').forEach((ul, i) => {
            //   console.log(`UL #${i}`, {
            //     block: ul.dataset.block,
            //     floor: ul.dataset.floor,
            //     rooms: ul.dataset.rooms
            //   });
            // });

            // 1. –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
            // console.log("üß† WebSocket: newStudent —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ");
            // console.log("üì® roomId:", data.roomId);
            // console.log("üë§ student:", data.student);
            const rawRoomId = data.roomId;
            const roomId = normalizeRoomId(rawRoomId);
            // console.log("üì¶ –ü–æ–ª—É—á–µ–Ω newStudent –ø–æ –∫–æ–º–Ω–∞—Ç–µ:", roomId);
            const { student } = data;
            const now = new Date();

            const safeStudent = {
              ...student,
              left: false,
              relative: student.relative || "",
              relativePhone: student.relativePhone || "",
              rentalPeriod: student.rentalPeriod || "",
              moveInDate: student.moveInDate || "",
              date_added: now.toDateString()
            };

            if (!students[roomId]) students[roomId] = [];
            students[roomId].push(safeStudent);
            // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å UI
            if (document.getElementById("studentModal")?.style.display === "block" && currentRoom === roomId) {
              openRoomModal(roomId); // –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É, –æ–Ω–∞ –ø–µ—Ä–µ—Ä–∏—Å—É–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            }
            // üîÑ –û–±–Ω–æ–≤–∏–º —Å—á—ë—Ç—á–∏–∫ –∫–æ–º–Ω–∞—Ç—ã
            const currentStudents = students[roomId]?.filter(s => !s.left) || [];
            const newRoomData = {
              places: roomCapacities[roomId] || 0,
              occupied: currentStudents.length
            };
            updateSingleRoom(roomId, newRoomData);
            // 2. –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞:
            // console.log("üìä –í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ", roomId, "=", students[roomId].length);
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–∞ —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É
            // 3. –î–æ –≤—ã–∑–æ–≤–∞ openDossierModal()
            // console.log("üìã –ú–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞?", document.getElementById("dossierModal").style.display);
            // console.log("üìç currentRoom:", currentRoom, "| incoming roomId:", roomId);
            // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .room-modal (–µ—Å–ª–∏ –µ—Å—Ç—å) ---
            const modal = document.querySelector(".room-modal");
            if (modal) {
              const title = modal.querySelector(".room-modal-title");
              if (title) {
                title.textContent = `–ö–æ–º–Ω–∞—Ç–∞ ${roomId}`;
              }
              const list = modal.querySelector(".room-modal-body");
              if (list) {
                list.innerHTML = "";
                students[roomId]?.forEach((student) => {
                  if (!student.left) {
                    const li = document.createElement("li");
                    li.textContent = student.fio;
                    list.appendChild(li);
                  }
                });
              }
            }
            if (document.getElementById("dossierModal").style.display === "flex" && currentRoom === roomId) {
              openDossierModal(roomId); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            }
            // roomList is not directly used here, but if you use it for searching elsewhere, update as follows:
            // Example: if (roomList.some(r => r.room === roomId)) { ... }
            // Replace with:
            // if (roomList.some(r => normalizeRoomId(r.room) === roomId)) { ... }

            const block = roomId.split("-")[0];
            const floor = roomId.split("-")[1].charAt(0);
            const ul = document.querySelector(`ul.room-list[data-block="${normalizeRoomId(block)}"][data-floor="${floor}"]`);

            // 4. –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ul:
            if (ul) {
              // console.log("üìÅ –ù–∞–π–¥–µ–Ω UL –¥–ª—è –±–ª–æ–∫–∞", block, "—ç—Ç–∞–∂–∞", floor);
              const roomsList = JSON.parse(ul.dataset.rooms || "[]");
              if (!roomsList.some(r => r.room === roomId)) {
                roomsList.push({ room: roomId, capacity: roomCapacities[roomId] || 0 });
                ul.dataset.rooms = JSON.stringify(roomsList);
              }
              if (ul.style.display !== "none") {
                ul.dataset.loaded = "false";
                ul.innerHTML = "";
                lazyLoadRooms(ul);
              }
            } else {
              console.warn("‚ö†Ô∏è UL –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –±–ª–æ–∫–∞", block, "—ç—Ç–∞–∂–∞", floor);
            }

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            showToast(`üë§ –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç—É–¥–µ–Ω—Ç: ${data.student?.fio || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"} –≤ –∫–æ–º–Ω–∞—Ç—É ${data.roomId}`, "success");
            // 5. –ü–æ—Å–ª–µ showToast(...)
            // console.log("üîî Toast –ø–æ–∫–∞–∑–∞–Ω:", `–î–æ–±–∞–≤–ª–µ–Ω —Å—Ç—É–¥–µ–Ω—Ç: ${student.fio}`);
            // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ "–°–µ–≥–æ–¥–Ω—è –¥–æ–±–∞–≤–∏–ª–∏" –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –µ—ë
            if (document.getElementById("todayAddedModal").style.display === "flex") {
              openTodayAddedModal();
            }
            // generateBlocks(); // ‚ùå –£–¥–∞–ª–µ–Ω–æ: –º–µ—à–∞–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç—ã–º —ç—Ç–∞–∂–∞–º
          }
          // === –î–æ–±–∞–≤–ª–µ–Ω–æ: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è globalUpdate ===
          else if (data.type === "globalUpdate") {
            // console.log("üåê –ü–æ–ª—É—á–µ–Ω globalUpdate");
            fetch("/api/rooms/all")
              .then(res => res.json())
              .then(data => {
                allRooms = data;
                generateBlocks();
              });
          }
          // === –ù–æ–≤—ã–π –±–ª–æ–∫: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è studentLeft ===
          else if (data.type === "studentLeft" && data.student && data.room) {
            const { student, room } = data;
            showToast(`–°—Ç—É–¥–µ–Ω—Ç –≤—ã–±—ã–ª: ${student.fio}`, "warning");

            if (!students[room]) students[room] = [];
            const found = students[room].find(s => s.iin === student.iin);
            if (found) {
              found.left = true;
              found.leftDate = student.leftDate || new Date().toISOString().split("T")[0];
            }

            // generateBlocks(); // ‚ùå –£–¥–∞–ª–µ–Ω–æ: –º–µ—à–∞–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç—ã–º —ç—Ç–∞–∂–∞–º
            if (currentRoom === room) openDossierModal(room);
            updateGlobalStats();
          }
          // === –ù–æ–≤—ã–π –±–ª–æ–∫: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è studentDeleted ===
          else if (data.type === "studentDeleted" && data.iin && data.room) {
            const room = normalizeRoomId(data.room);
            if (students[room]) {
              const index = students[room].findIndex(s => s.iin === data.iin);
              if (index !== -1) {
                students[room].splice(index, 1);
                showToast(`–°—Ç—É–¥–µ–Ω—Ç —É–¥–∞–ª—ë–Ω: –ò–ò–ù ${data.iin}`, "info");
                // generateBlocks(); // ‚ùå –£–¥–∞–ª–µ–Ω–æ: –º–µ—à–∞–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç—ã–º —ç—Ç–∞–∂–∞–º
                if (currentRoom === room) openDossierModal(room);
              }
            }
          }
          // === –ù–æ–≤—ã–π –±–ª–æ–∫: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è studentUpdated ===
          else if (data.type === "studentUpdated" && data.student && data.room) {
            const room = normalizeRoomId(data.room);
            if (!students[room]) students[room] = [];
            const index = students[room].findIndex(s => s.iin === data.student.iin);
            if (index !== -1) {
              students[room][index] = { ...students[room][index], ...data.student };
            } else {
              students[room].push(data.student);
            }
            showToast(`–°—Ç—É–¥–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω: ${data.student.fio}`, "info");
            // generateBlocks(); // ‚ùå –£–¥–∞–ª–µ–Ω–æ: –º–µ—à–∞–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç—ã–º —ç—Ç–∞–∂–∞–º
            if (currentRoom === room) openDossierModal(room);
            updateGlobalStats();
          }
          // === –ù–æ–≤—ã–π –±–ª–æ–∫: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è leftStudent ===
          else if (data.type === "leftStudent" && data.student && data.roomId) {
            const roomId = normalizeRoomId(data.roomId);
            // –£–¥–∞–ª—è–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –ø–æ roomId
            if (students[roomId]) {
              students[roomId] = students[roomId].filter(s => s.iin !== data.student.iin);
            }
            // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å UI
            if (document.getElementById("studentModal")?.style.display === "block" && currentRoom === roomId) {
              openRoomModal(roomId); // –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É, –æ–Ω–∞ –ø–µ—Ä–µ—Ä–∏—Å—É–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            }
            showToast(`üö™ –°—Ç—É–¥–µ–Ω—Ç –≤—ã–±—ã–ª: ${data.student?.fio || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"} –∏–∑ –∫–æ–º–Ω–∞—Ç—ã ${data.roomId}`, "warning");
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, updateSingleRoom)
            if (currentRoom === roomId) openDossierModal(roomId);
            updateGlobalStats();
          }

        } catch (e) {
          console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ WebSocket —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
        }
      });

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ—Å–º–æ—Ç—Ä"
      function createViewButton(roomId) {
        const btn = document.createElement("button");
        btn.classList.add("btn");
        btn.textContent = "–ü—Ä–æ—Å–º–æ—Ç—Ä";
        if (btn) {
          btn.addEventListener("click", () => {
            const searchQuery = document.getElementById("searchInput").value.trim().toLowerCase();
            openDossierModal(normalizeRoomId(roomId), null, null, searchQuery);
          });
        }
        return btn;
      }

      // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã (–ø–æ WebSocket) ---
      function updateSingleRoom(roomId, data) {
        console.log("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:", roomId, "‚Üí", data);
        const roomElements = document.querySelectorAll(".room");
        // –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —á—Ç–æ–±—ã .room –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        for (const roomElement of roomElements) {
          const roomNumberEl = roomElement.querySelector(".room-number");
          if (roomNumberEl && normalizeRoomId(roomNumberEl.innerText.trim()) === normalizeRoomId(roomId)) {
            const counter = roomElement.querySelector(".room-counter");
            if (counter) {
              counter.innerText = `${data.occupied}/${data.places}`;
              counter.className = `room-counter room-status ${data.occupied >= data.places ? "occupied" : "free"}`;
              console.log("‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω —Å—á—ë—Ç—á–∏–∫ –∫–æ–º–Ω–∞—Ç—ã", roomId, "‚Üí", counter.innerText);
            } else {
              console.warn("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω .room-counter –≤–Ω—É—Ç—Ä–∏ .room");
            }
            // highlight room if parent ul is visible
            const ul = roomElement.closest("ul.room-list");
            if (ul && ul.style.display !== "none") {
              roomElement.classList.add("highlighted");
              setTimeout(() => roomElement.classList.remove("highlighted"), 2000);
            }
            updateGlobalStats(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ DOM
            return;
          }
        }

        console.warn("‚ö†Ô∏è –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM:", roomId);
      }

      function updateGlobalStats() {
        let globalCapacity = 0;
        let globalOccupied = 0;
        const allStudents = Object.values(students).flat();
        const globalLeft = allStudents.filter(s => s.left).length;

        for (let roomId in students) {
          const roomStudents = students[roomId];
          const activeCount = roomStudents.filter(s => !s.left).length;
          const roomPlaces = roomCapacities[roomId] || 0;
          globalOccupied += activeCount;
          globalCapacity += roomPlaces;
        }

        const globalFree = globalCapacity - globalOccupied;
        const globalStats = document.getElementById("globalStats");
        globalStats.textContent = `–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${globalCapacity} –º–µ—Å—Ç | –ó–∞–Ω—è—Ç–æ: ${globalOccupied} | –°–≤–æ–±–æ–¥–Ω–æ: ${globalFree} | –í—ã–±—ã–≤—à–∏–µ: ${globalLeft}`;
      }

      function openDossierModal(room, filtered = null, highlightIin = null, highlightQuery = null) {
        currentRoom = room;
        console.log("üìÇ –û—Ç–∫—Ä—ã—Ç–æ –¥–æ—Å—å–µ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã:", room);
        const roomStudents = students[room] || [];
        const activeStudents = filtered !== null ? filtered.filter(s => !s.left) : roomStudents.filter(s => !s.left);
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –¥–∞—Ç–µ –∑–∞—Å–µ–ª–µ–Ω–∏—è (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
        activeStudents.sort((a, b) => new Date(b.moveInDate) - new Date(a.moveInDate));
        console.log("üîç –í –º–æ–¥–∞–ª–∫–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç—ã:");
        (activeStudents || []).forEach(s => console.log("  ‚Üí", s.fio));

        state.currentRoom = room;
        const departedStudents = filtered !== null ? filtered.filter(s => s.left) : roomStudents.filter(s => s.left);
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–±—ã–≤—à–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –¥–∞—Ç–µ –∑–∞—Å–µ–ª–µ–Ω–∏—è (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
        departedStudents.sort((a, b) => new Date(b.moveInDate) - new Date(a.moveInDate));
        state.currentFiltered = activeStudents;

        document.getElementById("dossierRoom").textContent = room;
        const dossierContent = document.getElementById("dossierContent");
        dossierContent.innerHTML = "";

        if (activeStudents.length === 0 && departedStudents.length === 0) {
          dossierContent.innerHTML = `<p>–°—Ç—É–¥–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`;
        }

        // –ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç—ã
        if (activeStudents.length > 0) {
          dossierContent.innerHTML += `<h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç—ã</h3>`;
          activeStudents.forEach((student) => {
            let highlight = "";
            if (highlightQuery) {
              const fio = (student.fio || "").toLowerCase();
              const fioParts = fio.split(/\s+/);
              const fioMatch = fioParts.some(part => part.startsWith(highlightQuery));
              const iinMatch = (student.iin || "").includes(highlightQuery);
              if (fioMatch || iinMatch) {
                highlight = 'style="background-color: #cce5ff;"';
              }
            } else if (highlightIin && student.iin === highlightIin) {
              highlight = 'style="background-color: #cce5ff;"';
            }

            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ moveInDate
            const moveInDateObj = student.moveInDate ? new Date(student.moveInDate) : null;
            let moveInDateFormatted = "‚Äî";
            if (moveInDateObj && !isNaN(moveInDateObj)) {
              moveInDateObj.setDate(moveInDateObj.getDate() + 1);
              moveInDateFormatted = moveInDateObj.toISOString().split("T")[0];
            }
            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ moveOutDate
            let moveOutDateFormatted = "‚Äî";
            if (student.leftDate && !isNaN(new Date(student.leftDate))) {
              const temp = new Date(student.leftDate);
              temp.setDate(temp.getDate() + 1);
              moveOutDateFormatted = temp.toISOString().split("T")[0];
            } else if (student.moveInDate && !isNaN(new Date(student.moveInDate))) {
              const temp = addMonths(new Date(student.moveInDate), parseInt(student.rentalPeriod));
              temp.setDate(temp.getDate() + 1);
              moveOutDateFormatted = temp.toISOString().split("T")[0];
            }

            dossierContent.innerHTML += `
              <div class="student-entry" ${highlight}>
                <p><strong>–§–ò–û:</strong> ${student.fio}</p>
                <p><strong>–ò–ò–ù:</strong> ${student.iin}</p>
                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${student.phone}</p>
                <p><strong>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç:</strong> ${student.university}</p>
                <p><strong>–†–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫:</strong> ${student.relative}</p>
                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞:</strong> ${student.relativePhone}</p>
                <p><strong>–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã:</strong> ${Number(student.payment).toLocaleString("ru-RU")} ‚Ç∏</p>
                <p><strong>–î–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è:</strong> ${moveInDateFormatted}</p>
                <p><strong>–°—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã:</strong> ${student.rentalPeriod} –º–µ—Å.</p>
                <p><strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã:</strong> ${moveOutDateFormatted}</p>
                <p><strong>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏:</strong>
                  <span class="card-number-span">${student.cardNumber || "‚Äî"}</span>
                  <button class="btn btn-sm btn-secondary" onclick="editCardNumber('${room}', '${student.iin}')">
                    ${student.cardNumber ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" : "–î–æ–±–∞–≤–∏—Ç—å"}
                  </button>
                </p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –ê–∫—Ç–∏–≤–µ–Ω</p>
                <button class="btn btn-danger" onclick="deleteStudent('${room}', '${student.iin}')">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn" onclick="markStudentLeft('${room}', '${student.iin}')">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–±—ã–≤—à–µ–≥–æ</button>
                <button class="btn btn-warning" onclick="extendRentalPeriod('${room}', '${student.iin}')">–ü—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É</button>
                <button class="btn btn-sm btn-warning" onclick="generateContract('${room}', '${student.iin}')">–î–æ–≥–æ–≤–æ—Ä</button>
                <hr>
              </div>
            `;
          });
        }

        // –í—ã–±—ã–≤—à–∏–µ —Å—Ç—É–¥–µ–Ω—Ç—ã
        if (departedStudents.length > 0) {
          dossierContent.innerHTML += `<h3 style="margin-top: 20px;">–í—ã–±—ã–≤—à–∏–µ —Å—Ç—É–¥–µ–Ω—Ç—ã</h3>`;
          const departedSection = document.createElement("div");
          dossierContent.appendChild(departedSection);
          departedStudents.forEach((student) => {
            // –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç: —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞ = student.payment
            const plannedPayment = parseInt(student.rentalPeriod || "0") * 30 * 1000;
            const actualAmount = student.payment;

            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ moveInDate
            const moveInDateObj = student.moveInDate ? new Date(student.moveInDate) : null;
            let moveInDateFormatted = "‚Äî";
            if (moveInDateObj && !isNaN(moveInDateObj)) {
              moveInDateObj.setDate(moveInDateObj.getDate() + 1);
              moveInDateFormatted = moveInDateObj.toISOString().split("T")[0];
            }
            // –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã (–Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞)
            let moveOutDateFormatted = "‚Äî";
            if (student.moveInDate && !isNaN(new Date(student.moveInDate)) && student.rentalPeriod) {
              const moveIn = new Date(student.moveInDate);
              moveIn.setMonth(moveIn.getMonth() - 1); // –Ω–∞ –º–µ—Å—è—Ü –Ω–∞–∑–∞–¥
              const moveOut = new Date(moveIn);
              moveOut.setMonth(moveOut.getMonth() + parseInt(student.rentalPeriod));
              moveOut.setDate(moveOut.getDate() + 1);
              moveOutDateFormatted = moveOut.toISOString().split("T")[0];
            }
            // –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –≤—ã–±—ã—Ç–∏—è
            let leftDateFormatted = "‚Äî";
            if (student.leftDate && !isNaN(new Date(student.leftDate))) {
              const leftDateObj = new Date(student.leftDate);
              leftDateObj.setDate(leftDateObj.getDate() + 1);
              leftDateFormatted = leftDateObj.toISOString().split("T")[0];
            }

            const studentDiv = document.createElement("div");
            studentDiv.className = "student-entry";
            studentDiv.style.opacity = "0.7";

            // –ù–æ–≤—ã–π –±–ª–æ–∫: –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            if (highlightIin && student.iin === highlightIin) {
              studentDiv.classList.add("highlighted-entry");
              requestAnimationFrame(() => {
                studentDiv.scrollIntoView({ behavior: "smooth", block: "center" });
              });
              setTimeout(() => {
                studentDiv.classList.remove("highlighted-entry");
              }, 2500);
            }

            studentDiv.innerHTML = `
              <p><strong>–§–ò–û:</strong> ${student.fio}</p>
              <p><strong>–ò–ò–ù:</strong> ${student.iin}</p>
              <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${student.phone}</p>
              <p><strong>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç:</strong> ${student.university}</p>
              <p><strong>–ü–ª–∞–Ω–æ–≤–∞—è —Å—É–º–º–∞:</strong> ${plannedPayment.toLocaleString("ru-RU")} ‚Ç∏</p>
              <p><strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞:</strong> ${Number(actualAmount).toLocaleString("ru-RU")} ‚Ç∏</p>
              <p><strong>–î–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è:</strong> ${moveInDateFormatted}</p>
              <p><strong>–°—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã:</strong> ${student.rentalPeriod} –º–µ—Å.</p>
              <p><strong>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã:</strong> ${moveOutDateFormatted}</p>
              <p><strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –≤—ã–±—ã—Ç–∏—è:</strong> ${leftDateFormatted}</p>
              <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –í—ã–±—ã–≤—à–∏–π</p>
              <button class="btn btn-danger" onclick="deleteStudent('${room}', '${student.iin}')">–£–¥–∞–ª–∏—Ç—å</button>
              <hr>
            `;

            departedSection.appendChild(studentDiv);
          });
        }

        // --- SCROLL AND HIGHLIGHT BY IIN ---
        // (–£–¥–∞–ª–µ–Ω–æ: —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ studentDiv)

        state.modals.dossier = true;
        document.getElementById("dossierModal").style.display = "flex";
      }

      // ---- –ù–æ–≤—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É ----
      let extendTarget = { room: null, iin: null };

      function extendRentalPeriod(room, iin) {
        extendTarget = { room, iin };
        document.getElementById("extendRentalHidden").value = "";
        document.getElementById("displayExtendRental").textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫";
        document.getElementById("extendRentalModal").style.display = "flex";
      }

      function closeExtendModal() {
        document.getElementById("extendRentalModal").style.display = "none";
      }

      function confirmExtendRental() {
        const { room, iin } = extendTarget;
        const student = students[room]?.find(s => s.iin === iin);
        if (!student) return;

        const extraMonths = parseInt(document.getElementById("extendRentalHidden").value);
        if (isNaN(extraMonths) || extraMonths <= 0) {
          showToast("–ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ", "error");
          return;
        }

        student.rentalPeriod = String(parseInt(student.rentalPeriod || "0") + extraMonths);

        // –õ–æ–≥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
        console.log("üì§ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–ª–µ–Ω–∏—è:", { room, iin, newPeriod: student.rentalPeriod });

        fetch(`/api/students/update-rental`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ room, iin, rentalPeriod: student.rentalPeriod })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showToast("–°—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã –ø—Ä–æ–¥–ª—ë–Ω", "success");
              closeExtendModal();
              openDossierModal(room); // –û–±–Ω–æ–≤–∏—Ç—å UI
              updateGlobalStats();
            } else {
              showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏", "error");
            }
          })
          .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è:", err);
            showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
          });
      }

      function closeDossierModal() {
        document.getElementById("dossierModal").style.display = "none";
        state.currentRoom = null;
        state.currentFiltered = null;
        state.modals.dossier = false;
      }



      // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ---
      function editStudent(room, iin) {
        state.currentRoom = room;
        const student = (students[room] || []).find(s => s.iin === iin);
        if (!student) return;
        document.getElementById("inputRoom").value = room;
        document.getElementById("addRoomLabel").textContent = room;
        document.getElementById("inputFio").value = student.fio;
        document.getElementById("inputIin").value = student.iin;
        document.getElementById("inputPhone").value = student.phone;
        document.getElementById("inputUniversity").value = student.university;
        document.getElementById("inputRelative").value = student.relative;
        document.getElementById("inputRelativePhone").value = student.relativePhone;
        document.getElementById("inputPayment").value = student.payment;
        document.getElementById("inputMoveInDate").value = student.moveInDate;
        document.getElementById("inputRentalPeriod").value = student.rentalPeriod;
        const form = document.getElementById("addStudentForm");
        form.dataset.editing = iin;
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
        document.getElementById("addStudentModal").style.display = "flex";
      }

      function deleteStudent(room, iin) {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å –ò–ò–ù ${iin} –∏–∑ –∫–æ–º–Ω–∞—Ç—ã ${room}?`)) {
          // --- –î–û–ë–ê–í–õ–ï–ù–û: —É–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –§–ò–û ---
          const student = students[room]?.find((s) => s.iin === iin);
          const fullName = student?.fio?.trim() || (
            `${student?.lastName || ""} ${student?.firstName || ""} ${student?.middleName || ""}`.trim()
          );
          console.log("üìÇ –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è:", fullName);
          if (fullName) {
            fetch("/api/upload/delete-folder", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ fullName })
            }).then(res => {
              if (!res.ok) {
                console.warn("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è:", fullName);
              }
            });
          }
          fetch(`/api/students/delete/${encodeURIComponent(iin)}`, {
            method: "DELETE"
          })
          .then(res => {
            if (res.ok) {
              showToast("–°—Ç—É–¥–µ–Ω—Ç —É–¥–∞–ª–µ–Ω!", "info");
              if (students[room]) {
                const index = students[room].findIndex((s) => s.iin === iin);
                if (index !== -1) {
                  students[room].splice(index, 1);
                }
              }
              generateBlocks();
              const searchQuery = document.getElementById("searchInput").value.trim().toLowerCase();
              if (searchQuery) {
                const filtered = (students[room] || []).filter(
                  (s) =>
                    s.fio.toLowerCase().includes(searchQuery) ||
                    s.iin.toLowerCase().includes(searchQuery)
                );
                openDossierModal(room, filtered);
              } else {
                openDossierModal(room);
              }
            } else {
              showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞", "error");
            }
          })
          .catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞:", err);
            showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞", "error");
          });
        }
      }

      function markStudentLeft(room, iin) {
        if (students[room]) {
          const student = students[room].find((s) => s.iin === iin);
          if (student && !student.left) {
            const confirmLeave = confirm(`–û—Ç–º–µ—Ç–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å –ò–ò–ù ${iin} –∫–∞–∫ –≤—ã–±—ã–≤—à–µ–≥–æ?`);
            if (!confirmLeave) return;

            const now = new Date();
            const moveIn = new Date(student.moveInDate);
            const endDate = new Date(now);
            moveIn.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);

            const originalPayment = Number(student.payment || 0);
            let totalCalculated = 0;

            let current = new Date(moveIn);
            while (current <= endDate) {
              const y = current.getFullYear();
              const m = current.getMonth();
              const daysInMonth = new Date(y, m + 1, 0).getDate();

              const startDay = (y === moveIn.getFullYear() && m === moveIn.getMonth()) ? moveIn.getDate() : 1;
              const endDay = (y === endDate.getFullYear() && m === endDate.getMonth()) ? endDate.getDate() : daysInMonth;

              const livedDays = endDay - startDay + 1;
              const perDay = 30000 / daysInMonth;
              totalCalculated += perDay * livedDays;

              current = new Date(y, m + 1, 1);
            }

            const actualAmount = Math.round(totalCalculated);
            const refundSuggested = Math.max(0, originalPayment - actualAmount);

            const refundStr = prompt(
              `–ü—Ä–æ–∂–∏—Ç–æ —Å ${moveIn.toLocaleDateString("ru-RU")} –ø–æ ${endDate.toLocaleDateString("ru-RU")}\n` +
              `–ü—Ä–æ–∂–∏—Ç—ã–µ –¥–Ω–∏: ${Math.ceil((endDate - moveIn) / (1000 * 60 * 60 * 24)) + 1} –¥–Ω–µ–π\n` +
              `–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã: ${originalPayment.toLocaleString("ru-RU")} ‚Ç∏\n` +
              `–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞: ${actualAmount.toLocaleString("ru-RU")} ‚Ç∏\n` +
              `–°—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞: ${refundSuggested.toLocaleString("ru-RU")} ‚Ç∏\n\n` +
              `–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤–æ–∑–≤—Ä–∞—Ç–∞ (–≤ ‚Ç∏):`,
              refundSuggested
            );
            if (refundStr === null) return;

            const refund = parseInt(refundStr);
            if (isNaN(refund) || refund < 0) {
              showToast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞", "error");
              return;
            }

            const adjustedPayment = Math.max(0, originalPayment - refund);

            console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ WebSocket markAsLeft:", { room, iin, adjustedPayment });

            socket.send(JSON.stringify({
              type: "markAsLeft",
              iin,
              room,
              payment: adjustedPayment
            }));

            showToast(`–°—Ç—É–¥–µ–Ω—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –≤—ã–±—ã–≤—à–∏–π. –°—É–º–º–∞ –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞: ${adjustedPayment.toLocaleString("ru-RU")} ‚Ç∏`, "info");
          }
        }
      }

      // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–æ–¥–∞–ª–∫–∞—Ö)
      function renderStudentCard({ full_name, iin, room, rent_end, student, color = "#777", label = "", onClick = null }) {
        const div = document.createElement("div");
        div.style.marginBottom = "12px";
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div><strong>${full_name}</strong></div>
              <div style="font-size: 13px; color: #555;">–ò–ò–ù: ${iin}</div>
              <div style="font-size: 13px; color: ${color};">–ö–æ–º–Ω–∞—Ç–∞: ${room || "‚Äî"}</div>
              ${label ? `<div style="font-size: 13px; color: ${color};">${label}</div>` : ""}
            </div>
            <div style="text-align: right;">
              <button class="btn btn-sm btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
            </div>
          </div>
        `;
        const btn = div.querySelector("button");
        if (onClick) {
          btn.addEventListener("click", onClick);
        }
        return div;
      }

      function openDepartedModal() {
        state.modals.departed = true;
        const modal = document.getElementById("departedModal");
        const content = document.getElementById("departedContent");
        content.innerHTML = "";

        const today = new Date();
        const departedStudents = [];

        for (let room in students) {
          students[room].forEach((s) => {
            if (s.left) {
              departedStudents.unshift({ room, student: s });
            }
          });
        }

        const count = departedStudents.length;
        const countLine = document.createElement("p");
        countLine.innerHTML = `<strong>–í—Å–µ–≥–æ –≤—ã–±—ã–≤—à–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</strong> ${count}`;
        content.appendChild(countLine);

        if (count === 0) {
          content.innerHTML += `<p>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</p>`;
        } else {
          departedStudents.forEach(({ room, student }) => {
            const div = document.createElement("div");
            div.style.marginBottom = "12px";
            div.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div><strong>${student.fio}</strong></div>
                  <div style="font-size: 13px; color: #555;">–ò–ò–ù: ${student.iin}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 13px; color: #777;">${room}</div>
                  <button class="btn btn-sm btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                </div>
              </div>
            `;
            const btn = div.querySelector("button");
            btn.addEventListener("click", () => {
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—å–µ –ø–æ –∫–æ–º–Ω–∞—Ç–µ, –Ω–æ –≤—ã–¥–µ–ª—è–µ–º –Ω—É–∂–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
              modal.style.display = "none";
              setTimeout(() => {
                openDossierModal(room, null, student.iin);
              }, 100);
            });
            content.appendChild(div);
          });
        }

        modal.style.display = "flex";
      }

      function closeDepartedModal() {
        document.getElementById("departedModal").style.display = "none";
        state.modals.departed = false;
      }

      function normalizeDate(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        return d;
      }


      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã
      function getDaysLeft(dateStr) {
        const expire = new Date(dateStr);
        const today = new Date();
        expire.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        return Math.round((expire - today) / (1000 * 60 * 60 * 24));
      }

      // --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –∫–æ–º–Ω–∞—Ç—ã –ø–æ —Å—Ç—É–¥–µ–Ω—Ç—É –∏ allRooms ---
      function getStudentRoomName(student, allRooms) {
        if (!student || (!student.room_id && !student.room_number)) return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        if (student.room_number) return student.room_number;

        const room = allRooms.find(r => r.room_id === student.room_id || r.id === student.room_id);
        return room ? (room.room_number || room.id || room.room_id) : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
      }

      // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –º–æ–¥–∞–ª–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∫–∞–∫ –≤ "–ê—Ä—Ö–∏–≤–µ –≤—ã–±—ã–≤—à–∏—Ö"
      function openNotificationsModal() {
        state.modals.notifications = true;
        const modal = document.getElementById('notificationsModal');
        const expiredContent = document.getElementById('expiredContent');
        const expiringContent = document.getElementById('expiringContent');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const in7Days = new Date(today);
        in7Days.setDate(today.getDate() + 7);

        expiredContent.innerHTML = '';
        expiringContent.innerHTML = '';
        const noCardContent = document.getElementById('noCardContent');
        if (noCardContent) noCardContent.innerHTML = '';

        const expired = [];
        const expiring = [];

        // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç—É –∫–æ–º–Ω–∞—Ç –ø–æ id –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
        const roomMap = {};
        if (typeof allRooms !== "undefined" && Array.isArray(allRooms)) {
          allRooms.forEach(room => {
            roomMap[normalizeRoomId(room.id)] = room;
          });
        }

        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (–ø–æ –≤—Å–µ–º –∫–æ–º–Ω–∞—Ç–∞–º)
        Object.entries(students).forEach(([roomId, arr]) => {
          arr.forEach(student => {
            // --- –ù–∞–¥—ë–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã ---
            let rent_end = null;
            const parsedDate = new Date(student.moveInDate);
            if (!isNaN(parsedDate) && student.rentalPeriod) {
              rent_end = addMonths(parsedDate, parseInt(student.rentalPeriod));
              rent_end.setDate(rent_end.getDate() + 1);
              rent_end.setHours(0, 0, 0, 0);
            }
            if (!rent_end || isNaN(rent_end)) return;
            // --- –ù–∞–¥—ë–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ left ---
            const hasLeft = !!student.left;
            // –ö–æ–º–Ω–∞—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            let roomName = "";
            let roomObj = roomMap[normalizeRoomId(roomId)];
            if (roomObj) {
              roomName = roomObj.name || roomObj.room_number || roomObj.id || "";
            }
            if (!roomName) {
              roomName = student.room_number || student.room_name || student.room_id || roomId || "";
            }
            // –§–ò–û, –ò–ò–ù
            const fio = student.fio || student.full_name || "";
            const iin = student.iin || "";
            // –î–ª—è –≤—ã–≤–æ–¥–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è (–∫–∞–∫ –≤ –º–æ–¥–∞–ª–∫–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)
            const rent_end_str = (() => {
              if (hasLeft && student.leftDate && !isNaN(new Date(student.leftDate))) {
                const leftDateObj = new Date(student.leftDate);
                leftDateObj.setDate(leftDateObj.getDate() + 1);
                return leftDateObj.toISOString().split("T")[0];
              } else if (student.moveInDate && !isNaN(new Date(student.moveInDate)) && student.rentalPeriod) {
                const moveIn = new Date(student.moveInDate);
                const end = addMonths(moveIn, parseInt(student.rentalPeriod));
                end.setDate(end.getDate() + 1);
                return end.toISOString().split("T")[0];
              }
              return "‚Äî";
            })();
            // –ò—Å—Ç—ë–∫—à–∏–µ (–≤—ã–±—ã–≤—à–∏–µ)
            if (hasLeft) {
              expired.push({
                room: roomName,
                roomId: roomId,
                full_name: fio,
                iin: iin,
                rent_end: rent_end_str,
                student: student
              });
            }
            // –ò—Å—Ç–µ–∫–∞—é—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π (–Ω–µ –≤—ã–±—ã–≤—à–∏–µ)
            else if (rent_end >= today && rent_end <= in7Days) {
              expiring.push({
                room: roomName,
                roomId: roomId,
                full_name: fio,
                iin: iin,
                rent_end: rent_end_str,
                student: student
              });
            }
          });
        });

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ rent_end –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é (—Å—Ç–∞—Ä—ã–µ –≤—ã—à–µ)
        expired.sort((a, b) => new Date(a.rent_end) - new Date(b.rent_end));
        expiring.sort((a, b) => new Date(a.rent_end) - new Date(b.rent_end));

        // --- –°–µ–∫—Ü–∏—è "–ò—Å—Ç–µ–∫–ª–∏"
        if (expired.length > 0) {
          const countLine = document.createElement("p");
          countLine.innerHTML = `<strong>–°—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç—ë–∫—à–∏–º —Å—Ä–æ–∫–æ–º –∞—Ä–µ–Ω–¥—ã:</strong> ${expired.length}`;
          expiredContent.appendChild(countLine);
          expired.forEach(({ room, roomId, full_name, iin, rent_end, student }) => {
            const card = renderStudentCard({
              full_name,
              iin,
              room,
              rent_end,
              student,
              color: "#c00",
              label: `–û–∫–æ–Ω—á–∞–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã: ${rent_end}`,
              onClick: () => {
                modal.style.display = "none";
                setTimeout(() => {
                  openDossierModal(roomId, null, iin);
                }, 100);
              }
            });
            expiredContent.appendChild(card);
          });
        } else {
          expiredContent.innerHTML = '<p>–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç—ë–∫—à–∏–º —Å—Ä–æ–∫–æ–º –∞—Ä–µ–Ω–¥—ã.</p>';
        }

        // --- –°–µ–∫—Ü–∏—è "–ò—Å—Ç–µ–∫–∞—é—Ç"
        if (expiring.length > 0) {
          const countLine = document.createElement("p");
          countLine.innerHTML = `<strong>–°—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º –∞—Ä–µ–Ω–¥—ã:</strong> ${expiring.length}`;
          expiringContent.appendChild(countLine);
          expiring.forEach(({ room, roomId, full_name, iin, rent_end, student }) => {
            const card = renderStudentCard({
              full_name,
              iin,
              room,
              rent_end,
              student,
              color: "#b97a00",
              label: `–û–∫–æ–Ω—á–∞–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã: ${rent_end}`,
              onClick: () => {
                modal.style.display = "none";
                setTimeout(() => {
                  openDossierModal(roomId, null, iin);
                }, 100);
              }
            });
            expiringContent.appendChild(card);
          });
        } else {
          expiringContent.innerHTML = '<p>–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º –∞—Ä–µ–Ω–¥—ã.</p>';
        }


        // --- –°–µ–∫—Ü–∏—è "–ë–µ–∑ –∫–∞—Ä—Ç–æ—á–∫–∏" ---
        const noCardStudents = [];
        Object.entries(students).forEach(([roomId, arr]) => {
          arr.forEach(student => {
            if (!student.left && (!student.cardNumber || student.cardNumber === "‚Äî")) {
              noCardStudents.push({
                room: roomId,
                full_name: student.fio || "",
                iin: student.iin || "",
                student
              });
            }
          });
        });
        if (noCardContent) {
          noCardContent.innerHTML = '';
          if (noCardStudents.length > 0) {
            const countLine = document.createElement("p");
            countLine.innerHTML = `<strong>–°—Ç—É–¥–µ–Ω—Ç–æ–≤ –±–µ–∑ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏:</strong> ${noCardStudents.length}`;
            noCardContent.appendChild(countLine);
            noCardStudents.forEach(({ room, full_name, iin, student }) => {
              const card = renderStudentCard({
                full_name,
                iin,
                room,
                student,
                color: "#999",
                label: `–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏: ‚Äî`,
                onClick: () => {
                  document.getElementById('notificationsModal').style.display = 'none';
                  setTimeout(() => openDossierModal(room, null, iin), 100);
                }
              });
              noCardContent.appendChild(card);
            });
          } else {
            noCardContent.innerHTML = '<p>–í—Å–µ —Å—Ç—É–¥–µ–Ω—Ç—ã –∏–º–µ—é—Ç –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏.</p>';
          }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ —Ç–∞–±–æ–≤
        modal.style.display = 'flex';
        // –¢–∞–±—ã
        const expiredTab = document.getElementById("expiredTab");
        const expiringTab = document.getElementById("expiringTab");
        const cardTab = document.getElementById("cardTab");
        const noCardTab = document.getElementById("noCardTab");
        expiredTab.classList.add("active");
        expiringTab.classList.remove("active");
        if (noCardTab) noCardTab.classList.remove("active");
        expiredContent.style.display = "block";
        expiringContent.style.display = "none";
        if (noCardContent) noCardContent.style.display = "none";
        expiredTab.onclick = () => {
          expiredTab.classList.add("active");
          expiringTab.classList.remove("active");
          if (noCardTab) noCardTab.classList.remove("active");
          expiredContent.style.display = "block";
          expiringContent.style.display = "none";
          if (noCardContent) noCardContent.style.display = "none";
        };
        expiringTab.onclick = () => {
          expiredTab.classList.remove("active");
          expiringTab.classList.add("active");
          if (noCardTab) noCardTab.classList.remove("active");
          expiredContent.style.display = "none";
          expiringContent.style.display = "block";
          if (noCardContent) noCardContent.style.display = "none";
        };
        if (noCardTab) {
          noCardTab.onclick = () => {
            expiredTab.classList.remove("active");
            expiringTab.classList.remove("active");
            noCardTab.classList.add("active");
            expiredContent.style.display = "none";
            expiringContent.style.display = "none";
            if (noCardContent) noCardContent.style.display = "block";
          };
        }
      }

      function closeNotificationsModal() {
        document.getElementById("notificationsModal").style.display = "none";
        state.modals.notifications = false;
      }

      function openTodayAddedModal() {
        state.modals.todayAdded = true;
        console.log("üìÖ DEBUG: –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ students –æ–±—ä–µ–∫—Ç–∞", students);
        const modal = document.getElementById("todayAddedModal");
        const content = document.getElementById("todayAddedContent");
        content.innerHTML = ""; // –æ—á–∏—Å—Ç–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

        // –ù–æ–≤—ã–π —Ü–∏–∫–ª —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–∞—Ç –±–µ–∑ —É—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω—ã
        let today = new Date();
        const todayStr = today.toISOString().split("T")[0];
        
        let addedTodayCount = 0;
        let todayStudents = [];
        for (let room in students) {
          students[room].forEach(s => {
            if (!s.left && s.moveInDate) {
              const moveIn = new Date(s.moveInDate);
              moveIn.setDate(moveIn.getDate() + 1);
              if (!isNaN(moveIn)) {
                const moveInDateStr = moveIn.toISOString().split("T")[0];
                if (moveInDateStr === todayStr) {
                  addedTodayCount++;
                  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –Ω–∞—á–∞–ª–æ, —á—Ç–æ–±—ã –ø–æ—Ä—è–¥–æ–∫ –±—ã–ª –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫ –ø–µ—Ä–≤–æ–º—É
                  todayStudents.unshift({ fio: s.fio, room, iin: s.iin, date_added: s.date_added });
                }
              } else {
                console.warn("‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω —Å—Ç—É–¥–µ–Ω—Ç —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –¥–∞—Ç–æ–π:", s.fio, "‚Üí", s.moveInDate);
              }
            }
          });
        }
        // –£–¥–∞–ª—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É ‚Äî –ø–æ—Ä—è–¥–æ–∫ —É–∂–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é (–Ω–æ–≤—ã–µ –≤ –Ω–∞—á–∞–ª–µ)
        // todayStudents.sort(...);
        console.log("–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è:", addedTodayCount);

        if (todayStudents.length === 0) {
          const countLine = document.createElement("p");
          countLine.innerHTML = `<strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è:</strong> 0`;
          content.appendChild(countLine);
          content.innerHTML += `<p>–°–µ–≥–æ–¥–Ω—è –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞—Å–µ–ª–∏–ª—Å—è.</p>`;
        } else {
          const countLine = document.createElement("p");
          countLine.innerHTML = `<strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è:</strong> ${addedTodayCount}`;
          content.appendChild(countLine);

          todayStudents.forEach(({ fio, room, iin }) => {
            const div = document.createElement("div");
            div.style.marginBottom = "12px";
            div.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div><strong>${fio}</strong></div>
                  <div style="font-size: 13px; color: #555;">–ò–ò–ù: ${iin}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 13px; color: #777;">${room}</div>
                  <button class="btn btn-sm btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                  <button class="btn btn-sm btn-warning" style="margin-left: 5px;" onclick="generateContract('${room}', '${iin}')">–î–æ–≥–æ–≤–æ—Ä</button>
                </div>
              </div>
            `;
            const btn = div.querySelector("button.btn-primary");
            btn.addEventListener("click", () => {
              const modal = document.getElementById("todayAddedModal");
              modal.style.display = "none";
              setTimeout(() => {
                openDossierModal(room, null, iin);
              }, 100);
            });
            content.appendChild(div);
          });
        }
        modal.style.display = "flex";
      }

      // --- –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ ---
      function generateContract(room, iin) {
        fetch(`/contracts/${encodeURIComponent(iin)}`)
          .then(response => {
            if (response.ok) {
              return response.blob();
            } else {
              throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
            }
          })
          .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `–î–æ–≥–æ–≤–æ—Ä ${iin}.docx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            showToast("üìÑ –î–æ–≥–æ–≤–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω", "success");
          })
          .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–≥–æ–≤–æ—Ä–∞:", err);
            showToast("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä", "error");
          });
      }

      function closeTodayAddedModal() {
        document.getElementById("todayAddedModal").style.display = "none";
        state.modals.todayAdded = false;
      }

      document
        .getElementById("closeDossierModal")
        .addEventListener("click", closeDossierModal);
      document
        .getElementById("closeDepartedModal")
        .addEventListener("click", closeDepartedModal);
      document
        .getElementById("closeNotificationsModal")
        .addEventListener("click", closeNotificationsModal);
      document
        .getElementById("closeTodayAddedModal")
        .addEventListener("click", closeTodayAddedModal);

      window.addEventListener("click", (event) => {
        const dossierModal = document.getElementById("dossierModal");
        const departedModal = document.getElementById("departedModal");
        const notificationsModal =
          document.getElementById("notificationsModal");
        const todayAddedModal = document.getElementById("todayAddedModal");
        const accountingModal = document.getElementById("accountingModal");
        if (event.target === dossierModal) closeDossierModal();
        if (event.target === departedModal) closeDepartedModal();
        if (event.target === notificationsModal) closeNotificationsModal();
        if (event.target === todayAddedModal) closeTodayAddedModal();
        if (event.target === accountingModal) closeAccountingModal();
      });
function openAccountingModal() {
  const monthlyData = {};
  const modal = document.getElementById("accountingModal");
  const details = document.getElementById("accountingContentDetails");
  const monthly = document.getElementById("accountingContentMonthly");
  const income = document.getElementById("accountingContentIncome");
  details.innerHTML = "";
  monthly.innerHTML = "";
  income.innerHTML = "";

  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤, –¥–æ–±–∞–≤–ª—è—è room, —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å –≤–∞–ª–∏–¥–Ω–æ–π –¥–∞—Ç–æ–π
  const allStudents = Object.entries(students)
    .flatMap(([room, arr]) => arr.map(s => ({ ...s, room })))
    .filter(s => s.moveInDate && !isNaN(new Date(s.moveInDate))) // —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å –≤–∞–ª–∏–¥–Ω–æ–π –¥–∞—Ç–æ–π
    .sort((a, b) => {
      const dateA = new Date(a.moveInDate);
      const dateB = new Date(b.moveInDate);
      return dateB - dateA; // –Ω–æ–≤—ã–µ –≤—ã—à–µ
    });

  // === –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –≤—ã–±—ã–≤—à–∏—Ö ===
  const activeCount = allStudents.filter(s => !s.left).length;
  const leftCount = allStudents.filter(s => s.left).length;

  const totalStudentsLine = document.createElement("p");
  totalStudentsLine.innerHTML = `
    <strong>–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</strong> ${allStudents.length} 
    | <strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö:</strong> ${activeCount}
    | <strong>–í—ã–±—ã–≤—à–∏—Ö:</strong> ${leftCount}
  `;
  details.appendChild(totalStudentsLine);

  // === –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –æ–±—â–µ–π —Å—É–º–º–æ–π –ø–æ –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º ===
  const totalAmount = allStudents.reduce((sum, s) => {
    if (s.left && s.leftDate) {
      return sum + Number(s.payment || 0);
    } else {
      return sum + (Number(s.rentalPeriod || 0) * 30000);
    }
  }, 0);
  const totalAmountLine = document.createElement("p");
  totalAmountLine.innerHTML = `<strong>–û–±—â–∞—è —Å—É–º–º–∞:</strong> ${totalAmount.toLocaleString("ru-RU")} ‚Ç∏`;
  details.appendChild(totalAmountLine);

  allStudents.forEach(student => {
    if (!student.moveInDate) return;

    const fio = student.fio || '-';
    let amount = 0;
    if (student.left && student.leftDate) {
      amount = student.payment;
    } else {
      amount = student.rentalPeriod * 30000;
    }
    const div = document.createElement("div");
    const statusLabel = student.left ? " (–≤—ã–±—ã–ª)" : "";
    div.innerHTML = `<strong>${fio}</strong> ‚Äî ${Number(amount).toLocaleString("ru-RU")} ‚Ç∏${statusLabel}`;
    details.appendChild(div);
  });

  // === –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º (–¢–û–ß–ù–ê–Ø –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ calculateMonthlyBreakdown) ===
  // –ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç paymentsByMonth: —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, —Ç–æ—á–Ω—É—é —Å—É–º–º—É –ø–æ –¥–Ω—è–º –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
  const paymentsByMonth = {};
  for (const room in students) {
    for (const student of students[room]) {
      const breakdown = calculateMonthlyBreakdown(student);
      for (const key in breakdown) {
        if (!paymentsByMonth[key]) {
          paymentsByMonth[key] = {
            amount: 0,
            count: 0,
          };
        }
        paymentsByMonth[key].amount += breakdown[key];
        paymentsByMonth[key].count += 1;
      }
    }
  }

  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º: –ø–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ –∫–ª—é—á–µ–π –ø–æ –≥–æ–¥–∞–º –∏ –º–µ—Å—è—Ü–∞–º (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
  const sortedKeys = Object.keys(paymentsByMonth).sort((a, b) => {
    const [y1, m1] = a.split("-").map(Number);
    const [y2, m2] = b.split("-").map(Number);
    return y2 !== y1 ? y2 - y1 : m2 - m1;
  });

  // === –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –º–µ—Å—è—Ü–µ–≤ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –ª–µ—Ç ===
  const incomeData = {};
  allStudents.forEach(student => {
    if (!student.moveInDate || !student.rentalPeriod || !student.payment) return;

    const start = new Date(student.moveInDate);
    const rentalPeriod = parseInt(student.rentalPeriod);
    const payment = Number(student.payment);
    if (!rentalPeriod || isNaN(payment)) return;

    // –í—Å—è —Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã —Ç–µ–ø–µ—Ä—å –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –º–µ—Å—è—Ü –∑–∞—Å–µ–ª–µ–Ω–∏—è (–≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É)
    const key = `${start.getFullYear()}-${start.getMonth()}`;
    if (!incomeData[key]) incomeData[key] = 0;
    incomeData[key] += payment;
  });

  // –°–æ–±—Ä–∞—Ç—å –≤—Å–µ –≥–æ–¥–∞ –∏–∑ monthlyData –∏ incomeData
  const allKeys = [...Object.keys(monthlyData), ...Object.keys(incomeData)];
  const years = Array.from(new Set(allKeys.map(key => parseInt(key.split("-")[0])))).sort((a, b) => b - a);
  const monthRange = [];
  years.forEach(y => {
    for (let m = 11; m >= 0; m--) {
      monthRange.push(`${y}-${m}`);
    }
  });

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –º–µ—Å—è—Ü—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
  sortedKeys.forEach(key => {
    const [year, month] = key.split("-");
    const monthName = new Date(year, month).toLocaleString("ru-RU", { month: "long" });
    const sum = paymentsByMonth[key]?.amount || 0;
    const count = paymentsByMonth[key]?.count || 0;
    const div = document.createElement("div");
    div.innerHTML = `<strong>${year}: ${monthName}</strong> ‚Äî ${Number(sum).toLocaleString("ru-RU")} ‚Ç∏ <span style="color: #777;">(${count} —Å—Ç—É–¥–µ–Ω—Ç${count === 1 ? "" : "–∞"})</span>`;
    monthly.appendChild(div);
  });

  // === –†–∞—Å—á—ë—Ç —Å–µ–∫—Ü–∏–∏ "–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è" ===
  income.innerHTML = "";
  monthRange.forEach(key => {
    const [year, month] = key.split("-");
    const monthName = new Date(year, month).toLocaleString("ru-RU", { month: "long" });
    const sum = incomeData[key] || 0;
    const div = document.createElement("div");
    div.style.padding = "6px 0";
    div.style.borderBottom = "1px dashed #ddd";
    div.innerHTML = `<strong>${year}: ${monthName}</strong> ‚Äî ${Number(sum).toLocaleString("ru-RU")} ‚Ç∏`;
    income.appendChild(div);
  });

  // tabs
  const tab1 = document.getElementById("accountingTabDetails");
  const tab2 = document.getElementById("accountingTabMonthly");
  const tab3 = document.getElementById("accountingTabIncome");
  tab1.classList.add("active");
  tab2.classList.remove("active");
  tab3.classList.remove("active");
  details.style.display = "block";
  monthly.style.display = "none";
  income.style.display = "none";
  tab1.onclick = () => {
    tab1.classList.add("active");
    tab2.classList.remove("active");
    tab3.classList.remove("active");
    details.style.display = "block";
    monthly.style.display = "none";
    income.style.display = "none";
  };
  tab2.onclick = () => {
    tab1.classList.remove("active");
    tab2.classList.add("active");
    tab3.classList.remove("active");
    details.style.display = "none";
    monthly.style.display = "block";
    income.style.display = "none";
  };
  tab3.onclick = () => {
    tab1.classList.remove("active");
    tab2.classList.remove("active");
    tab3.classList.add("active");
    details.style.display = "none";
    monthly.style.display = "none";
    income.style.display = "block";
  };

  modal.style.display = "flex";
}

function closeAccountingModal() {
  document.getElementById("accountingModal").style.display = "none";
}

document.getElementById("accountingBtn").addEventListener("click", openAccountingModal);
document.getElementById("closeAccountingModal").addEventListener("click", closeAccountingModal);

      // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: createRoomStatusHTML ---
      function createRoomStatusHTML({ id, occupied, places }) {
        return `<span class="room-number">${id}</span>
          <span class="room-counter room-status ${occupied >= places ? "occupied" : "free"}">${occupied}/${places}</span>`;
      }

      // --- –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è updateBlockStats ---
      function updateBlockStats(blockDiv) {
        if (!blockDiv) return;
        const statsEl = blockDiv.querySelector(".block-stats");
        if (!statsEl) return;

        const ulElements = blockDiv.querySelectorAll("ul.room-list");
        let blockCapacity = 0;
        let blockOccupied = 0;
        let blockLeft = 0;

        ulElements.forEach(ul => {
          try {
            const rooms = JSON.parse(ul.dataset.rooms || "[]");
            rooms.forEach(({ room, capacity }) => {
              const roomStudents = students[room] || [];
              const activeCount = roomStudents.filter(s => !s.left).length;
              const leftCount = roomStudents.filter(s => s.left).length;
              blockOccupied += activeCount;
              blockLeft += leftCount;
              blockCapacity += capacity || 0;
            });
          } catch (e) {
            console.warn("‚ùå –û—à–∏–±–∫–∞ –≤ updateBlockStats:", e);
          }
        });

        const blockFree = blockCapacity - blockOccupied;
        statsEl.innerHTML = `–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${blockCapacity} –º–µ—Å—Ç | –ó–∞–Ω—è—Ç–æ: ${blockOccupied} | –°–≤–æ–±–æ–¥–Ω–æ: ${blockFree} | –í—ã–±—ã–≤—à–∏–µ: ${blockLeft}`;
      }

      // –£–¥–∞–ª—ë–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –±–ª–æ–∫ setupExtendRentalSelect –≤–Ω–µ DOMContentLoaded

      // --- –ù–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –ø–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º –∏ –∫–æ–º–Ω–∞—Ç–∞–º —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –∏ —Å—á—ë—Ç—á–∏–∫–æ–º ---
      const searchInput = document.getElementById("searchInput");
      const resultCount = document.getElementById("resultCount");

      function handleSearchInput() {
        // –ù–∞—Å–∏–ª—å–Ω–æ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã
        document.querySelectorAll("ul.room-list").forEach(ul => {
          if (ul.dataset.loaded !== "true") {
            lazyLoadRooms(ul);
          }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –¥–æ–∂–¥–∞—Ç—å—Å—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        setTimeout(() => {
          const normalize = str => str.replace(/\s+/g, "").toLowerCase();
          const query = normalize(searchInput.value);
          state.searchQuery = query;
          let foundCount = 0;

          // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
          document.querySelectorAll(".highlighted-room").forEach(room => {
            room.classList.remove("highlighted-room");
          });
          document.querySelectorAll(".highlighted").forEach(room => {
            room.classList.remove("highlighted");
          });

          if (!query) {
            resultCount.textContent = "";
            document.querySelectorAll(".highlighted-room").forEach(room => room.classList.remove("highlighted-room"));
            document.querySelectorAll(".highlighted").forEach(room => room.classList.remove("highlighted"));
            document.querySelectorAll('ul.room-list[data-opened-by-search="true"]').forEach(ul => {
              ul.style.display = "none";
              delete ul.dataset.openedBySearch;
            });
            return;
          }

          const matchingRoomIds = new Set();

          document.querySelectorAll(".room").forEach(roomEl => {
            const roomNumEl = roomEl.querySelector(".room-number");
            if (!roomNumEl) return;
            const roomId = normalizeRoomId(roomNumEl.textContent.trim());
            const roomStudents = students[roomId] || [];
            let matchedInRoom = 0;
            for (const student of roomStudents) {
              if (!student.left) {
                const fioParts = normalize(student.fio || "").split(/[\s]+/);
                const iinPart = normalize(student.iin);
                const match =
                  fioParts.some(part => part.includes(query)) ||
                  iinPart.includes(query);
                if (match) {
                  matchedInRoom++;
                  matchingRoomIds.add(roomId);
                }
              }
            }
            if (matchedInRoom > 0) {
              foundCount += matchedInRoom;
              roomEl.classList.add("highlighted-room");
              const ul = roomEl.closest("ul.room-list");
              if (ul && ul.style.display === "none") {
                ul.style.display = "block";
                ul.dataset.openedBySearch = "true";
              }
            } else {
              roomEl.classList.remove("highlighted-room");
            }
          });

          const ulElements = document.querySelectorAll("ul[data-block][data-floor]");
          ulElements.forEach(ul => {
            const roomList = JSON.parse(ul.dataset.rooms || "[]");
            const shouldOpen = roomList.some(r => matchingRoomIds.has(r.room));
            if (shouldOpen) {
              ul.style.display = "block";
            }
            roomList.forEach(r => {
              if (matchingRoomIds.has(r.room)) {
                const roomDiv = document.getElementById(r.room);
                if (roomDiv) {
                  roomDiv.classList.add("highlighted");
                  roomDiv.scrollIntoView({ behavior: "smooth", block: "center" });
                  setTimeout(() => roomDiv.classList.remove("highlighted"), 1500);
                }
              }
            });
          });

          resultCount.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${foundCount}`;
          console.log("üîé –ù–∞–π–¥–µ–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:", foundCount);
        }, 100); // 100 –º—Å –∑–∞–¥–µ—Ä–∂–∫–∞
      }

      searchInput.addEventListener("input", handleSearchInput);
      document
        .getElementById("archiveBtn")
        .addEventListener("click", openDepartedModal);
      document
        .getElementById("notificationsBtn")
        .addEventListener("click", openNotificationsModal);
      document
        .getElementById("todayAddedBtn")
        .addEventListener("click", openTodayAddedModal);

      // --- –ò—â–µ–º –∏ –∑–∞–º–µ–Ω—è–µ–º –≤—ã–∑–æ–≤—ã openNotificationsModal(event) –∏–ª–∏ openNotificationsModal() –Ω–∞ openNotificationsModal(students) ---
      // –ó–∞–º–µ–Ω—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤—ã–∑–æ–≤—ã openNotificationsModal(event) –∏–ª–∏ openNotificationsModal() –Ω–∞ openNotificationsModal(Object.values(students).flat())
      // (–µ—Å–ª–∏ —Ç–∞–∫–∏–µ –≤—ã–∑–æ–≤—ã –µ—Å—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö, –∫—Ä–æ–º–µ addEventListener)
      // –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ —Ç–æ–ª—å–∫–æ addEventListener("click", openNotificationsModal) –±—ã–ª, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã.
      function showError(el, message) {
        removeError(el);
        el.classList.remove("valid");
        el.style.border = "2px solid red";
        el.setAttribute("data-tooltip", message);
        el.classList.add("tooltip");

        const error = document.createElement("div");
        error.className = "field-error";
        error.textContent = message;

        const label = el.closest("label");
        if (label) {
          label.insertAdjacentElement("afterend", error);
        }

        const summary = document.getElementById("formErrorSummary");
        if (summary && !summary.innerHTML.includes(message)) {
          summary.style.display = "block";
          summary.innerHTML += `<div>‚Ä¢ ${message}</div>`;
        }
      }

      function removeError(el) {
        el.style.border = "";
        el.classList.remove("tooltip");
        el.removeAttribute("data-tooltip");
        el.classList.remove("field-error");
        el.classList.add("valid");

        const label = el.closest("label");
        const next = label?.nextElementSibling;
        if (next && next.classList && next.classList.contains("field-error")) {
          next.remove();
        }

        const summary = document.getElementById("formErrorSummary");
        if (summary) {
          summary.innerHTML = "";
          summary.style.display = "none";
        }
      }

      function sanitizeNumericInput(event) {
        const original = event.target.value;
        const cleaned = original.replace(/\D/g, "");
        event.target.value = cleaned;
      }

      // –ú–∞—Å–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +7 XXX XXX XXXX
      function formatPhoneInput(event) {
        let input = event.target.value.replace(/\D/g, "");
        if (input.startsWith("7")) {
          input = input.slice(1); // remove leading 7 if present
        }
        input = input.slice(0, 10); // max 10 digits after +7
        let formatted = "+7 ";
        if (input.length > 0) {
          formatted += input.substring(0, 3);
        }
        if (input.length >= 4) {
          formatted += " " + input.substring(3, 6);
        }
        if (input.length >= 7) {
          formatted += " " + input.substring(6, 10);
        }
        event.target.value = formatted.trim();
      }

      // –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Å DOM-—ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ DOMContentLoaded!
      document.addEventListener("DOMContentLoaded", function () {
        // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ has_left –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        fetch("/api/update-has-left", { method: "POST" })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              console.log("‚úÖ has_left –æ–±–Ω–æ–≤–ª—ë–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã");
            } else {
              console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å has_left:", data.error);
            }
          })
          .catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ has_left:", err);
          });
        const phoneInput = document.getElementById("inputPhone");
        const relativePhoneInput = document.getElementById("inputRelativePhone");
        const iinInput = document.getElementById("inputIin");
        const fioEl = document.getElementById("inputFio");
        const universityEl = document.getElementById("inputUniversity");
        const relativeEl = document.getElementById("inputRelative");
        const paymentEl = document.getElementById("inputPayment");
        const rentalPeriodEl = document.getElementById("inputRentalPeriod");
        const addedByEl = document.getElementById("inputAddedBy");
        flatpickr("#inputMoveInDate", {
          dateFormat: "Y-m-d",
          defaultDate: new Date(),
          locale: "ru",
          minDate: null,
        });

        [
          fioEl,
          iinInput,
          phoneInput,
          universityEl,
          relativeEl,
          relativePhoneInput,
          paymentEl,
          rentalPeriodEl,
        ].forEach((el) => {
          if (el) {
            el.addEventListener("focus", function () {
              el.style.border = "";
            });
          }
        });

        // === –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ blur (–ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞) ===
        if (fioEl) {
          fioEl.addEventListener("blur", () => {
            removeError(fioEl);
            if (!fioEl.value.trim()) showError(fioEl, "–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
          });
        }
        if (iinInput) {
          iinInput.addEventListener("blur", () => {
            removeError(iinInput);
            if (!/^\d{12}$/.test(iinInput.value.trim())) showError(iinInput, "–í–≤–µ–¥–∏—Ç–µ –ò–ò–ù –∏–∑ 12 —Ü–∏—Ñ—Ä");
          });
        }
        if (paymentEl) {
          paymentEl.addEventListener("blur", () => {
            removeError(paymentEl);
            if (!paymentEl.value.trim()) showError(paymentEl, "–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
          });
        }
        const moveInDateEl = document.getElementById("inputMoveInDate");
        if (moveInDateEl) {
          moveInDateEl.addEventListener("blur", () => {
            removeError(moveInDateEl);
            if (!moveInDateEl.value.trim()) showError(moveInDateEl, "–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
          });
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
        function validatePhones() {
          removeError(phoneInput);
          removeError(relativePhoneInput);

          const phoneVal = phoneInput.value.trim();
          const relativeVal = relativePhoneInput.value.trim();
          const pattern = /^\+7 \d{3} \d{3} \d{4}$/;

          if (phoneVal && !pattern.test(phoneVal)) {
            showError(phoneInput, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 XXX XXX XXXX");
          }
          if (relativeVal && !pattern.test(relativeVal)) {
            showError(relativePhoneInput, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 XXX XXX XXXX");
          }

          if (pattern.test(phoneVal) && pattern.test(relativeVal) && phoneVal === relativeVal) {
            showError(phoneInput, "–ù–µ–ª—å–∑—è –≤–≤–æ–¥–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤!");
            showError(relativePhoneInput, "–ù–µ–ª—å–∑—è –≤–≤–æ–¥–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤!");
          }
        }

        if (phoneInput) {
          phoneInput.addEventListener("input", formatPhoneInput);
          phoneInput.addEventListener("blur", validatePhones);
        }
        if (relativePhoneInput) {
          relativePhoneInput.addEventListener("input", formatPhoneInput);
          relativePhoneInput.addEventListener("blur", validatePhones);
        }
        if (iinInput) {
          iinInput.addEventListener("input", function (e) {
            sanitizeNumericInput(e);
          });
        }
      });

      function copyMoveInDate() {
        const input = document.getElementById("inputMoveInDate");
        if (input && input.value) {
          navigator.clipboard.writeText(input.value).then(() => {
            showToast("–î–∞—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!", "info");
          });
        }
      }

      function copyPhone(id) {
        const input = document.getElementById(id);
        if (input && input.value) {
          const raw = input.value.replace(/\D/g, "");
          navigator.clipboard
            .writeText("+7" + raw.substring(raw.length - 10))
            .then(() => {
              showToast("–¢–µ–ª–µ—Ñ–æ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!", "info");
            });
        }
      }

      function copySelectValue(id) {
        const select = document.getElementById(id);
        if (select && select.value) {
          navigator.clipboard.writeText(select.value).then(() => {
            showToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: " + select.value, "info");
          });
        }
      }

    </script>
    <div id="toastContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>


    <script>
document.getElementById("exportExcelBtn").addEventListener("click", () => {
  fetch("/api/export-excel")
    .then(res => {
      if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ");
      return res.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è.xlsx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      showToast("üìÅ –§–∞–π–ª Excel –∑–∞–≥—Ä—É–∂–µ–Ω", "success");
    })
    .catch(err => {
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ Excel:", err);
      showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å Excel", "error");
    });
});
      function showToast(message = "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ", type = "success") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 2300);
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetch("/api/rooms/all")
          .then(res => res.json())
          .then(data => {
            allRooms = data;
            roomCapacities = {};
            allRooms.forEach(room => {
              roomCapacities[room.id] = room.places;
            });

            return fetch("/api/students");
          })
          .then(res => res.json())
          .then(data => {
            students = {};
            data.forEach(student => {
              const room = normalizeRoomId(student.room_id || "");
              if (!students[room]) students[room] = [];
              students[room].push({
                fio: student.fio,
                iin: student.iin,
                gender: student.gender,
                phone: student.phone,
                university: student.university,
                relative: student.relative_type,
                relativePhone: student.relative_phone,
                documentNumber: student.document_number,
                documentIssueDate: student.document_issue_date,
                documentIssuer: student.document_issuer,
                isGraduate: student.is_graduate,
                hasDisability: student.has_disability,
                payment: student.payment,
                moveInDate: student.move_in_date,
                rentalPeriod: student.rental_period,
                left: student.has_left,
                leftDate: student.left_date,
                cardNumber: student.card_number
              });
            });

            // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–°–¢–û–ú–ù–û–ì–û –°–ï–õ–ï–ö–¢–ê –ü–†–û–î–õ–ï–ù–ò–Ø –ê–†–ï–ù–î–´ ===
            const display = document.getElementById("displayExtendRental");
            const options = document.getElementById("optionsExtendRental");
            const hiddenInput = document.getElementById("extendRentalHidden");

            if (display && options && hiddenInput) {
              display.addEventListener("click", () => {
                const isOpen = options.style.display === "block";
                document.querySelectorAll(".custom-options").forEach(o => o.style.display = "none");
                document.querySelectorAll(".custom-select").forEach(d => d.classList.remove("active"));
                if (!isOpen) {
                  options.style.display = "block";
                  display.classList.add("active");
                }
              });

              options.querySelectorAll("div").forEach(opt => {
                opt.addEventListener("click", () => {
                  const val = opt.getAttribute("data-value");
                  hiddenInput.value = val;
                  display.textContent = opt.textContent;
                  // –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∫–ª–∞—Å—Å selected
                  options.querySelectorAll("div").forEach(d => d.classList.remove("selected"));
                  opt.classList.add("selected");
                  options.style.display = "none";
                });
              });

              window.addEventListener("click", (e) => {
                if (!e.target.closest(".custom-select-wrapper")) {
                  options.style.display = "none";
                  display.classList.remove("active");
                }
              });
            } else {
              console.warn("‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
            }
            generateBlocks();
            document.getElementById("loading")?.remove();
          })
          .catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", err);
            document.getElementById("blocksContainer").innerHTML =
              "<div style='color:red'>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>";
            document.getElementById("loading")?.remove();
          });
      });
    </script>
    <script>
    document.getElementById("logoutBtn").addEventListener("click", function () {
      localStorage.removeItem("auth");
      window.location.href = "login.html";
    });
    function editCardNumber(room, iin) {
      const student = students[room]?.find(s => s.iin === iin);
      if (!student) return;

      const parentDiv = event.target.closest("p");
      if (parentDiv.querySelector(".card-input-wrapper")) return; // —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ

      const wrapper = document.createElement("div");
      wrapper.className = "card-input-wrapper";
      wrapper.style.marginTop = "8px";

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "10 —Ü–∏—Ñ—Ä";
      input.value = student.cardNumber || "";
      input.maxLength = 10;
      input.style.padding = "4px 8px";
      input.style.width = "140px";
      input.style.marginRight = "8px";
      input.oninput = (e) => {
        e.target.value = e.target.value.replace(/\D/g, "").slice(0, 10);
      };

      const saveBtn = document.createElement("button");
      saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
      saveBtn.className = "btn btn-sm btn-primary";
      saveBtn.onclick = () => {
        const cleaned = input.value;
        if (cleaned.length !== 10) {
          showToast("–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 —Ü–∏—Ñ—Ä", "error");
          return;
        }

        fetch(`/api/students/update-card`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ room, iin, cardNumber: cleaned })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showToast("–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±–Ω–æ–≤–ª—ë–Ω", "success");
              student.cardNumber = cleaned;
              openDossierModal(room); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
            } else {
              showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏", "error");
            }
          })
          .catch(err => {
            console.error("–û—à–∏–±–∫–∞:", err);
            showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
          });
      };

      wrapper.appendChild(input);
      wrapper.appendChild(saveBtn);
      parentDiv.appendChild(wrapper);
    }
    // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ –ø–æ–º–µ—Å—è—á–Ω–æ–π —Ä–∞–∑–±–∏–≤–∫–∏ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ---
    function calculateMonthlyBreakdown(student) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç { 'YYYY-M': —Å—É–º–º–∞, ... }
      const breakdown = {};
      if (!student.moveInDate || !student.rentalPeriod) return breakdown;
      const moveIn = new Date(student.moveInDate);
      if (isNaN(moveIn)) return breakdown;
      const rentalPeriod = parseInt(student.rentalPeriod);
      if (!rentalPeriod) return breakdown;
      let moveOut;
      if (student.left && student.leftDate) {
        moveOut = new Date(student.leftDate);
        if (isNaN(moveOut)) moveOut = new Date(moveIn.getFullYear(), moveIn.getMonth() + rentalPeriod, 0);
      } else {
        moveOut = addMonths(moveIn, rentalPeriod);
        moveOut.setDate(moveOut.getDate() - 1);
      }
      const payment = Number(student.payment || (rentalPeriod * 30000));
      // –°—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è
      const totalDays = Math.ceil((moveOut - moveIn) / (1000 * 60 * 60 * 24)) + 1;
      let current = new Date(moveIn);
      while (current <= moveOut) {
        const y = current.getFullYear();
        const m = current.getMonth();
        const monthStart = new Date(y, m, 1);
        const monthEnd = new Date(y, m + 1, 0);
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–Ω–µ–π –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
        const fromDay = (current > monthStart) ? current.getDate() : 1;
        const toDay = (moveOut < monthEnd) ? moveOut.getDate() : monthEnd.getDate();
        const daysStayed = toDay - fromDay + 1;
        const ratio = daysStayed / totalDays;
        const part = Math.round(payment * ratio);
        const key = `${y}-${m}`;
        if (!breakdown[key]) breakdown[key] = 0;
        breakdown[key] += part;
        current = new Date(y, m + 1, 1);
      }
      return breakdown;
    }
  </script>
  </body>
</html>