<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–í—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç—ã</title>
    <style>
      .spinner {
        border: 2px solid #fff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f0f2f5;
        padding: 20px;
        font-size: 14px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }
      .form-wrapper {
        max-width: 600px;
        background: #fff;
        padding: 20px;
        margin: 40px auto;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
      }
      h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      .room-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: space-between;
      }
      .room-card {
        border: 2px solid #ccc;
        width: 18%;
        min-width: 60px;
        height: 70px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        border-radius: 6px;
        background-color: #fff;
        box-sizing: border-box;
      }
      .room-card.available {
        border-color: green;
      }
      .room-card.full {
        border-color: red;
      }
      .room-card.selected {
        background-color: #004d99;
        color: #ffffff;
        border: 2px solid #004d99;
        box-shadow: 0 0 8px rgba(0, 77, 153, 0.8);
        transform: scale(1.05);
        animation: pop 0.3s ease-in-out;
      }

      .room-card:not(.selected) {
        transition: all 0.25s ease;
      }

      .room-card:hover {
        transform: scale(1.02);
        border-color: #004d99;
        box-shadow: 0 0 4px rgba(0, 77, 153, 0.4);
      }
      .room-status {
        margin-top: 8px;
        font-size: 13px;
        font-weight: bold;
      }
      .free {
        color: green;
      }
      .occupied {
        color: red;
      }
      .btn {
        background-color: #004d99;
        color: white;
        border: none;
        padding: 10px;
        margin-top: 20px;
        width: 100%;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
      }
      .floor-section {
        margin-bottom: 20px;
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
      }

      .floor-section.hidden {
        opacity: 0;
        pointer-events: none;
        height: 0;
        overflow: hidden;
        padding: 0;
        margin: 0;
      }
      .floor-section.collapsed .room-grid {
        display: none !important;
      }
      #block-sections h3 {
        margin-top: 30px;
        color: #004d99;
      }
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
        background-color: #fff;
        transition: border-color 0.3s;
      }
      select:focus {
        border-color: #004d99;
        box-shadow: 0 0 0 2px rgba(0, 77, 153, 0.2);
        outline: none;
      }
      option:checked {
        background-color: #004d99;
        color: white;
      }
      @media (max-width: 768px) {
        .blocks-wrapper {
          flex-direction: column;
        }
        .block-column {
          width: 100%;
        }
      }
      .custom-select-wrapper {
        position: relative;
        user-select: none;
      }

      .custom-select {
        background-color: #fff;
        border: 2px solid #ccc;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: border-color 0.3s;
        position: relative;
      }

      .custom-select::after {
        content: "‚ñæ";
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #004d99;
        font-size: 14px;
        pointer-events: none;
      }

      .custom-select.active,
      .custom-select:hover {
        border-color: #004d99;
      }

      .custom-options {
        position: absolute;
        background-color: #fff;
        border: 2px solid #ccc;
        border-top: none;
        width: 100%;
        max-height: 180px;
        overflow-y: auto;
        display: none;
        z-index: 10;
      }

      .custom-options div {
        padding: 10px;
        cursor: pointer;
      }

      .custom-options div:hover {
        background-color: #004d99;
        color: white;
      }
      @media (max-width: 360px) {
        .room-card {
          width: 45% !important;
        }
      }
    </style>
    <style>
      .toast {
        position: fixed;
        background-color: #333;
        color: white;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease, transform 0.5s ease;
        z-index: 9999;
      }
      .toast.show {
        opacity: 1;
        pointer-events: auto;
      }
      .toast.success { background-color: #28a745; }
      .toast.error   { background-color: hsl(354, 70%, 54%); }
      .toast.info { background-color: #004d99; }
      @media (min-width: 481px) {
        .toast {
          bottom: 20px;
          right: 20px;
          transform: translateY(20px);
        }
        .toast.show {
          transform: translateY(0);
        }
      }
      @media (max-width: 480px) {
        .toast {
          top: 10px;
          left: 50%;
          transform: translateX(-50%) translateY(-20px);
          max-width: 90%;
        }
        .toast.show {
          transform: translateX(-50%) translateY(0);
        }
      }
    </style>
    <style>
      .btn-reset {
        background-color: #ccc;
        color: #333;
        margin-top: 10px;
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        width: 100%;
        box-sizing: border-box;
      }

      .btn-reset:hover {
        background-color: #bbb;
      }
    </style>
  </head>
  <body>
    <div class="form-wrapper">
      <h2>–í—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç—ã</h2>
      <div id="block-sections"></div>
      <div
        style="
          display: flex;
          flex-direction: row;
          justify-content: space-between;
          gap: 10px;
          margin-top: 20px;
        "
      >
        <button type="button" class="btn btn-primary" id="backButton">
          <span class="arrow">&#8592;</span>
          <span class="btn-label">–ù–∞–∑–∞–¥</span>
        </button>
        <button class="btn btn-primary" onclick="confirmRoom()">
          <span class="btn-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</span>
          <span class="arrow">&#10003;</span>
        </button>
      </div>
      <button type="button" class="btn btn-reset" id="resetButton">
        <span class="btn-label">–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä</span>
        <span class="arrow">&#128465;</span>
      </button>
      <div id="toast" class="toast">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
    </div>

    <script>
      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.className = `toast show ${type}`;
        toast.textContent = message;
        clearTimeout(toast.hideTimeout);
        toast.hideTimeout = setTimeout(() => {
          toast.className = "toast";
        }, 3000);
      }
      const host = window.location.hostname;
      let serverRoomStatus = {};

      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–º–Ω–∞—Ç, –≥–¥–µ occupied —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å has_left = false
      // –í–∞–∂–Ω–æ: backend –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å occupied —Ç–æ–ª—å–∫–æ –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º!
      async function loadRoomStatus() {
        // –î–ª—è backend: —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SQL-–∑–∞–ø—Ä–æ—Å —Å—á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å has_left = false!
        // SQL:
        // SELECT room_id, COUNT(*) as occupied
        // FROM selections
        // JOIN accommodation ON selections.student_id = accommodation.student_id
        // WHERE accommodation.has_left = false
        // GROUP BY room_id
        const res = await fetch(`http://${host}:3000/api/rooms/status`);
        serverRoomStatus = await res.json();
      }

      let rooms = [];

      async function loadRoomsFromDatabase() {
        const res = await fetch(`http://${host}:3000/api/rooms/all`);
        const rawRooms = await res.json();
        rooms = rawRooms.map((r) => ({
          id: r.id,
          block: r.block,
          floor: r.floor,
          places: r.places,
          occupied: r.occupied,
          displayId: r.displayId, // –¥–æ–±–∞–≤–ª—è–µ–º displayId –µ—Å–ª–∏ –µ—Å—Ç—å
          type: "–û–±—ã—á–Ω–∞—è",
          status: "free"
        }));
      }

      async function initialize() {
        await loadRoomsFromDatabase();
        await loadRoomStatus();
        filterRooms();         // —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Å–Ω–∞—á–∞–ª–∞
        generateBlocks();      // –∑–∞—Ç–µ–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–ª–æ–∫–∏
      }

      // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ localStorage ---
      const studentFormDataRaw = localStorage.getItem("studentFormData");
      const studentDocumentsRaw = localStorage.getItem("studentDocuments");

      if (!studentFormDataRaw && !studentDocumentsRaw) {
        alert("–í—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏ —Ñ–æ—Ä–º—É —Å –ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏.");
        window.location.href = "form-personal.html";
      } else if (!studentFormDataRaw) {
        alert("–í—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏ —Ñ–æ—Ä–º—É —Å –ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.");
        window.location.href = "form-personal.html";
      } else if (!studentDocumentsRaw) {
        alert("–í—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏ —Ñ–æ—Ä–º—É —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏.");
        window.location.href = "form-documents.html";
      }

      // --- Room filtering logic based on student data ---
      const studentData = JSON.parse(studentFormDataRaw || "{}");
      const documents = JSON.parse(studentDocumentsRaw || "{}");

      const gender = studentData.gender;
      const hasDisability = documents.hasDisability === "–ï—Å—Ç—å";
      const isGraduated = documents.isGraduate === "–î–∞";

      const blockSections = {};
      const parent = document.getElementById("block-sections");

      // –ö–∞—Å—Ç–æ–º–Ω—ã–π –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —ç—Ç–∞–∂–µ–π
      const customWrapper = document.createElement("div");
      customWrapper.className = "custom-select-wrapper";
      customWrapper.style.marginBottom = "20px";

      const customDisplay = document.createElement("div");
      customDisplay.className = "custom-select";
      customDisplay.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —ç—Ç–∞–∂–∏";

      const customOptions = document.createElement("div");
      customOptions.className = "custom-options";

      const isMale = gender === "–ú—É–∂—á–∏–Ω–∞";
      const isFemale = gender === "–ñ–µ–Ω—â–∏–Ω–∞";

      const values = ["all"];
      const labels = ["–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —ç—Ç–∞–∂–∏"];

      if (isMale) {
        values.push("3", "5");
        labels.push("–¢–æ–ª—å–∫–æ —ç—Ç–∞–∂ 3", "–¢–æ–ª—å–∫–æ —ç—Ç–∞–∂ 5");
      } else if (isFemale) {
        values.push("2", "4");
        labels.push("–¢–æ–ª—å–∫–æ —ç—Ç–∞–∂ 2", "–¢–æ–ª—å–∫–æ —ç—Ç–∞–∂ 4");
      }

      values.forEach((val, i) => {
        const opt = document.createElement("div");
        opt.dataset.value = val;
        opt.textContent = labels[i];
        customOptions.appendChild(opt);
      });
      if (customOptions.children.length === 0) {
        const warning = document.createElement("div");
        warning.textContent = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç—Ç–∞–∂–µ–π";
        warning.style.color = "red";
        customOptions.appendChild(warning);
      }

      customDisplay.addEventListener("click", () => {
        const isOpen = customOptions.style.display === "block";
        document
          .querySelectorAll(".custom-options")
          .forEach((o) => (o.style.display = "none"));
        document
          .querySelectorAll(".custom-select")
          .forEach((d) => d.classList.remove("active"));
        if (!isOpen) {
          customOptions.style.display = "block";
          customDisplay.classList.add("active");
        }
      });

      // Refactored: use unified filtering logic
      let currentFloorFilter = "all";
      let currentBlockFilter = "all";

      customOptions.querySelectorAll("div").forEach((opt) => {
        opt.addEventListener("click", () => {
          currentFloorFilter = opt.dataset.value;
          customDisplay.textContent = opt.textContent;
          customOptions.style.display = "none";
          applyFilters();
        });
      });

      customWrapper.appendChild(customDisplay);
      customWrapper.appendChild(customOptions);
      parent.appendChild(customWrapper);

      // –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–µ–ª–µ–∫—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –±–ª–æ–∫–∞–º (–ê, –ë, –í)
      const blockFilterWrapper = document.createElement("div");
      blockFilterWrapper.className = "custom-select-wrapper";
      blockFilterWrapper.style.marginBottom = "20px";

      const blockDisplay = document.createElement("div");
      blockDisplay.className = "custom-select";
      blockDisplay.textContent = hasDisability || isGraduated ? "–¢–æ–ª—å–∫–æ –±–ª–æ–∫ –í" : "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –±–ª–æ–∫–∏";

      const blockOptions = document.createElement("div");
      blockOptions.className = "custom-options";

      const blockValues = ["all", "–ê", "–ë", "–í"];
      const blockLabels = [
        "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –±–ª–æ–∫–∏",
        "–¢–æ–ª—å–∫–æ –±–ª–æ–∫ –ê",
        "–¢–æ–ª—å–∫–æ –±–ª–æ–∫ –ë",
        "–¢–æ–ª—å–∫–æ –±–ª–æ–∫ –í",
      ];

      const allowedBlockOptions = hasDisability || isGraduated ? ["–í"] : blockValues;
      allowedBlockOptions.forEach((val) => {
        const i = blockValues.indexOf(val);
        const opt = document.createElement("div");
        opt.dataset.value = val;
        opt.textContent = blockLabels[i];
        blockOptions.appendChild(opt);
      });
      if (blockOptions.children.length === 0) {
        const warning = document.createElement("div");
        warning.textContent = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–ª–æ–∫–æ–≤";
        warning.style.color = "red";
        blockOptions.appendChild(warning);
      }

      blockDisplay.addEventListener("click", () => {
        const isOpen = blockOptions.style.display === "block";
        document
          .querySelectorAll(".custom-options")
          .forEach((o) => (o.style.display = "none"));
        document
          .querySelectorAll(".custom-select")
          .forEach((d) => d.classList.remove("active"));
        if (!isOpen) {
          blockOptions.style.display = "block";
          blockDisplay.classList.add("active");
        }
      });

      blockOptions.querySelectorAll("div").forEach((opt) => {
        opt.addEventListener("click", () => {
          currentBlockFilter = opt.dataset.value;
          blockDisplay.textContent = opt.textContent;
          blockOptions.style.display = "none";
          applyFilters();
        });
      });

      function applyFilters() {
        document.querySelectorAll("#block-sections > h3").forEach((h3) => {
          const block = h3.textContent.trim().slice(-1);
          const showBlock =
            currentBlockFilter === "all" || currentBlockFilter === block;

          let sibling = h3.nextElementSibling;
          let anyVisible = false;

          while (sibling && sibling.tagName !== "H3") {
            if (sibling.classList.contains("floor-section")) {
              const toggleBtn = sibling.querySelector("button");
              const floorMatch = toggleBtn?.textContent?.match(/\d+/);
              const floorNumber = floorMatch ? floorMatch[0] : "";
              const showFloor =
                currentFloorFilter === "all" || currentFloorFilter === floorNumber;
              const visible = showBlock && showFloor;

              if (visible) {
                sibling.classList.remove("hidden");
                sibling.style.display = "";
                anyVisible = true;
              } else {
                sibling.classList.add("hidden");
              }
            }
            sibling = sibling.nextElementSibling;
          }

          h3.style.display = anyVisible ? "" : "none";
        });
      }

      blockFilterWrapper.appendChild(blockDisplay);
      blockFilterWrapper.appendChild(blockOptions);
      parent.insertBefore(blockFilterWrapper, customWrapper);

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –±–ª–æ–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const allowedBlocks = hasDisability || isGraduated ? ["–í"] : ["–ê", "–ë", "–í"];

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ª–∞—Ç–∏–Ω—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤ –≤ –∫–∏—Ä–∏–ª–ª–∏—Ü—É
      function convertBlockToCyrillic(block) {
        return block
          .replace(/^A$/, '–ê')
          .replace(/^B$/, '–ë')
          .replace(/^V$/, '–í');
      }

      ["–ê", "–ë", "–í"].forEach((block) => {
        if (!allowedBlocks.includes(block)) return;
        const cyrBlock = convertBlockToCyrillic(block);
        const blockTitle = document.createElement("h3");
        blockTitle.textContent = `–ë–ª–æ–∫ ${cyrBlock}`;
        parent.appendChild(blockTitle);

        blockSections[cyrBlock] = {};

        for (let floor = 2; floor <= 5; floor++) {
          // –ù–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä —ç—Ç–∞–∂–µ–π —Å–æ–≥–ª–∞—Å–Ω–æ —É—Å–ª–æ–≤–∏—è–º
          const autoExpand = hasDisability || isGraduated;
          let allowedFloors = [];
          if (hasDisability) {
            allowedFloors =
              gender === "–ú—É–∂—á–∏–Ω–∞" ? [3, 5] :
              gender === "–ñ–µ–Ω—â–∏–Ω–∞" ? [2, 4] : [];
          } else if (isGraduated) {
            allowedFloors = gender === "–ú—É–∂—á–∏–Ω–∞" ? [3, 5] : [2, 4];
          } else {
            allowedFloors = gender === "–ú—É–∂—á–∏–Ω–∞" ? [3, 5] : gender === "–ñ–µ–Ω—â–∏–Ω–∞" ? [2, 4] : [];
          }
          if (!allowedFloors.includes(floor)) continue;

          const floorDiv = document.createElement("div");
          floorDiv.className = "floor-section";
          // –í—Å–µ–≥–¥–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ —ç—Ç–∞–∂–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∫—Ä–æ–º–µ –∏–Ω–≤–∞–ª–∏–¥–æ–≤ –∏ –º–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç–æ–≤)
          if (!autoExpand) {
            floorDiv.classList.add("collapsed");
          }

          // –ù–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞-–∑–∞–≥–æ–ª–æ–≤–æ–∫ —ç—Ç–∞–∂–∞
          const toggleBtn = document.createElement("button");
          toggleBtn.textContent = `–≠—Ç–∞–∂ ${floor}`;
          toggleBtn.style.display = "block";
          toggleBtn.style.width = "100%";
          toggleBtn.style.textAlign = "left";
          toggleBtn.style.padding = "12px";
          toggleBtn.style.margin = "10px 0";
          toggleBtn.style.backgroundColor = "#eceef1";
          toggleBtn.style.border = "1px solid #ccc";
          toggleBtn.style.borderRadius = "8px";
          toggleBtn.style.fontWeight = "bold";
          toggleBtn.style.fontSize = "16px";
          toggleBtn.style.cursor = "pointer";

          const roomGrid = document.createElement("div");
          roomGrid.className = "room-grid";

          toggleBtn.onclick = () => {
            const selectedCard = floorDiv.querySelector(".room-card.selected");
            if (selectedCard) {
              // –ù–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —ç—Ç–∞–∂ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–Ω–∞—Ç–æ–π
              return;
            }
            const isHidden = floorDiv.classList.toggle("collapsed");
            roomGrid.style.display = floorDiv.classList.contains("collapsed") ? "none" : "flex";
          };

          floorDiv.appendChild(toggleBtn);
          floorDiv.appendChild(roomGrid);

          blockSections[cyrBlock][floor] = roomGrid;
          parent.appendChild(floorDiv);
        }
      });

      
      const allowedRoomsSet = new Set();

      function filterRooms() {
        allowedRoomsSet.clear();
        console.log("üìå –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–Ω–∞—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞:", { gender, hasDisability, isGraduated });
        rooms.forEach((room) => {
          const block = room.block;
          const roomNum = parseInt(room.id.split("-")[1]);
          const floor = Math.floor(roomNum / 100);

          if (hasDisability) {
            if (
              block === "V" &&
              (
                (gender === "–ú—É–∂—á–∏–Ω–∞" && [305, 306, 307, 308, 505, 506, 507, 508].includes(roomNum)) ||
                (gender === "–ñ–µ–Ω—â–∏–Ω–∞" && [205, 206, 207, 208, 405, 406, 407, 408].includes(roomNum))
              )
            ) {
              allowedRoomsSet.add(room.id);
            }
          } else if (isGraduated) {
            if (
              block === "V" &&
              (
                (gender === "–ú—É–∂—á–∏–Ω–∞" && [501, 502, 503, 504, 301, 302, 303, 304].includes(roomNum)) ||
                (gender === "–ñ–µ–Ω—â–∏–Ω–∞" && [201, 202, 203, 204, 401, 402, 403, 404].includes(roomNum))
              )
            ) {
              allowedRoomsSet.add(room.id);
            }
          } else {
            if (
              (gender === "–ú—É–∂—á–∏–Ω–∞" && [3, 5].includes(floor)) ||
              (gender === "–ñ–µ–Ω—â–∏–Ω–∞" && [2, 4].includes(floor))
            ) {
              allowedRoomsSet.add(room.id);
            }
          }
        });
        console.log("‚úÖ –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã:", Array.from(allowedRoomsSet));
      }
      function generateBlocks() {
        // –û—á–∏—â–∞–µ–º –≤—Å–µ grid'—ã
        Object.values(blockSections).forEach(floors => {
          Object.values(floors).forEach(grid => grid.innerHTML = "");
        });
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ–º–Ω–∞—Ç –ø–æ –±–ª–æ–∫—É –∏ –Ω–æ–º–µ—Ä—É –∫–æ–º–Ω–∞—Ç—ã
        rooms.sort((a, b) => {
          const [blockA, numA] = a.id.split("-");
          const [blockB, numB] = b.id.split("-");
          if (blockA !== blockB) return blockA.localeCompare(blockB);
          return parseInt(numA) - parseInt(numB);
        });
        rooms.forEach((room) => {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã
          const backendRoom = serverRoomStatus[room.id];
          if (!backendRoom) return;
          if (!allowedRoomsSet.has(room.id)) return;
          const div = document.createElement("div");
          div.className = "room-card";
          div.dataset.id = room.id;
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π occupied —Å backend (—É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å has_left = false)
          const occupied = backendRoom.occupied;
          const places = backendRoom.places;
          if (occupied < places) {
            div.classList.add("available");
          } else {
            div.classList.add("full");
            div.style.pointerEvents = "none";
            div.style.opacity = "0.6";
          }
          div.innerHTML = `
          <div>${room.displayId || room.id}</div>
          <div>${occupied}/${places}</div>
        `;
          if (occupied < places) {
            div.addEventListener("click", () => {
              if (div.classList.contains("selected")) return; // –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å, –µ—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞

              // –Ω–∞–π—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–æ–º–Ω–∞—Ç—É
              const previouslySelected = document.querySelector(
                ".room-card.selected"
              );
              if (previouslySelected && previouslySelected !== div) {
                previouslySelected.classList.remove("selected");
                const prevId = previouslySelected.dataset.id;
                // –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ backend-–∑–Ω–∞—á–µ–Ω–∏—è
                const prevBackend = serverRoomStatus[prevId];
                const prevOccupied = prevBackend ? prevBackend.occupied : 0;
                const prevPlaces = prevBackend ? prevBackend.places : 0;
                // –ù–∞–π—Ç–∏ –æ–±—ä–µ–∫—Ç –∫–æ–º–Ω–∞—Ç—ã –ø–æ id, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å displayId
                const prevRoom = rooms.find(r => r.id === prevId);
                previouslySelected.innerHTML = `
                  <div>${prevRoom?.displayId || prevId}</div>
                  <div>${prevOccupied}/${prevPlaces}</div>
                `;
              }

              // –æ—Ç–º–µ—Ç–∏—Ç—å –Ω–æ–≤—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é
              div.classList.add("selected");
              // –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã, —É–≤–µ–ª–∏—á–∏–≤ occupied –Ω–∞ 1
              const newOccupied = occupied + 1;
              div.innerHTML = `
                <div>${room.displayId || room.id}</div>
                <div>${newOccupied}/${places}</div>
              `;
            });
          }
          let targetFloor = parseInt(room.id.split("-")[1].charAt(0));
          let blockKey = room.id.split("-")[0];
          let cyrBlockKey = convertBlockToCyrillic(blockKey);
          let floorContainer = blockSections[cyrBlockKey]?.[targetFloor];
          if (floorContainer) {
            floorContainer.appendChild(div);
          }
        });
      }

      async function confirmRoom() {
        const confirmBtn = document.querySelector('button[onclick="confirmRoom()"]');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="btn-label">–°–æ—Ö—Ä–∞–Ω—è–µ–º</span><span class="spinner"></span>';
        const selected = document.querySelector(".room-card.selected");
        if (!selected) {
          alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</span><span class="arrow">&#10003;</span>';
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ localStorage
        try {
          localStorage.setItem("storage_test", "1");
          localStorage.removeItem("storage_test");
        } catch (e) {
          alert(
            "–û—à–∏–±–∫–∞: localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ."
          );
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</span><span class="arrow">&#10003;</span>';
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–º–Ω–∞—Ç—ã
        const roomId = selected.dataset.id;
        // –î–æ–±–∞–≤–ª–µ–Ω–æ: –∑–∞–ø—Ä–µ—Ç –≤—ã–±–æ—Ä–∞ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã
        if (!allowedRoomsSet.has(roomId)) {
          alert("–í—ã–±—Ä–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —É—Å–ª–æ–≤–∏—è–º –¥–æ–ø—É—Å–∫–∞.");
          selected.classList.remove("selected");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</span><span class="arrow">&#10003;</span>';
          return;
        }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ backend
        const backendRoom = serverRoomStatus[roomId];
        if (!backendRoom || backendRoom.occupied >= backendRoom.places) {
          alert(
            "–û—à–∏–±–∫–∞: –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é."
          );
          selected.classList.remove("selected");
          showToast("–ö–æ–º–Ω–∞—Ç–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é.", "error");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</span><span class="arrow">&#10003;</span>';
          return;
        }

        // –ù–æ–≤—ã–π –±–ª–æ–∫: —Å–æ–∑–¥–∞–Ω–∏–µ personalData, documentsData, fio –∏ studentBody
        const personalData = JSON.parse(localStorage.getItem("studentFormData") || "{}");
        const documentsData = JSON.parse(localStorage.getItem("studentDocuments") || "{}");

        const fio = `${personalData.lastName} ${personalData.firstName}${personalData.middleName ? ' ' + personalData.middleName : ''}`;

        const parsedPayment = Math.max(parseInt((personalData.payment ?? "").replace(/\D/g, ""), 10), 1);
        const parsedRental = Math.max(parseInt(personalData.rentalPeriod ?? "", 10), 1);

        // –£–¥–∞–ª—è–µ–º –ø–æ–ª–µ 'relative' –∏–∑ personalData, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const { relative, ...personalDataWithoutRelative } = personalData;
        const studentBody = {
          ...personalDataWithoutRelative,
          ...documentsData,
          fio,
          is_graduate: documentsData.isGraduate === "–î–∞",
          has_disability: documentsData.hasDisability === "–ï—Å—Ç—å",
          room_id: selected.dataset.id,
          rental_period: parsedRental,
          payment: parsedPayment,
          moveInDate: personalData.moveInDate || new Date().toISOString().split("T")[0],
          relative_type: personalData.relative,
          relative_phone: personalData.relativePhone,
          document_number: documentsData.documentNumber,
          document_issue_date: documentsData.documentIssueDate,
          document_issuer: documentsData.documentIssuer,
          // --- –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ ...documentsData ---
          email: documentsData.email,
          registration_city: documentsData.registrationCity,
          registration_address: documentsData.registrationAddress,
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
        if (!personalData || !personalData.lastName || !personalData.firstName || !personalData.iin) {
          alert("–í—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏ —Ñ–æ—Ä–º—É —Å –ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</span><span class="arrow">&#10003;</span>';
          window.location.href = "form-personal.html";
          return;
        }

        if (
          !documentsData ||
          !documentsData.documentNumber?.trim() ||
          !documentsData.documentIssueDate?.trim() ||
          !documentsData.documentIssuer?.trim() ||
          !documentsData.isGraduate?.trim() ||
          !documentsData.hasDisability?.trim()
        ) {
          alert("–í—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏ —Ñ–æ—Ä–º—É —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</span><span class="arrow">&#10003;</span>';
          window.location.href = "form-documents.html";
          return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–æ–º–Ω–∞—Ç—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        localStorage.setItem("selectedRoom", selected.dataset.id);

        // --- –ù–æ–≤—ã–π –∫–æ–¥: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º occupied ---
        try {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞
          const saveRes = await fetch(`http://${host}:3000/api/students`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(studentBody)
          });
          if (!saveRes.ok) {
            throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–∞");
          }

          // --- –ù–æ–≤—ã–π –≤—ã–∑–æ–≤: –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ /api/upload-documents ---
          try {
            const [block, room] = studentBody.room_id.split("-");
            const uploadRes = await fetch(`http://${host}:3000/api/upload-documents`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                lastName: personalData.lastName,
                firstName: personalData.firstName,
                middleName: personalData.middleName,
                iin: personalData.iin,
                phone: personalData.phone,
                email: personalData.email || "",
                university: personalData.university,
                documentNumber: documentsData.documentNumber,
                documentIssueDate: documentsData.documentIssueDate,
                documentIssuer: documentsData.documentIssuer,
                hasDisability: documentsData.hasDisability,
                isGraduate: documentsData.isGraduate,
                room: room,
                block: block,
                registrationAddress: "–≥. –ê—Å—Ç–∞–Ω–∞, —É–ª. –ú–∏—Ä–∞, –¥. 30"
              })
            });
            // –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          } catch (e) {
            console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è upload-documents:", e.message);
          }

          // WebSocket-–æ–ø–æ–≤–µ—â–µ–Ω–∏–µ
          socket.send(JSON.stringify({ type: "roomUpdate", roomId: studentBody.room_id }));

        } catch (err) {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑. " + (err?.message || ""));
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</span><span class="arrow">&#10003;</span>';
          return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º firstName –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
        const firstName = personalData.firstName;
        localStorage.removeItem("studentFormData");
        localStorage.removeItem("studentDocuments");
        localStorage.removeItem("selectedRoom");
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ firstName
        localStorage.setItem("studentFirstName", JSON.stringify(firstName));
        window.location.href = "confirmation.html";
      }

      window.addEventListener("click", (e) => {
        if (!e.target.closest(".custom-select-wrapper")) {
          document
            .querySelectorAll(".custom-options")
            .forEach((o) => (o.style.display = "none"));
          document
            .querySelectorAll(".custom-select")
            .forEach((d) => d.classList.remove("active"));
        }
      });
      document.getElementById("resetButton").onclick = function () {
        const selected = document.querySelector(".room-card.selected");
        if (selected) {
          selected.classList.remove("selected");
          const roomId = selected.dataset.id;
          const backendRoom = serverRoomStatus[roomId];
          if (backendRoom) {
            // –ù–∞–π—Ç–∏ –æ–±—ä–µ–∫—Ç –∫–æ–º–Ω–∞—Ç—ã –ø–æ id, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å displayId
            const roomObj = rooms.find(r => r.id === roomId);
            selected.innerHTML = `
              <div>${roomObj?.displayId || roomId}</div>
              <div>${backendRoom.occupied}/${backendRoom.places}</div>
            `;
          }
          showToast("–í—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç—ã —Å–±—Ä–æ—à–µ–Ω", "info");
        }
      };

      document.getElementById("backButton").onclick = function () {
        window.location.href = "form-documents.html";
      };

      // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      initialize();
    </script>
    <script>
      function setupWebSocket() {
        const socket = new WebSocket(`ws://${host}:3000`);

        socket.addEventListener("open", () => {
          console.log("üü¢ WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
        });

        socket.addEventListener("message", async (event) => {
          console.log("üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", event.data);
          try {
            const data = JSON.parse(event.data);
            if (data.type === "roomUpdate") {
              await loadRoomStatus();
              updateSingleRoom(data.roomId);
              showToast(`–ö–æ–º–Ω–∞—Ç–∞ ${data.roomId} –æ–±–Ω–æ–≤–∏–ª–∞—Å—å`);
            }
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏—è WebSocket:", e);
          }
        });

        socket.addEventListener("close", () => {
          console.log("üîÅ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫");
          setTimeout(setupWebSocket, 3000);
        });

        socket.addEventListener("error", (err) => {
          console.error("‚ùå WebSocket –æ—à–∏–±–∫–∞:", err);
        });

        window.socket = socket;
      }

      window.addEventListener("load", () => {
        setupWebSocket();
      });
    </script>
    <script>
    function updateSingleRoom(roomId) {
      const backendRoom = serverRoomStatus[roomId];
      if (!backendRoom) return;

      const card = document.querySelector(`.room-card[data-id="${roomId}"]`);
      if (!card) return;

      // –ù–∞–π—Ç–∏ –æ–±—ä–µ–∫—Ç –∫–æ–º–Ω–∞—Ç—ã –ø–æ id, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å displayId
      const roomObj = rooms.find(r => r.id === roomId);
      const displayId = roomObj?.displayId || roomId;

      const isSelected = card.classList.contains("selected");
      const isFull = backendRoom.occupied >= backendRoom.places;

      // –ù–æ–≤—ã–π –±–ª–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è innerHTML
      const displayedOccupied = isSelected ? backendRoom.occupied + 1 : backendRoom.occupied;
      card.innerHTML = `
        <div>${displayId}</div>
        <div>${displayedOccupied}/${backendRoom.places}</div>
      `;

      if (isFull) {
        card.classList.remove("available", "selected");
        card.classList.add("full");
        card.style.pointerEvents = "none";
        card.style.opacity = "0.6";
      } else {
        card.classList.remove("full");
        card.classList.add("available");
        card.style.pointerEvents = "";
        card.style.opacity = "";

        if (!isSelected) {
          // card.innerHTML = ... // –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤—ã—à–µ
          // card.innerHTML = `
          //   <div>${displayId}</div>
          //   <div>${backendRoom.occupied}/${backendRoom.places}</div>
          // `;
          card.onclick = () => {
            const selected = document.querySelector(".room-card.selected");
            if (selected && selected !== card) {
              selected.classList.remove("selected");
              const sid = selected.dataset.id;
              const backend = serverRoomStatus[sid];
              const selRoomObj = rooms.find(r => r.id === sid);
              if (backend) {
                selected.innerHTML = `
                  <div>${selRoomObj?.displayId || sid}</div>
                  <div>${backend.occupied}/${backend.places}</div>
                `;
              }
            }

            card.classList.add("selected");
            card.innerHTML = `
              <div>${displayId}</div>
              <div>${backendRoom.occupied + 1}/${backendRoom.places}</div>
            `;
          };
        }
      }
    }
    </script>
  </body>
</html>