<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Выбор комнаты</title>
    <style>
      .spinner {
        border: 2px solid #fff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f0f2f5;
        padding: 20px;
        font-size: 14px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }
      .form-wrapper {
        max-width: 600px;
        background: #fff;
        padding: 20px;
        margin: 40px auto;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
      }
      h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      .room-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: space-between;
      }
      .room-card {
        border: 2px solid #ccc;
        width: 18%;
        min-width: 60px;
        height: 70px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        border-radius: 6px;
        background-color: #fff;
        box-sizing: border-box;
      }
      .room-card.available {
        border-color: green;
      }
      .room-card.full {
        border-color: red;
      }
      .room-card.selected {
        background-color: #004d99;
        color: #ffffff;
        border: 2px solid #004d99;
        box-shadow: 0 0 8px rgba(0, 77, 153, 0.8);
        transform: scale(1.05);
        animation: pop 0.3s ease-in-out;
      }

      .room-card:not(.selected) {
        transition: all 0.25s ease;
      }

      .room-card:hover {
        transform: scale(1.02);
        border-color: #004d99;
        box-shadow: 0 0 4px rgba(0, 77, 153, 0.4);
      }
      .room-status {
        margin-top: 8px;
        font-size: 13px;
        font-weight: bold;
      }
      .free {
        color: green;
      }
      .occupied {
        color: red;
      }
      .btn {
        background-color: #004d99;
        color: white;
        border: none;
        padding: 10px;
        margin-top: 20px;
        width: 100%;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
      }
      .floor-section {
        margin-bottom: 20px;
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
      }

      .floor-section.hidden {
        opacity: 0;
        pointer-events: none;
        height: 0;
        overflow: hidden;
        padding: 0;
        margin: 0;
      }
      .floor-section.collapsed .room-grid {
        display: none !important;
      }
      #block-sections h3 {
        margin-top: 30px;
        color: #004d99;
      }
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
        background-color: #fff;
        transition: border-color 0.3s;
      }
      select:focus {
        border-color: #004d99;
        box-shadow: 0 0 0 2px rgba(0, 77, 153, 0.2);
        outline: none;
      }
      option:checked {
        background-color: #004d99;
        color: white;
      }
      @media (max-width: 768px) {
        .blocks-wrapper {
          flex-direction: column;
        }
        .block-column {
          width: 100%;
        }
      }
      .custom-select-wrapper {
        position: relative;
        user-select: none;
      }

      .custom-select {
        background-color: #fff;
        border: 2px solid #ccc;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: border-color 0.3s;
        position: relative;
      }

      .custom-select::after {
        content: "▾";
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #004d99;
        font-size: 14px;
        pointer-events: none;
      }

      .custom-select.active,
      .custom-select:hover {
        border-color: #004d99;
      }

      .custom-options {
        position: absolute;
        background-color: #fff;
        border: 2px solid #ccc;
        border-top: none;
        width: 100%;
        max-height: 180px;
        overflow-y: auto;
        display: none;
        z-index: 10;
      }

      .custom-options div {
        padding: 10px;
        cursor: pointer;
      }

      .custom-options div:hover {
        background-color: #004d99;
        color: white;
      }
      @media (max-width: 360px) {
        .room-card {
          width: 45% !important;
        }
      }
    </style>
    <style>
      .toast {
        position: fixed;
        background-color: #333;
        color: white;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease, transform 0.5s ease;
        z-index: 9999;
      }
      .toast.show {
        opacity: 1;
        pointer-events: auto;
      }
      .toast.success { background-color: #28a745; }
      .toast.error   { background-color: hsl(354, 70%, 54%); }
      .toast.info { background-color: #004d99; }
      @media (min-width: 481px) {
        .toast {
          bottom: 20px;
          right: 20px;
          transform: translateY(20px);
        }
        .toast.show {
          transform: translateY(0);
        }
      }
      @media (max-width: 480px) {
        .toast {
          top: 10px;
          left: 50%;
          transform: translateX(-50%) translateY(-20px);
          max-width: 90%;
        }
        .toast.show {
          transform: translateX(-50%) translateY(0);
        }
      }
    </style>
    <style>
      .btn-reset {
        background-color: #ccc;
        color: #333;
        margin-top: 10px;
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        width: 100%;
        box-sizing: border-box;
      }

      .btn-reset:hover {
        background-color: #bbb;
      }
    </style>
  </head>
  <body>
    <div class="form-wrapper">
      <h2>Выбор комнаты</h2>
      <div id="block-sections"></div>
      <div
        style="
          display: flex;
          flex-direction: row;
          justify-content: space-between;
          gap: 10px;
          margin-top: 20px;
        "
      >
        <button type="button" class="btn btn-primary" id="backButton">
          <span class="arrow">&#8592;</span>
          <span class="btn-label">Назад</span>
        </button>
        <button class="btn btn-primary" onclick="confirmRoom()">
          <span class="btn-label">Подтвердить выбор</span>
          <span class="arrow">&#10003;</span>
        </button>
      </div>
      <button type="button" class="btn btn-reset" id="resetButton">
        <span class="btn-label">Сбросить выбор</span>
        <span class="arrow">&#128465;</span>
      </button>
      <div id="toast" class="toast">Уведомление</div>
    </div>

    <script>
      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.className = `toast show ${type}`;
        toast.textContent = message;
        clearTimeout(toast.hideTimeout);
        toast.hideTimeout = setTimeout(() => {
          toast.className = "toast";
        }, 3000);
      }
      const host = window.location.hostname;
      let serverRoomStatus = {};

      // Получаем статус комнат, где occupied учитывает только студентов с has_left = false
      // Важно: backend должен возвращать occupied только по активным студентам!
      async function loadRoomStatus() {
        // Для backend: убедитесь, что SQL-запрос считает только студентов с has_left = false!
        // SQL:
        // SELECT room_id, COUNT(*) as occupied
        // FROM selections
        // JOIN accommodation ON selections.student_id = accommodation.student_id
        // WHERE accommodation.has_left = false
        // GROUP BY room_id
        const res = await fetch(`http://${host}:3000/api/rooms/status`);
        serverRoomStatus = await res.json();
      }

      let rooms = [];

      async function loadRoomsFromDatabase() {
        const res = await fetch(`http://${host}:3000/api/rooms/all`);
        const rawRooms = await res.json();
        rooms = rawRooms.map((r) => ({
          id: r.id,
          block: r.block,
          floor: r.floor,
          places: r.places,
          occupied: r.occupied,
          displayId: r.displayId, // добавляем displayId если есть
          type: "Обычная",
          status: "free"
        }));
      }

      async function initialize() {
        await loadRoomsFromDatabase();
        await loadRoomStatus();
        filterRooms();         // фильтруем сначала
        generateBlocks();      // затем генерируем блоки
      }

      // --- Проверка наличия данных в localStorage ---
      const studentFormDataRaw = localStorage.getItem("studentFormData");
      const studentDocumentsRaw = localStorage.getItem("studentDocuments");

      if (!studentFormDataRaw && !studentDocumentsRaw) {
        alert("Вы не заполнили форму с личными данными и документами.");
        window.location.href = "form-personal.html";
      } else if (!studentFormDataRaw) {
        alert("Вы не заполнили форму с личными данными.");
        window.location.href = "form-personal.html";
      } else if (!studentDocumentsRaw) {
        alert("Вы не заполнили форму с документами.");
        window.location.href = "form-documents.html";
      }

      // --- Room filtering logic based on student data ---
      const studentData = JSON.parse(studentFormDataRaw || "{}");
      const documents = JSON.parse(studentDocumentsRaw || "{}");

      const gender = studentData.gender;
      const hasDisability = documents.hasDisability === "Есть";
      const isGraduated = documents.isGraduate === "Да";

      const blockSections = {};
      const parent = document.getElementById("block-sections");

      // Кастомный выпадающий список для фильтрации этажей
      const customWrapper = document.createElement("div");
      customWrapper.className = "custom-select-wrapper";
      customWrapper.style.marginBottom = "20px";

      const customDisplay = document.createElement("div");
      customDisplay.className = "custom-select";
      customDisplay.textContent = "Показать все этажи";

      const customOptions = document.createElement("div");
      customOptions.className = "custom-options";

      const isMale = gender === "Мужчина";
      const isFemale = gender === "Женщина";

      const values = ["all"];
      const labels = ["Показать все этажи"];

      if (isMale) {
        values.push("3", "5");
        labels.push("Только этаж 3", "Только этаж 5");
      } else if (isFemale) {
        values.push("2", "4");
        labels.push("Только этаж 2", "Только этаж 4");
      }

      values.forEach((val, i) => {
        const opt = document.createElement("div");
        opt.dataset.value = val;
        opt.textContent = labels[i];
        customOptions.appendChild(opt);
      });
      if (customOptions.children.length === 0) {
        const warning = document.createElement("div");
        warning.textContent = "Нет доступных этажей";
        warning.style.color = "red";
        customOptions.appendChild(warning);
      }

      customDisplay.addEventListener("click", () => {
        const isOpen = customOptions.style.display === "block";
        document
          .querySelectorAll(".custom-options")
          .forEach((o) => (o.style.display = "none"));
        document
          .querySelectorAll(".custom-select")
          .forEach((d) => d.classList.remove("active"));
        if (!isOpen) {
          customOptions.style.display = "block";
          customDisplay.classList.add("active");
        }
      });

      // Refactored: use unified filtering logic
      let currentFloorFilter = "all";
      let currentBlockFilter = "all";

      customOptions.querySelectorAll("div").forEach((opt) => {
        opt.addEventListener("click", () => {
          currentFloorFilter = opt.dataset.value;
          customDisplay.textContent = opt.textContent;
          customOptions.style.display = "none";
          applyFilters();
        });
      });

      customWrapper.appendChild(customDisplay);
      customWrapper.appendChild(customOptions);
      parent.appendChild(customWrapper);

      // Кастомный селект для фильтрации по блокам (А, Б, В)
      const blockFilterWrapper = document.createElement("div");
      blockFilterWrapper.className = "custom-select-wrapper";
      blockFilterWrapper.style.marginBottom = "20px";

      const blockDisplay = document.createElement("div");
      blockDisplay.className = "custom-select";
      blockDisplay.textContent = hasDisability || isGraduated ? "Только блок В" : "Показать все блоки";

      const blockOptions = document.createElement("div");
      blockOptions.className = "custom-options";

      const blockValues = ["all", "А", "Б", "В"];
      const blockLabels = [
        "Показать все блоки",
        "Только блок А",
        "Только блок Б",
        "Только блок В",
      ];

      const allowedBlockOptions = hasDisability || isGraduated ? ["В"] : blockValues;
      allowedBlockOptions.forEach((val) => {
        const i = blockValues.indexOf(val);
        const opt = document.createElement("div");
        opt.dataset.value = val;
        opt.textContent = blockLabels[i];
        blockOptions.appendChild(opt);
      });
      if (blockOptions.children.length === 0) {
        const warning = document.createElement("div");
        warning.textContent = "Нет доступных блоков";
        warning.style.color = "red";
        blockOptions.appendChild(warning);
      }

      blockDisplay.addEventListener("click", () => {
        const isOpen = blockOptions.style.display === "block";
        document
          .querySelectorAll(".custom-options")
          .forEach((o) => (o.style.display = "none"));
        document
          .querySelectorAll(".custom-select")
          .forEach((d) => d.classList.remove("active"));
        if (!isOpen) {
          blockOptions.style.display = "block";
          blockDisplay.classList.add("active");
        }
      });

      blockOptions.querySelectorAll("div").forEach((opt) => {
        opt.addEventListener("click", () => {
          currentBlockFilter = opt.dataset.value;
          blockDisplay.textContent = opt.textContent;
          blockOptions.style.display = "none";
          applyFilters();
        });
      });

      function applyFilters() {
        document.querySelectorAll("#block-sections > h3").forEach((h3) => {
          const block = h3.textContent.trim().slice(-1);
          const showBlock =
            currentBlockFilter === "all" || currentBlockFilter === block;

          let sibling = h3.nextElementSibling;
          let anyVisible = false;

          while (sibling && sibling.tagName !== "H3") {
            if (sibling.classList.contains("floor-section")) {
              const toggleBtn = sibling.querySelector("button");
              const floorMatch = toggleBtn?.textContent?.match(/\d+/);
              const floorNumber = floorMatch ? floorMatch[0] : "";
              const showFloor =
                currentFloorFilter === "all" || currentFloorFilter === floorNumber;
              const visible = showBlock && showFloor;

              if (visible) {
                sibling.classList.remove("hidden");
                sibling.style.display = "";
                anyVisible = true;
              } else {
                sibling.classList.add("hidden");
              }
            }
            sibling = sibling.nextElementSibling;
          }

          h3.style.display = anyVisible ? "" : "none";
        });
      }

      blockFilterWrapper.appendChild(blockDisplay);
      blockFilterWrapper.appendChild(blockOptions);
      parent.insertBefore(blockFilterWrapper, customWrapper);

      // Определяем допустимые блоки для пользователя
      const allowedBlocks = hasDisability || isGraduated ? ["В"] : ["А", "Б", "В"];

      // Функция для конвертации латинских блоков в кириллицу
      function convertBlockToCyrillic(block) {
        return block
          .replace(/^A$/, 'А')
          .replace(/^B$/, 'Б')
          .replace(/^V$/, 'В');
      }

      ["А", "Б", "В"].forEach((block) => {
        if (!allowedBlocks.includes(block)) return;
        const cyrBlock = convertBlockToCyrillic(block);
        const blockTitle = document.createElement("h3");
        blockTitle.textContent = `Блок ${cyrBlock}`;
        parent.appendChild(blockTitle);

        blockSections[cyrBlock] = {};

        for (let floor = 2; floor <= 5; floor++) {
          // Новый фильтр этажей согласно условиям
          const autoExpand = hasDisability || isGraduated;
          let allowedFloors = [];
          if (hasDisability) {
            allowedFloors =
              gender === "Мужчина" ? [3, 5] :
              gender === "Женщина" ? [2, 4] : [];
          } else if (isGraduated) {
            allowedFloors = gender === "Мужчина" ? [3, 5] : [2, 4];
          } else {
            allowedFloors = gender === "Мужчина" ? [3, 5] : gender === "Женщина" ? [2, 4] : [];
          }
          if (!allowedFloors.includes(floor)) continue;

          const floorDiv = document.createElement("div");
          floorDiv.className = "floor-section";
          // Всегда сворачиваем все этажи по умолчанию (кроме инвалидов и магистрантов)
          if (!autoExpand) {
            floorDiv.classList.add("collapsed");
          }

          // Новый вариант: одна кнопка-заголовок этажа
          const toggleBtn = document.createElement("button");
          toggleBtn.textContent = `Этаж ${floor}`;
          toggleBtn.style.display = "block";
          toggleBtn.style.width = "100%";
          toggleBtn.style.textAlign = "left";
          toggleBtn.style.padding = "12px";
          toggleBtn.style.margin = "10px 0";
          toggleBtn.style.backgroundColor = "#eceef1";
          toggleBtn.style.border = "1px solid #ccc";
          toggleBtn.style.borderRadius = "8px";
          toggleBtn.style.fontWeight = "bold";
          toggleBtn.style.fontSize = "16px";
          toggleBtn.style.cursor = "pointer";

          const roomGrid = document.createElement("div");
          roomGrid.className = "room-grid";

          toggleBtn.onclick = () => {
            const selectedCard = floorDiv.querySelector(".room-card.selected");
            if (selectedCard) {
              // Не сворачиваем этаж с выбранной комнатой
              return;
            }
            const isHidden = floorDiv.classList.toggle("collapsed");
            roomGrid.style.display = floorDiv.classList.contains("collapsed") ? "none" : "flex";
          };

          floorDiv.appendChild(toggleBtn);
          floorDiv.appendChild(roomGrid);

          blockSections[cyrBlock][floor] = roomGrid;
          parent.appendChild(floorDiv);
        }
      });

      
      const allowedRoomsSet = new Set();

      function filterRooms() {
        allowedRoomsSet.clear();
        console.log("📌 Фильтрация комнат для студента:", { gender, hasDisability, isGraduated });
        rooms.forEach((room) => {
          const block = room.block;
          const roomNum = parseInt(room.id.split("-")[1]);
          const floor = Math.floor(roomNum / 100);

          if (hasDisability) {
            if (
              block === "V" &&
              (
                (gender === "Мужчина" && [305, 306, 307, 308, 505, 506, 507, 508].includes(roomNum)) ||
                (gender === "Женщина" && [205, 206, 207, 208, 405, 406, 407, 408].includes(roomNum))
              )
            ) {
              allowedRoomsSet.add(room.id);
            }
          } else if (isGraduated) {
            if (
              block === "V" &&
              (
                (gender === "Мужчина" && [501, 502, 503, 504, 301, 302, 303, 304].includes(roomNum)) ||
                (gender === "Женщина" && [201, 202, 203, 204, 401, 402, 403, 404].includes(roomNum))
              )
            ) {
              allowedRoomsSet.add(room.id);
            }
          } else {
            if (
              (gender === "Мужчина" && [3, 5].includes(floor)) ||
              (gender === "Женщина" && [2, 4].includes(floor))
            ) {
              allowedRoomsSet.add(room.id);
            }
          }
        });
        console.log("✅ Разрешённые комнаты:", Array.from(allowedRoomsSet));
      }
      function generateBlocks() {
        // Очищаем все grid'ы
        Object.values(blockSections).forEach(floors => {
          Object.values(floors).forEach(grid => grid.innerHTML = "");
        });
        // Сортировка комнат по блоку и номеру комнаты
        rooms.sort((a, b) => {
          const [blockA, numA] = a.id.split("-");
          const [blockB, numB] = b.id.split("-");
          if (blockA !== blockB) return blockA.localeCompare(blockB);
          return parseInt(numA) - parseInt(numB);
        });
        rooms.forEach((room) => {
          // Показываем только разрешённые комнаты
          const backendRoom = serverRoomStatus[room.id];
          if (!backendRoom) return;
          if (!allowedRoomsSet.has(room.id)) return;
          const div = document.createElement("div");
          div.className = "room-card";
          div.dataset.id = room.id;
          // Используем только актуальный occupied с backend (учитывает только студентов с has_left = false)
          const occupied = backendRoom.occupied;
          const places = backendRoom.places;
          if (occupied < places) {
            div.classList.add("available");
          } else {
            div.classList.add("full");
            div.style.pointerEvents = "none";
            div.style.opacity = "0.6";
          }
          div.innerHTML = `
          <div>${room.displayId || room.id}</div>
          <div>${occupied}/${places}</div>
        `;
          if (occupied < places) {
            div.addEventListener("click", () => {
              if (div.classList.contains("selected")) return; // Не увеличивать, если уже выбрана

              // найти предыдущую выбранную комнату
              const previouslySelected = document.querySelector(
                ".room-card.selected"
              );
              if (previouslySelected && previouslySelected !== div) {
                previouslySelected.classList.remove("selected");
                const prevId = previouslySelected.dataset.id;
                // обновляем отображение предыдущей комнаты обратно на backend-значения
                const prevBackend = serverRoomStatus[prevId];
                const prevOccupied = prevBackend ? prevBackend.occupied : 0;
                const prevPlaces = prevBackend ? prevBackend.places : 0;
                // Найти объект комнаты по id, чтобы получить displayId
                const prevRoom = rooms.find(r => r.id === prevId);
                previouslySelected.innerHTML = `
                  <div>${prevRoom?.displayId || prevId}</div>
                  <div>${prevOccupied}/${prevPlaces}</div>
                `;
              }

              // отметить новую выбранную
              div.classList.add("selected");
              // обновить отображение выбранной комнаты, увеличив occupied на 1
              const newOccupied = occupied + 1;
              div.innerHTML = `
                <div>${room.displayId || room.id}</div>
                <div>${newOccupied}/${places}</div>
              `;
            });
          }
          let targetFloor = parseInt(room.id.split("-")[1].charAt(0));
          let blockKey = room.id.split("-")[0];
          let cyrBlockKey = convertBlockToCyrillic(blockKey);
          let floorContainer = blockSections[cyrBlockKey]?.[targetFloor];
          if (floorContainer) {
            floorContainer.appendChild(div);
          }
        });
      }

      async function confirmRoom() {
        const confirmBtn = document.querySelector('button[onclick="confirmRoom()"]');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="btn-label">Сохраняем</span><span class="spinner"></span>';
        const selected = document.querySelector(".room-card.selected");
        if (!selected) {
          alert("Пожалуйста, выберите комнату");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">Подтвердить выбор</span><span class="arrow">&#10003;</span>';
          return;
        }

        // Проверка поддержки localStorage
        try {
          localStorage.setItem("storage_test", "1");
          localStorage.removeItem("storage_test");
        } catch (e) {
          alert(
            "Ошибка: localStorage недоступен. Попробуйте другой браузер или отключите режим инкогнито."
          );
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">Подтвердить выбор</span><span class="arrow">&#10003;</span>';
          return;
        }

        // Проверка, не изменилась ли доступность комнаты
        const roomId = selected.dataset.id;
        // Добавлено: запрет выбора запрещённой комнаты
        if (!allowedRoomsSet.has(roomId)) {
          alert("Выбранная комната не соответствует условиям допуска.");
          selected.classList.remove("selected");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">Подтвердить выбор</span><span class="arrow">&#10003;</span>';
          return;
        }
        // Проверяем актуальность через backend
        const backendRoom = serverRoomStatus[roomId];
        if (!backendRoom || backendRoom.occupied >= backendRoom.places) {
          alert(
            "Ошибка: выбранная комната недоступна. Пожалуйста, выберите другую."
          );
          selected.classList.remove("selected");
          showToast("Комната уже занята. Выберите другую.", "error");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">Подтвердить выбор</span><span class="arrow">&#10003;</span>';
          return;
        }

        // Новый блок: создание personalData, documentsData, fio и studentBody
        const personalData = JSON.parse(localStorage.getItem("studentFormData") || "{}");
        const documentsData = JSON.parse(localStorage.getItem("studentDocuments") || "{}");

        const fio = `${personalData.lastName} ${personalData.firstName}${personalData.middleName ? ' ' + personalData.middleName : ''}`;

        const parsedPayment = Math.max(parseInt((personalData.payment ?? "").replace(/\D/g, ""), 10), 1);
        const parsedRental = Math.max(parseInt(personalData.rentalPeriod ?? "", 10), 1);

        // Удаляем поле 'relative' из personalData, если оно есть, чтобы не отправлять его на сервер
        const { relative, ...personalDataWithoutRelative } = personalData;
        const studentBody = {
          ...personalDataWithoutRelative,
          ...documentsData,
          fio,
          is_graduate: documentsData.isGraduate === "Да",
          has_disability: documentsData.hasDisability === "Есть",
          room_id: selected.dataset.id,
          rental_period: parsedRental,
          payment: parsedPayment,
          moveInDate: personalData.moveInDate || new Date().toISOString().split("T")[0],
          relative_type: personalData.relative,
          relative_phone: personalData.relativePhone,
          document_number: documentsData.documentNumber,
          document_issue_date: documentsData.documentIssueDate,
          document_issuer: documentsData.documentIssuer,
          // --- Поля, которые должны быть в самом конце и переопределять значения из ...documentsData ---
          email: documentsData.email,
          registration_city: documentsData.registrationCity,
          registration_address: documentsData.registrationAddress,
        };

        // Проверки корректности данных
        if (!personalData || !personalData.lastName || !personalData.firstName || !personalData.iin) {
          alert("Вы не заполнили форму с личными данными корректно.");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">Подтвердить выбор</span><span class="arrow">&#10003;</span>';
          window.location.href = "form-personal.html";
          return;
        }

        if (
          !documentsData ||
          !documentsData.documentNumber?.trim() ||
          !documentsData.documentIssueDate?.trim() ||
          !documentsData.documentIssuer?.trim() ||
          !documentsData.isGraduate?.trim() ||
          !documentsData.hasDisability?.trim()
        ) {
          alert("Вы не заполнили форму с документами корректно.");
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">Подтвердить выбор</span><span class="arrow">&#10003;</span>';
          window.location.href = "form-documents.html";
          return;
        }

        // Сохраняем выбранную комнату только после всех проверок
        localStorage.setItem("selectedRoom", selected.dataset.id);

        // --- Новый код: Сохраняем студента и инкрементируем occupied ---
        try {
          // Сохраняем студента
          const saveRes = await fetch(`http://${host}:3000/api/students`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(studentBody)
          });
          if (!saveRes.ok) {
            throw new Error("Ошибка при сохранении данных студента");
          }

          // --- Новый вызов: отправка данных на /api/upload-documents ---
          try {
            const [block, room] = studentBody.room_id.split("-");
            const uploadRes = await fetch(`http://${host}:3000/api/upload-documents`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                lastName: personalData.lastName,
                firstName: personalData.firstName,
                middleName: personalData.middleName,
                iin: personalData.iin,
                phone: personalData.phone,
                email: personalData.email || "",
                university: personalData.university,
                documentNumber: documentsData.documentNumber,
                documentIssueDate: documentsData.documentIssueDate,
                documentIssuer: documentsData.documentIssuer,
                hasDisability: documentsData.hasDisability,
                isGraduate: documentsData.isGraduate,
                room: room,
                block: block,
                registrationAddress: "г. Астана, ул. Мира, д. 30"
              })
            });
            // Не требуется обработка ответа, но можно добавить обработку ошибок при необходимости
          } catch (e) {
            console.error("❌ Не удалось отправить данные для upload-documents:", e.message);
          }

          // WebSocket-оповещение
          socket.send(JSON.stringify({ type: "roomUpdate", roomId: studentBody.room_id }));

        } catch (err) {
          alert("Ошибка при сохранении. Попробуйте ещё раз. " + (err?.message || ""));
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="btn-label">Подтвердить выбор</span><span class="arrow">&#10003;</span>';
          return;
        }

        // Сохраняем firstName перед удалением
        const firstName = personalData.firstName;
        localStorage.removeItem("studentFormData");
        localStorage.removeItem("studentDocuments");
        localStorage.removeItem("selectedRoom");
        // Восстанавливаем только firstName
        localStorage.setItem("studentFirstName", JSON.stringify(firstName));
        window.location.href = "confirmation.html";
      }

      window.addEventListener("click", (e) => {
        if (!e.target.closest(".custom-select-wrapper")) {
          document
            .querySelectorAll(".custom-options")
            .forEach((o) => (o.style.display = "none"));
          document
            .querySelectorAll(".custom-select")
            .forEach((d) => d.classList.remove("active"));
        }
      });
      document.getElementById("resetButton").onclick = function () {
        const selected = document.querySelector(".room-card.selected");
        if (selected) {
          selected.classList.remove("selected");
          const roomId = selected.dataset.id;
          const backendRoom = serverRoomStatus[roomId];
          if (backendRoom) {
            // Найти объект комнаты по id, чтобы получить displayId
            const roomObj = rooms.find(r => r.id === roomId);
            selected.innerHTML = `
              <div>${roomObj?.displayId || roomId}</div>
              <div>${backendRoom.occupied}/${backendRoom.places}</div>
            `;
          }
          showToast("Выбор комнаты сброшен", "info");
        }
      };

      document.getElementById("backButton").onclick = function () {
        window.location.href = "form-documents.html";
      };

      // Запуск инициализации
      initialize();
    </script>
    <script>
      function setupWebSocket() {
        const socket = new WebSocket(`ws://${host}:3000`);

        socket.addEventListener("open", () => {
          console.log("🟢 WebSocket-соединение установлено");
        });

        socket.addEventListener("message", async (event) => {
          console.log("📩 Получено сообщение:", event.data);
          try {
            const data = JSON.parse(event.data);
            if (data.type === "roomUpdate") {
              await loadRoomStatus();
              updateSingleRoom(data.roomId);
              showToast(`Комната ${data.roomId} обновилась`);
            }
          } catch (e) {
            console.error("Ошибка при разборе сообщения WebSocket:", e);
          }
        });

        socket.addEventListener("close", () => {
          console.log("🔁 Переподключение через 3 сек");
          setTimeout(setupWebSocket, 3000);
        });

        socket.addEventListener("error", (err) => {
          console.error("❌ WebSocket ошибка:", err);
        });

        window.socket = socket;
      }

      window.addEventListener("load", () => {
        setupWebSocket();
      });
    </script>
    <script>
    function updateSingleRoom(roomId) {
      const backendRoom = serverRoomStatus[roomId];
      if (!backendRoom) return;

      const card = document.querySelector(`.room-card[data-id="${roomId}"]`);
      if (!card) return;

      // Найти объект комнаты по id, чтобы получить displayId
      const roomObj = rooms.find(r => r.id === roomId);
      const displayId = roomObj?.displayId || roomId;

      const isSelected = card.classList.contains("selected");
      const isFull = backendRoom.occupied >= backendRoom.places;

      // Новый блок обновления innerHTML
      const displayedOccupied = isSelected ? backendRoom.occupied + 1 : backendRoom.occupied;
      card.innerHTML = `
        <div>${displayId}</div>
        <div>${displayedOccupied}/${backendRoom.places}</div>
      `;

      if (isFull) {
        card.classList.remove("available", "selected");
        card.classList.add("full");
        card.style.pointerEvents = "none";
        card.style.opacity = "0.6";
      } else {
        card.classList.remove("full");
        card.classList.add("available");
        card.style.pointerEvents = "";
        card.style.opacity = "";

        if (!isSelected) {
          // card.innerHTML = ... // больше не нужен, обновляется выше
          // card.innerHTML = `
          //   <div>${displayId}</div>
          //   <div>${backendRoom.occupied}/${backendRoom.places}</div>
          // `;
          card.onclick = () => {
            const selected = document.querySelector(".room-card.selected");
            if (selected && selected !== card) {
              selected.classList.remove("selected");
              const sid = selected.dataset.id;
              const backend = serverRoomStatus[sid];
              const selRoomObj = rooms.find(r => r.id === sid);
              if (backend) {
                selected.innerHTML = `
                  <div>${selRoomObj?.displayId || sid}</div>
                  <div>${backend.occupied}/${backend.places}</div>
                `;
              }
            }

            card.classList.add("selected");
            card.innerHTML = `
              <div>${displayId}</div>
              <div>${backendRoom.occupied + 1}/${backendRoom.places}</div>
            `;
          };
        }
      }
    }
    </script>
  </body>
</html>