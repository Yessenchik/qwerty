
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Документы студента</title>
    <style>
      label {
        display: block;
        margin-top: 10px;
        margin-bottom: 10px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 10px 12px;
        margin-top: 4px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
      }
      .date-picker-wrapper input {
        padding: 10px 12px;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23004d99' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px 20px;
        appearance: none;
        -webkit-appearance: none;
        border-radius: 6px;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f0f2f5;
        padding: 20px;
        font-size: 14px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }
      .form-wrapper {
        max-width: 480px;
        background: #fff;
        padding: 20px;
        margin: 40px auto;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
      }
      h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 20px;
      }
      input[type="file"] {
        width: 100%;
        padding: 10px 12px;
        margin-top: 4px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
        height: auto;
      }
      .selfie-wrapper input[type="file"].field-error-input {
        border-color: red !important;
        box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.2);
      }
      .selfie-wrapper.field-error-input {
        border: 1px solid red !important;
        border-radius: 6px;
        padding: 10px;
        box-sizing: border-box;
      }
      .btn {
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
        border: none;
        border-radius: 6px;
        padding: 10px;
        width: 100%;
        cursor: pointer;
        box-sizing: border-box;
      }
      .btn-primary {
        background-color: #004d99;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
      }
      .btn-reset {
        background-color: #ccc;
        color: #333;
        margin-top: 10px;
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        width: 100%;
        box-sizing: border-box;
      }
      .btn-reset:hover {
        background-color: #bbb;
      }
      .arrow {
        font-weight: normal;
      }
      video,
      canvas {
        display: block;
        margin: 10px auto;
        max-width: 100%;
      }
      video {
        transform: scaleX(-1);
      }
      .field-error {
        color: red;
        font-size: 0.85em;
        margin-top: 4px;
      }
      .field-error-input {
        border-color: red !important;
        box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.2);
      }
      @media (max-width: 480px) {
        label {
          font-size: 13px;
        }
        input,
        select,
        input[type="file"],
        .date-picker-wrapper input {
          font-size: 13px;
          padding: 10px 12px;
        }
      }
      .toast {
        position: fixed;
        background-color: #333;
        color: white;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease, transform 0.5s ease;
        z-index: 9999;
      }
      .toast.show {
        opacity: 1;
        pointer-events: auto;
      }
      @media (min-width: 481px) {
        .toast {
          bottom: 20px;
          right: 20px;
          transform: translateY(20px);
        }
        .toast.show {
          transform: translateY(0);
        }
      }

      .gender-selection {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 4px;
      }
      .gender-card {
        flex: 1;
        background-color: #fff;
        border: 2px solid #ccc;
        border-radius: 6px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
        transition: border-color 0.3s, background-color 0.3s, color 0.3s;
      }
      .gender-card input[type="radio"] {
        display: none;
      }
      .gender-card:hover {
        border-color: #004d99;
      }
      .gender-card.selected {
        border-color: #004d99;
        background-color: #004d99;
        color: white;
      }

#uploadOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(255, 255, 255, 0.85);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  font-size: 16px;
  font-family: "Segoe UI", sans-serif;
}
.loader {
  border: 6px solid #ccc;
  border-top: 6px solid #004d99;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1s linear infinite;
  margin-bottom: 12px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  </head>
  <body>
    <div id="toast" class="toast">Уведомление</div>
    <div class="form-wrapper">
      <h2>Загрузка документов студента</h2>
      <form id="documentForm" novalidate>
        <label
          >Удостоверение личности (фотография или скан-копия):
          <input type="file" id="idCard" accept="image/*,application/pdf" />
          <img
            id="idCardPreview"
            alt="Предпросмотр удостоверения"
            style="display: none; max-height: 150px; margin-top: 10px"
          />
        </label>

        <label
          >Справка с места учёбы:
          <input
            type="file"
            id="universityProof"
            accept="image/*,application/pdf"
          />
          <img
            id="universityProofPreview"
            alt="Предпросмотр справки"
            style="display: none; max-height: 150px; margin-top: 10px"
          />
        </label>

        <label>
          Снимок флюрографии:
          <input type="file" id="fluorographyScan" accept="image/*,application/pdf" />
          <img
            id="fluorographyPreview"
            alt="Предпросмотр флюорографии"
            style="display: none; max-height: 150px; margin-top: 10px"
          />
        </label>

        <label>
          Снимок камеры (селфи):
          <input type="file" id="selfieUpload" accept="image/*" />
          <img
            id="selfiePreview"
            alt="Предпросмотр селфи"
            style="display: none; max-height: 150px; margin-top: 10px"
          />
        </label>

        <div style="margin-top: 20px">
          <h2 style="text-align: center; margin-bottom: 20px; font-size: 20px">
            Дополнительные данные
          </h2>

          <label for="email">Email:</label>
          <input type="email" id="email" name="email" placeholder="example@mail.com" required />

          <label for="registrationCity">Город регистрации:</label>
          <input type="text" id="registrationCity" name="registrationCity" placeholder="Астана" required />

          <label for="registrationAddress">Адрес регистрации (улица, дом, кв):</label>
          <input type="text" id="registrationAddress" name="registrationAddress" placeholder="ул. Мира, д. 30, кв. 15" required />

          <label
            >Номер удостоверения личности:
            <input
              type="text"
              id="documentNumber"
              inputmode="numeric"
              pattern="\d*"
            />
          </label>

          <label>Дата выдачи документа:</label>
          <div class="date-picker-wrapper">
            <input
              type="text"
              id="documentIssueDate"
              placeholder="Выберите дату"
            />
          </div>

          <label
            >Орган, выдавший документ:
            <input type="text" id="documentIssuer" placeholder="ҚР ІШКІ ІСТЕР МИНИСТРЛІГІ"/>
          </label>

          <label>Являетесь ли Вы магистрантом?</label>
          <div class="gender-selection">
            <label class="gender-card">
              <input type="radio" name="isGraduate" value="Да" />
              Да
            </label>
            <label class="gender-card">
              <input type="radio" name="isGraduate" value="Нет" />
              Нет
            </label>
          </div>

          <label>Наличие инвалидности:</label>
          <div class="gender-selection">
            <label class="gender-card">
              <input type="radio" name="hasDisability" value="Есть" />
              Есть
            </label>
            <label class="gender-card">
              <input type="radio" name="hasDisability" value="Нету" />
              Нету
            </label>
          </div>
        </div>

        <button type="button" class="btn btn-reset" id="resetButton">
          <span class="btn-label">Сбросить данные</span>
          <span class="arrow">&#128465;</span>
        </button>

        <div
          style="
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
          "
        >
          <button type="button" class="btn btn-primary" id="backButton">
            <span class="arrow">&#8592;</span>
            <span class="btn-label">Назад</span>
          </button>

          <button type="submit" class="btn btn-primary" id="nextButton">
            <span class="btn-label">Далее</span>
            <span class="arrow">&#8594;</span>
          </button>
        </div>
      </form>
    </div>

    <script>
      const form = document.getElementById("documentForm");
      function dataURLtoBlob(dataurl) {
        const arr = dataurl.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], { type: mime });
      }
      const idCardInput = document.getElementById("idCard");
      const fluorographyInput = document.getElementById("fluorographyScan");
      const fluorographyPreview = document.getElementById("fluorographyPreview");
      const selfieInput = document.getElementById("selfieUpload");
      const selfiePreview = document.getElementById("selfiePreview");
      // Превью для fluorography
      fluorographyInput.addEventListener("change", () => {
        previewFile(fluorographyInput, fluorographyPreview);
      });
      selfieInput.addEventListener("change", () => {
        previewFile(selfieInput, selfiePreview);
      });
      const universityProofInput = document.getElementById("universityProof");
      const idCardPreview = document.getElementById("idCardPreview");
      const universityProofPreview = document.getElementById(
        "universityProofPreview"
      );
      const documentNumberInput = document.getElementById("documentNumber");
      // Автоматическая очистка от нецифровых символов
      documentNumberInput.addEventListener("input", () => {
        documentNumberInput.value = documentNumberInput.value.replace(
          /\D/g,
          ""
        );
      });
      const documentIssueDateInput =
        document.getElementById("documentIssueDate");
      const documentIssuerInput = document.getElementById("documentIssuer");
      const resetButton = document.getElementById("resetButton");
      const backButton = document.getElementById("backButton");
      const nextButton = document.getElementById("nextButton");


      // Превью для idCard
      idCardInput.addEventListener("change", () => {
        previewFile(idCardInput, idCardPreview);
      });

      // Превью для universityProof
      universityProofInput.addEventListener("change", () => {
        previewFile(universityProofInput, universityProofPreview);
      });

      // Превью для selfieUpload (мобильное)
      // (canvas больше не используется, превью не делаем)

      function previewFile(inputElement, previewImg) {
        if (inputElement.files && inputElement.files[0]) {
          const file = inputElement.files[0];
          if (file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = function (e) {
              previewImg.src = e.target.result;
              previewImg.style.display = "block";
            };
            reader.readAsDataURL(file);
          } else {
            previewImg.src = "";
            previewImg.style.display = "none";
          }
        } else {
          previewImg.src = "";
          previewImg.style.display = "none";
        }
      }


      // Сброс формы и очистка localStorage, preview, canvas и ошибок
      resetButton.onclick = function () {
        form.reset();
        localStorage.removeItem("studentDocuments");
        idCardPreview.src = "";
        idCardPreview.style.display = "none";
        universityProofPreview.src = "";
        universityProofPreview.style.display = "none";
        fluorographyPreview.src = "";
        fluorographyPreview.style.display = "none";
        document.querySelectorAll(".field-error").forEach((e) => e.remove());
        document.querySelectorAll(".field-error-input").forEach((el) => {
          el.classList.remove("field-error-input");
          el.style.border = "";
        });
        // Убрать выделения radio-кнопок и ошибки
        document
          .querySelectorAll(".gender-card")
          .forEach((card) => card.classList.remove("selected"));
        document
          .querySelectorAll(".gender-selection + .field-error")
          .forEach((err) => err.remove());
        // Сбросить выбор radio-кнопок
        document
          .querySelectorAll('input[type="radio"]')
          .forEach((r) => (r.checked = false));
        // (end radio reset)
      };

      // captureSelfie больше не используется

      // Функция сбора данных формы (без idCardPreview, universityProofPreview, selfieUploaded)
      function collectFormData() {
        return new Promise((resolve) => {
          resolve({
            email: document.getElementById("email").value.trim(),
            registrationCity: document.getElementById("registrationCity").value.trim(),
            registrationAddress: document.getElementById("registrationAddress").value.trim(),
            documentNumber: documentNumberInput.value.trim(),
            documentIssueDate: documentIssueDateInput.value.trim(),
            documentIssuer: documentIssuerInput.value.trim(),
            isGraduate:
              document.querySelector('input[name="isGraduate"]:checked')?.value ||
              "",
            hasDisability:
              document.querySelector('input[name="hasDisability"]:checked')
                ?.value || "",
          });
        });
      }

      // Конвертация файла в base64
      function fileToBase64(file) {
        return new Promise((resolve) => {
          if (!file) {
            resolve(null);
            return;
          }
          const reader = new FileReader();
          reader.onload = function (e) {
            resolve(e.target.result);
          };
          reader.onerror = function () {
            resolve(null);
          };
          reader.readAsDataURL(file);
        });
      }

      // Сохранение только текстовых данных в localStorage
      function saveToLocalStorage(data) {
        const capitalize = (str) =>
          str
            .trim()
            .split(/\s+/)
            .map((w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
            .join(" ");

        const city = data.registrationCity.trim().replace(/^г\.\s*/i, "");
        const formattedCity = "г." + capitalize(city);

        const minimalData = {
          email: data.email,
          registrationCity: formattedCity,
          registrationAddress: data.registrationAddress.trim(),
          documentNumber: data.documentNumber,
          documentIssueDate: data.documentIssueDate,
          documentIssuer: data.documentIssuer.trim(),
          isGraduate: data.isGraduate,
          hasDisability: data.hasDisability,
        };
        localStorage.setItem("studentDocuments", JSON.stringify(minimalData));
      }

      // Загрузка данных из localStorage при загрузке страницы
      window.onload = function () {
        const savedData = localStorage.getItem("studentDocuments");
        let data = null;
        if (savedData) {
          try {
            data = JSON.parse(savedData);
          } catch {
            data = null;
          }
        }
        if (data) {
          if (data.email) document.getElementById("email").value = data.email;
          if (data.registrationCity) document.getElementById("registrationCity").value = data.registrationCity;
          if (data.registrationAddress) document.getElementById("registrationAddress").value = data.registrationAddress;
          if (data.documentNumber)
            documentNumberInput.value = data.documentNumber;
          if (data.documentIssueDate)
            documentIssueDateInput.value = data.documentIssueDate;
          if (data.documentIssuer)
            documentIssuerInput.value = data.documentIssuer;
          if (data.isGraduate) {
            const input = document.querySelector(
              `input[name="isGraduate"][value="${data.isGraduate}"]`
            );
            if (input) {
              input.checked = true;
              input.parentElement.classList.add("selected");
            }
          }
          if (data.hasDisability) {
            const input = document.querySelector(
              `input[name="hasDisability"][value="${data.hasDisability}"]`
            );
            if (input) {
              input.checked = true;
              input.parentElement.classList.add("selected");
            }
          }
        }
        // Нет вставки превью и селфи
        // clearCanvas(); // удалено
        // flatpickr инициализация всегда, только выбор из календаря
        flatpickr("#documentIssueDate", {
          dateFormat: "Y-m-d",
          locale: flatpickr.l10ns.ru,
          allowInput: false, // отключаем ручной ввод
          defaultDate: data?.documentIssueDate || null,
          onChange: function (selectedDates, dateStr) {
            documentIssueDateInput.value = dateStr;
          }
        });
      };

      // Обработчик кнопки "Назад"
      backButton.onclick = function () {
        collectFormData().then((data) => {
          saveToLocalStorage(data); // сохраняем даже без валидации
          window.location.href = "form-personal.html";
        });
      };

      // Создаем контейнер для ошибки селфи (один раз)
      let selfieErrorContainerEl = null;
      function getSelfieErrorContainer() {
        const selfieUpload = document.getElementById("selfieUpload");

        if (selfieErrorContainerEl && selfieErrorContainerEl.parentNode)
          return selfieErrorContainerEl;

        selfieErrorContainerEl = document.createElement("div");
        selfieErrorContainerEl.className = "selfie-error-container";

        selfieUpload.insertAdjacentElement("afterend", selfieErrorContainerEl);

        return selfieErrorContainerEl;
      }

      // --- Определяем selfieUpload только после всех innerHTML ---
      const selfieUpload = document.getElementById("selfieUpload");

      form.onsubmit = function (e) {
        e.preventDefault();

        let hasErrors = false;

        removeError(documentNumberInput);
        removeError(documentIssueDateInput);
        removeError(documentIssuerInput);

        // Remove previous errors for file inputs
        removeError(idCardInput);
        removeError(universityProofInput);

        // Remove previous errors for radio groups
        const isGraduateInput = document.querySelector(
          'input[name="isGraduate"]:checked'
        );
        const hasDisabilityInput = document.querySelector(
          'input[name="hasDisability"]:checked'
        );

        // Remove previous errors
        document
          .querySelectorAll('input[name="isGraduate"]')
          .forEach((el) => removeError(el));
        document
          .querySelectorAll('input[name="hasDisability"]')
          .forEach((el) => removeError(el));

        // Удаляем ошибку селфи
        const selfieErrorContainer = getSelfieErrorContainer();
        removeError(selfieErrorContainer);

        // Новая валидация для email, registrationCity, registrationAddress
        const emailInput = document.getElementById("email");
        const registrationCityInput = document.getElementById("registrationCity");
        const registrationAddressInput = document.getElementById("registrationAddress");

        removeError(emailInput);
        removeError(registrationCityInput);
        removeError(registrationAddressInput);

        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(emailInput.value.trim())) {
          showError(emailInput, "Введите корректный email");
          hasErrors = true;
        }
        if (!registrationCityInput.value.trim()) {
          showError(registrationCityInput, "Введите город регистрации");
          hasErrors = true;
        }
        if (!registrationAddressInput.value.trim()) {
          showError(registrationAddressInput, "Введите адрес регистрации");
          hasErrors = true;
        }

        // Validate document number (мягкая проверка: только цифры)
        if (!/^\d+$/.test(documentNumberInput.value.trim())) {
          showError(documentNumberInput, "Введите номер удостоверения");
          hasErrors = true;
        }
        // Validate issue date (только на заполненность)
        if (!documentIssueDateInput.value.trim()) {
          showError(documentIssueDateInput, "Введите дату выдачи документа");
          hasErrors = true;
        }
        // Validate issuer (только на заполненность)
        if (!documentIssuerInput.value.trim()) {
          showError(documentIssuerInput, "Введите, кем выдан документ");
          hasErrors = true;
        }

        // --- LOG FILES BEFORE FILE VALIDATION ---
        console.log("📄 Проверка файлов перед отправкой:");
        console.log("🪪 Удостоверение личности:", idCardInput?.files?.[0]);
        console.log("🏫 Справка с места учёбы:", universityProofInput?.files?.[0]);
        console.log("🩻 Снимок флюрографии:", fluorographyInput?.files?.[0]);
        console.log("📸 Селфи:", selfieUpload?.files?.[0]);


        // Validate radio buttons
        if (!isGraduateInput) {
          showError(
            document.querySelector('input[name="isGraduate"]'),
            "Выберите вариант для 'Магистрант'"
          );
          hasErrors = true;
        }
        if (!hasDisabilityInput) {
          showError(
            document.querySelector('input[name="hasDisability"]'),
            "Выберите вариант для 'Инвалидность'"
          );
          hasErrors = true;
        }

        // --- ДОБАВЛЕНА ВАЛИДАЦИЯ ФАЙЛОВ ---
        // 1. fluorographyInput
        if (!fluorographyInput.files.length) {
          showError(fluorographyInput, "Загрузите снимок флюорографии");
          hasErrors = true;
        }
        // 2. selfieUpload (селфи)
        if (!selfieUpload.files.length) {
          showError(getSelfieErrorContainer(), "Загрузите селфи");
          hasErrors = true;
        }
        // 3. idCardInput
        if (!idCardInput.files.length) {
          showError(idCardInput, "Загрузите удостоверение личности");
          hasErrors = true;
        }
        // 4. universityProofInput
        if (!universityProofInput.files.length) {
          showError(universityProofInput, "Загрузите справку с места учёбы");
          hasErrors = true;
        }

        if (hasErrors) {
          showToast("Пожалуйста, исправьте ошибки в форме");
          return;
        } else {
          // если ошибок нет — сохранить в localStorage
          const documentData = {
            email: emailInput.value.trim(),
            registrationCity: registrationCityInput.value.trim(),
            registrationAddress: registrationAddressInput.value.trim(),
            documentNumber: documentNumberInput.value.trim(),
            documentIssueDate: documentIssueDateInput.value.trim(),
            documentIssuer: documentIssuerInput.value.trim(),
            isGraduate: isGraduateInput?.value || "",
            hasDisability: hasDisabilityInput?.value || ""
          };
          // Гарантируем сохранение registrationCity и registrationAddress
          saveToLocalStorage({
            ...documentData,
            registrationCity: registrationCityInput.value.trim(),
            registrationAddress: registrationAddressInput.value.trim()
          });
        }

        // Проверка данных со страницы form-personal.html
        const personalDataRaw = localStorage.getItem("studentFormData");
        console.log("Raw data:", personalDataRaw);
        if (!personalDataRaw) {
          alert(
            "Личные данные не найдены. Пожалуйста, заполните предыдущую форму."
          );
          window.location.href = "form-personal.html";
          return;
        }

        let personalData;
        try {
          personalData = JSON.parse(personalDataRaw);
          console.log("Parsed data:", personalData);
        } catch (e) {
          alert("Ошибка чтения личных данных. Повторите ввод.");
          window.location.href = "form-personal.html";
          return;
        }

        if (
          !personalData.firstName ||
          !personalData.lastName ||
          !personalData.phone ||
          personalData.firstName.trim() === "" ||
          personalData.lastName.trim() === "" ||
          personalData.phone.trim() === ""
        ) {
          alert(
            "Личные данные заполнены некорректно. Вернитесь и проверьте информацию."
          );
          window.location.href = "form-personal.html";
          return;
        }

        // --- Overlay show and disable nextButton ---
        document.getElementById("uploadOverlay").style.display = "flex";
        nextButton.disabled = true;

        collectFormData().then((documentData) => {
          // Проверка на пустое имя/фамилию
          if (!personalData.firstName || !personalData.lastName) {
            alert("❌ Имя и фамилия не найдены. Заполните форму с личными данными.");
            return;
          }
          // Проверка на пустые файлы
          if (
            !idCardInput.files[0] ||
            !universityProofInput.files[0] ||
            !fluorographyInput.files[0] ||
            !selfieUpload.files[0]
          ) {
            alert("❌ Один или несколько файлов отсутствуют. Загрузите все 4 документа.");
            return;
          }
          const formData = new FormData();
          // Добавляем ФИО из personalData
          formData.append("firstName", personalData.firstName);
          formData.append("lastName", personalData.lastName);
          formData.append("middleName", personalData.middleName || "");
          formData.append("idCard", idCardInput.files[0]);
          formData.append("universityProof", universityProofInput.files[0]);
          formData.append("fluorography", fluorographyInput.files[0]);
          // Формируем selfieBlob и добавляем в formData
          if (selfieUpload.files.length) {
            const selfieFile = selfieUpload.files[0];
            console.log("📤 SELFIE FILE:", selfieFile);
            console.log("📤 SELFIE name:", selfieFile.name);
            console.log("📤 SELFIE size:", selfieFile.size);
            console.log("📤 SELFIE type:", selfieFile.type);
            formData.append("selfie", selfieFile);
            showToast("✅ Селфи выбрано: " + selfieFile.name);
          } else {
            console.warn("❌ Селфи не выбрано или не читается");
            alert("❌ Селфи не выбрано или не читается — проверьте файл на телефоне.");
          }

          formData.append("documentNumber", documentNumberInput.value.trim());
          formData.append("documentIssueDate", documentIssueDateInput.value.trim());
          formData.append("documentIssuer", documentIssuerInput.value.trim());
          formData.append("isGraduate", isGraduateInput.value);
          formData.append("hasDisability", hasDisabilityInput.value);

          // --- Добавляем поля из form-personal.html и form-documents.html ---
          formData.append("iin", personalData.iin || "");
          formData.append("phone", personalData.phone || "");
          formData.append("email", documentData.email || "");
          formData.append("university", personalData.university || "");
          formData.append("registrationAddress", documentData.registrationAddress || "");
          formData.append("room", personalData.room || "");
          formData.append("block", personalData.block || "");

          // Отправка на сервер
          console.log("📤 Отправляем данные на сервер...");
          const baseURL = location.origin;
          console.log("🌐 fetch URL:", baseURL + "/api/upload");
          fetch(baseURL + "/api/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              document.getElementById("uploadOverlay").style.display = "none";
              nextButton.disabled = false;
              if (!response.ok) throw new Error("Ошибка при загрузке");
              return response.json();
            })
            .then((data) => {
              document.getElementById("uploadOverlay").style.display = "none";
              nextButton.disabled = false;
              if (data.success) {
                showToast("Документы успешно загружены");
                window.location.href = "pick-room.html";
              } else {
                showToast(data.message || "Ошибка: документы не были загружены полностью");
              }
            })
            .catch(async (error) => {
              document.getElementById("uploadOverlay").style.display = "none";
              nextButton.disabled = false;
              console.error("❌ Ошибка загрузки:", error);
              if (error.response) {
                const errorText = await error.response.text();
                console.error("📄 Ответ сервера:", errorText);
              }
              alert("❌ Ошибка загрузки: " + error.message);
              showToast("Ошибка загрузки: " + error.message);
            });
        });
      };

      // Всплывающее уведомление
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.remove("show");
        void toast.offsetWidth;
        toast.classList.add("show");
        clearTimeout(toast.hideTimeout);
        toast.hideTimeout = setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // Валидация полей
      function showError(el, message) {
        removeError(el);
        const error = document.createElement("div");
        // Если это контейнер для селфи-ошибки, просто append, но только если нет уже field-error
        if (
          el.classList && el.classList.contains("selfie-error-container") &&
          el.querySelector(".field-error")
        ) return;
        if (el.classList && el.classList.contains("selfie-error-container")) {
          error.className = "field-error";
          error.innerHTML = "<b>" + message + "</b>";
          el.appendChild(error);
          const selfieInput = document.getElementById("selfieUpload");
          selfieInput.classList.add("field-error-input");
          // Удаляем добавление класса на родителя, чтобы не было двойной рамки
          //selfieInput.parentElement?.classList.add("field-error-input");
          selfieInput.style.border = "";
        } else if (el.type === "radio") {
          const group = document.querySelectorAll(`input[name="${el.name}"]`);
          const groupWrapper = group[0].closest(".gender-selection");
          group.forEach((input) => {
            input.classList.add("field-error-input");
            // Удаляем прямое добавление border, только класс
            if (input.parentElement) {
              input.parentElement.classList.add("field-error-input");
              input.parentElement.style.border = ""; // remove direct style
            }
          });
          if (
            groupWrapper &&
            !groupWrapper.nextElementSibling?.classList.contains("field-error")
          ) {
            const error = document.createElement("div");
            error.className = "field-error";
            error.textContent = message;
            groupWrapper.insertAdjacentElement("afterend", error);
          }
        } else {
          if (el.type === "file") {
            error.className = "field-error";
            error.innerHTML = "<b>" + message + "</b>";
            const parentLabel = el.closest("label");
            if (parentLabel && !parentLabel.querySelector(".field-error")) {
              parentLabel.insertAdjacentElement("beforeend", error);
            } else if (!parentLabel) {
              el.insertAdjacentElement("afterend", error);
            }
          } else {
            error.className = "field-error";
            error.textContent = message;
            el.insertAdjacentElement("afterend", error);
          }
          el.classList.add("field-error-input");
          el.style.border = ""; // remove direct style
        }
      }

      function removeError(el) {
        // Если это контейнер для селфи-ошибки, удаляем все field-error внутри
        if (el.classList && el.classList.contains("selfie-error-container")) {
          Array.from(el.querySelectorAll(".field-error")).forEach((e) =>
            e.remove()
          );
          const selfieInput = document.getElementById("selfieUpload");
          selfieInput.classList.remove("field-error-input");
          selfieInput.parentElement?.classList.remove("field-error-input");
          selfieInput.parentElement?.classList.remove("field-error-input");
          selfieInput.style.border = "";
        } else if (el.type === "radio") {
          const group = document.querySelectorAll(`input[name="${el.name}"]`);
          group.forEach((input) => {
            input.classList.remove("field-error-input");
            if (input.parentElement) {
              input.parentElement.classList.remove("field-error-input");
              input.parentElement.style.border = "";
            }
          });
          // Также удалим ошибку после .gender-selection
          const groupWrapper = el.closest(".gender-selection");
          const next = groupWrapper?.nextElementSibling;
          if (next && next.classList.contains("field-error")) {
            next.remove();
          }
        } else {
          const next = el.nextElementSibling;
          if (next && next.classList.contains("field-error")) {
            next.remove();
          }
          el.classList.remove("field-error-input");
          el.style.border = "";
        }
      }

      function validateOnBlur(el, message, pattern = null) {
        el.addEventListener("blur", () => {
          removeError(el);
          if (!el.value.trim()) {
            showError(el, message);
          } else if (pattern && !pattern.test(el.value.trim())) {
            showError(el, message);
          }
        });
      }

      // Мягкая проверка номера удостоверения на blur:
      validateOnBlur(
        documentNumberInput,
        "Введите номер удостоверения",
        /^\d+$/
      );
      validateOnBlur(
        documentIssueDateInput,
        "Введите дату выдачи документа"
      );
      validateOnBlur(
        documentIssuerInput,
        "Введите, кем выдан документ"
      );
      // Валидация на blur для email, registrationCity, registrationAddress
      validateOnBlur(document.getElementById("email"), "Введите корректный email", /^[^\s@]+@[^\s@]+\.[^\s@]+$/);
      validateOnBlur(document.getElementById("registrationCity"), "Введите город регистрации");
      validateOnBlur(document.getElementById("registrationAddress"), "Введите адрес регистрации");

      // Активация .selected у выбранной radio-кнопки
      document
        .querySelectorAll('.gender-card input[type="radio"]')
        .forEach((radio) => {
          radio.addEventListener("change", () => {
            const group = radio.closest(".gender-selection");
            if (group) {
              group
                .querySelectorAll(".gender-card")
                .forEach((card) => card.classList.remove("selected"));
            }
            radio.parentElement.classList.add("selected");
            removeError(radio); // удаление ошибки при выборе
          });
        });

      // --- ROOM SELECTION PATCH (visual increment on pick-room) ---
      // This code should be added in pick-room.html, not here.
      // Example for reference:
      // div.addEventListener("click", () => {
      //   room.occupied++;
      //   div.querySelector("div:nth-child(2)").textContent = `${room.occupied}/${room.places}`;
      //   div.classList.add("selected");
      //   localStorage.setItem("selectedRoom", JSON.stringify(room));
      // });
    </script>
    <div id="uploadOverlay" style="display: none;">
      <div class="loader"></div>
      <div class="message">Загрузка документов...</div>
    </div>
  </body>
</html>
