<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–î–æ–∫—É–º–µ–Ω—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–∞</title>
    <style>
      label {
        display: block;
        margin-top: 10px;
        margin-bottom: 10px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 10px 12px;
        margin-top: 4px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
      }
      .date-picker-wrapper input {
        padding: 10px 12px;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23004d99' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px 20px;
        appearance: none;
        -webkit-appearance: none;
        border-radius: 6px;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f0f2f5;
        padding: 20px;
        font-size: 14px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }
      .form-wrapper {
        max-width: 480px;
        background: #fff;
        padding: 20px;
        margin: 40px auto;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
      }
      h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 20px;
      }
      .btn {
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
        border: none;
        border-radius: 6px;
        padding: 10px;
        width: 100%;
        cursor: pointer;
        box-sizing: border-box;
      }
      .btn-primary {
        background-color: #004d99;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
      }
      .btn-reset {
        background-color: #ccc;
        color: #333;
        margin-top: 10px;
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        width: 100%;
        box-sizing: border-box;
      }
      .btn-reset:hover {
        background-color: #bbb;
      }
      .arrow {
        font-weight: normal;
      }
      .field-error {
        color: red;
        font-size: 0.85em;
        margin-top: 4px;
      }
      .field-error-input {
        border-color: red !important;
        box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.2);
      }
      @media (max-width: 480px) {
        label {
          font-size: 13px;
        }
        input,
        select,
        input[type="file"],
        .date-picker-wrapper input {
          font-size: 13px;
          padding: 10px 12px;
        }
      }
      .toast {
        position: fixed;
        background-color: #333;
        color: white;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease, transform 0.5s ease;
        z-index: 9999;
      }
      .toast.show {
        opacity: 1;
        pointer-events: auto;
      }
      @media (min-width: 481px) {
        .toast {
          bottom: 20px;
          right: 20px;
          transform: translateY(20px);
        }
        .toast.show {
          transform: translateY(0);
        }
      }

      .gender-selection {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 4px;
      }
      .gender-card {
        flex: 1;
        background-color: #fff;
        border: 2px solid #ccc;
        border-radius: 6px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
        transition: border-color 0.3s, background-color 0.3s, color 0.3s;
      }
      .gender-card input[type="radio"] {
        display: none;
      }
      .gender-card:hover {
        border-color: #004d99;
      }
      .gender-card.selected {
        border-color: #004d99;
        background-color: #004d99;
        color: white;
      }

    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  </head>
  <body>
    <div id="toast" class="toast">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
    <div class="form-wrapper">
      <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å—Ç—É–¥–µ–Ω—Ç–∞</h2>
      <form id="documentForm" novalidate>

        <!-- üîΩ –ë–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
        <div style="margin-top: 10px">
          <label for="idCard">–£–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ (—Ñ–æ—Ç–æ –∏–ª–∏ PDF):</label>
          <input type="file" id="idCard" name="idCard" accept=".pdf,image/*" required />

          <label for="universityProof">–°–ø—Ä–∞–≤–∫–∞ –æ—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ (—Ñ–æ—Ç–æ –∏–ª–∏ PDF):</label>
          <input type="file" id="universityProof" name="universityProof" accept=".pdf,image/*" required />

          <label for="fluorography">–°–Ω–∏–º–æ–∫ —Ñ–ª—é–æ—Ä–æ–≥—Ä–∞—Ñ–∏–∏ (—Ñ–æ—Ç–æ –∏–ª–∏ PDF):</label>
          <input type="file" id="fluorography" name="fluorography" accept=".pdf,image/*" required />

          <label for="dormReferral">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –û–±—â–µ–∂–∏—Ç–∏–µ (—Ñ–æ—Ç–æ –∏–ª–∏ PDF):</label>
          <input type="file" id="dormReferral" name="dormReferral" accept=".pdf,image/*" required />

          <label for="selfie">–°–Ω–∏–º–æ–∫ —Ñ–æ—Ç–æ –ª–∏—Ü–∞ (—Å–µ–ª—Ñ–∏, —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ):</label>
          <input type="file" id="selfie" name="selfie" accept="image/*" required />
        </div>

        <div style="margin-top: 20px">
          <h2 style="text-align: center; margin-bottom: 20px; font-size: 20px">
            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          </h2>

          <label for="email">Email:</label>
          <input type="email" id="email" name="email" placeholder="example@mail.com" required />

          <label for="registrationCity">–ì–æ—Ä–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</label>
          <input type="text" id="registrationCity" name="registrationCity" placeholder="–ê—Å—Ç–∞–Ω–∞" required />

          <label for="registrationAddress">–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—É–ª–∏—Ü–∞, –¥–æ–º, –∫–≤):</label>
          <input type="text" id="registrationAddress" name="registrationAddress" placeholder="—É–ª. –ú–∏—Ä–∞, –¥. 30, –∫–≤. 15" required />

          <label
            >–ù–æ–º–µ—Ä —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è –ª–∏—á–Ω–æ—Å—Ç–∏:
            <input
              type="text"
              id="documentNumber"
              inputmode="numeric"
              pattern="\d*"
            />
          </label>

          <label>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</label>
          <div class="date-picker-wrapper">
            <input
              type="text"
              id="documentIssueDate"
              placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É"
            />
          </div>

          <label
            >–û—Ä–≥–∞–Ω, –≤—ã–¥–∞–≤—à–∏–π –¥–æ–∫—É–º–µ–Ω—Ç:
            <input type="text" id="documentIssuer" placeholder="“ö–† –Ü–®–ö–Ü –Ü–°–¢–ï–† –ú–ò–ù–ò–°–¢–†–õ–Ü–ì–Ü"/>
          </label>

          <label>–Ø–≤–ª—è–µ—Ç–µ—Å—å –ª–∏ –í—ã –º–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç–æ–º?</label>
          <div class="gender-selection">
            <label class="gender-card">
              <input type="radio" name="isGraduate" value="–î–∞" />
              –î–∞
            </label>
            <label class="gender-card">
              <input type="radio" name="isGraduate" value="–ù–µ—Ç" />
              –ù–µ—Ç
            </label>
          </div>

          <label>–ù–∞–ª–∏—á–∏–µ –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏:</label>
          <div class="gender-selection">
            <label class="gender-card">
              <input type="radio" name="hasDisability" value="–ï—Å—Ç—å" />
              –ï—Å—Ç—å
            </label>
            <label class="gender-card">
              <input type="radio" name="hasDisability" value="–ù–µ—Ç—É" />
              –ù–µ—Ç—É
            </label>
          </div>
        </div>

        <button type="button" class="btn btn-reset" id="resetButton">
          <span class="btn-label">–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
          <span class="arrow">&#128465;</span>
        </button>

        <div
          style="
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
          "
        >
          <button type="button" class="btn btn-primary" id="backButton">
            <span class="arrow">&#8592;</span>
            <span class="btn-label">–ù–∞–∑–∞–¥</span>
          </button>

          <button type="submit" class="btn btn-primary" id="nextButton">
            <span class="btn-label">–î–∞–ª–µ–µ</span>
            <span class="arrow">&#8594;</span>
          </button>
        </div>
      </form>
    </div>

    <script>
      const form = document.getElementById("documentForm");
      // –ù–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –∏ –ø—Ä–µ–≤—å—é, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
      const documentNumberInput = document.getElementById("documentNumber");
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—Ç –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
      documentNumberInput.addEventListener("input", () => {
        documentNumberInput.value = documentNumberInput.value.replace(
          /\D/g,
          ""
        );
      });
      const documentIssueDateInput =
        document.getElementById("documentIssueDate");
      const documentIssuerInput = document.getElementById("documentIssuer");
      const resetButton = document.getElementById("resetButton");
      const backButton = document.getElementById("backButton");
      const nextButton = document.getElementById("nextButton");

      // --- File inputs & upload endpoint ---
      const idCardInput = document.getElementById("idCard");
      const universityProofInput = document.getElementById("universityProof");
      const fluorographyInput = document.getElementById("fluorography");
      const dormReferralInput = document.getElementById("dormReferral");
      const selfieInput = document.getElementById("selfie");

      // –ü—É—Ç—å –¥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±—ç–∫–µ (—Å–º. upload.js)
      const UPLOAD_URL = "/api/upload";




      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –∏ –æ—á–∏—Å—Ç–∫–∞ localStorage –∏ –æ—à–∏–±–æ–∫ (–±–µ–∑ –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–æ–≤)
      resetButton.onclick = function () {
        form.reset();
        localStorage.removeItem("studentDocuments");
        document.querySelectorAll(".field-error").forEach((e) => e.remove());
        document.querySelectorAll(".field-error-input").forEach((el) => {
          el.classList.remove("field-error-input");
          el.style.border = "";
        });
        document
          .querySelectorAll(".gender-card")
          .forEach((card) => card.classList.remove("selected"));
        document
          .querySelectorAll('.gender-selection + .field-error')
          .forEach((err) => err.remove());
        document
          .querySelectorAll('input[type="radio"]')
          .forEach((r) => (r.checked = false));
        // –æ—á–∏—Å—Ç–∏–º –æ—à–∏–±–∫–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤
        [idCardInput, universityProofInput, fluorographyInput, dormReferralInput, selfieInput].forEach((el) => {
          if (el) removeError(el);
        });
      };

      // captureSelfie –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

      // –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã (–±–µ–∑ idCardPreview, universityProofPreview, selfieUploaded)
      function collectFormData() {
        return new Promise((resolve) => {
          resolve({
            email: document.getElementById("email").value.trim(),
            registrationCity: document.getElementById("registrationCity").value.trim(),
            registrationAddress: document.getElementById("registrationAddress").value.trim(),
            documentNumber: documentNumberInput.value.trim(),
            documentIssueDate: documentIssueDateInput.value.trim(),
            documentIssuer: documentIssuerInput.value.trim(),
            isGraduate:
              document.querySelector('input[name="isGraduate"]:checked')?.value ||
              "",
            hasDisability:
              document.querySelector('input[name="hasDisability"]:checked')
                ?.value || "",
          });
        });
      }


      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
      function saveToLocalStorage(data) {
        const capitalize = (str) =>
          str
            .trim()
            .split(/\s+/)
            .map((w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
            .join(" ");

        const city = data.registrationCity.trim().replace(/^–≥\.\s*/i, "");
        const formattedCity = "–≥." + capitalize(city);

        const minimalData = {
          email: data.email,
          registrationCity: formattedCity,
          registrationAddress: data.registrationAddress.trim(),
          documentNumber: data.documentNumber,
          documentIssueDate: data.documentIssueDate,
          documentIssuer: data.documentIssuer.trim(),
          isGraduate: data.isGraduate,
          hasDisability: data.hasDisability,
        };
        localStorage.setItem("studentDocuments", JSON.stringify(minimalData));
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.onload = function () {
        const savedData = localStorage.getItem("studentDocuments");
        let data = null;
        if (savedData) {
          try {
            data = JSON.parse(savedData);
          } catch {
            data = null;
          }
        }
        if (data) {
          if (data.email) document.getElementById("email").value = data.email;
          if (data.registrationCity) document.getElementById("registrationCity").value = data.registrationCity;
          if (data.registrationAddress) document.getElementById("registrationAddress").value = data.registrationAddress;
          if (data.documentNumber)
            documentNumberInput.value = data.documentNumber;
          if (data.documentIssueDate)
            documentIssueDateInput.value = data.documentIssueDate;
          if (data.documentIssuer)
            documentIssuerInput.value = data.documentIssuer;
          if (data.isGraduate) {
            const input = document.querySelector(
              `input[name="isGraduate"][value="${data.isGraduate}"]`
            );
            if (input) {
              input.checked = true;
              input.parentElement.classList.add("selected");
            }
          }
          if (data.hasDisability) {
            const input = document.querySelector(
              `input[name="hasDisability"][value="${data.hasDisability}"]`
            );
            if (input) {
              input.checked = true;
              input.parentElement.classList.add("selected");
            }
          }
        }
        // –ù–µ—Ç –≤—Å—Ç–∞–≤–∫–∏ –ø—Ä–µ–≤—å—é –∏ —Å–µ–ª—Ñ–∏
        // clearCanvas(); // —É–¥–∞–ª–µ–Ω–æ
        // flatpickr –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ–≥–¥–∞, —Ç–æ–ª—å–∫–æ –≤—ã–±–æ—Ä –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        flatpickr("#documentIssueDate", {
          dateFormat: "Y-m-d",
          locale: flatpickr.l10ns.ru,
          allowInput: false, // –æ—Ç–∫–ª—é—á–∞–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
          defaultDate: data?.documentIssueDate || null,
          onChange: function (selectedDates, dateStr) {
            documentIssueDateInput.value = dateStr;
          }
        });
      };

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
      backButton.onclick = function () {
        collectFormData().then((data) => {
          saveToLocalStorage(data); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–∂–µ –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
          window.location.href = "form-personal.html";
        });
      };

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è, –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
      form.onsubmit = function (e) {
        e.preventDefault();

        let hasErrors = false;

        const emailInput = document.getElementById("email");
        const registrationCityInput = document.getElementById("registrationCity");
        const registrationAddressInput = document.getElementById("registrationAddress");

        removeError(emailInput);
        removeError(registrationCityInput);
        removeError(registrationAddressInput);

        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(emailInput.value.trim())) {
          showError(emailInput, "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email");
          hasErrors = true;
        }
        if (!registrationCityInput.value.trim()) {
          showError(registrationCityInput, "–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
          hasErrors = true;
        }
        if (!registrationAddressInput.value.trim()) {
          showError(registrationAddressInput, "–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
          hasErrors = true;
        }

        removeError(documentNumberInput);
        removeError(documentIssueDateInput);
        removeError(documentIssuerInput);

        if (!/^\d+$/.test(documentNumberInput.value.trim())) {
          showError(documentNumberInput, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è");
          hasErrors = true;
        }
        if (!documentIssueDateInput.value.trim()) {
          showError(documentIssueDateInput, "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤—ã–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞");
          hasErrors = true;
        }
        if (!documentIssuerInput.value.trim()) {
          showError(documentIssuerInput, "–í–≤–µ–¥–∏—Ç–µ, –∫–µ–º –≤—ã–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç");
          hasErrors = true;
        }

        const isGraduateInput = document.querySelector('input[name="isGraduate"]:checked');
        const hasDisabilityInput = document.querySelector('input[name="hasDisability"]:checked');

        document
          .querySelectorAll('input[name="isGraduate"]')
          .forEach((el) => removeError(el));
        document
          .querySelectorAll('input[name="hasDisability"]')
          .forEach((el) => removeError(el));

        if (!isGraduateInput) {
          showError(document.querySelector('input[name="isGraduate"]'), "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è '–ú–∞–≥–∏—Å—Ç—Ä–∞–Ω—Ç'");
          hasErrors = true;
        }
        if (!hasDisabilityInput) {
          showError(document.querySelector('input[name="hasDisability"]'), "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è '–ò–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å'");
          hasErrors = true;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
        removeError(idCardInput);
        removeError(universityProofInput);
        removeError(fluorographyInput);
        removeError(dormReferralInput);
        removeError(selfieInput);

        const filesMissing = [];
        if (!idCardInput.files[0]) { showError(idCardInput, "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏"); hasErrors = true; filesMissing.push("idCard"); }
        if (!universityProofInput.files[0]) { showError(universityProofInput, "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ø—Ä–∞–≤–∫—É –æ—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞"); hasErrors = true; filesMissing.push("universityProof"); }
        if (!fluorographyInput.files[0]) { showError(fluorographyInput, "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–Ω–∏–º–æ–∫ —Ñ–ª—é–æ—Ä–æ–≥—Ä–∞—Ñ–∏–∏"); hasErrors = true; filesMissing.push("fluorography"); }
        if (!dormReferralInput.files[0]) { showError(dormReferralInput, "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞"); hasErrors = true; filesMissing.push("dormReferral"); }
        if (!selfieInput.files[0]) { showError(selfieInput, "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–µ–ª—Ñ–∏"); hasErrors = true; filesMissing.push("selfie"); }
        // —Å–µ–ª—Ñ–∏ —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ
        if (selfieInput.files[0] && !selfieInput.files[0].type.startsWith("image/")) {
          showError(selfieInput, "–°–µ–ª—Ñ–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ (JPEG/PNG –∏ —Ç.–ø.)");
          hasErrors = true;
        }

        if (hasErrors) {
          showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ");
          return;
        }

        // –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –±—ç–∫ —á–µ—Ä–µ–∑ UPLOAD_URL –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–¥—ë–º –¥–∞–ª–µ–µ.
        // 1) –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        const documentData = {
          email: emailInput.value.trim(),
          registrationCity: registrationCityInput.value.trim(),
          registrationAddress: registrationAddressInput.value.trim(),
          documentNumber: documentNumberInput.value.trim(),
          documentIssueDate: documentIssueDateInput.value.trim(),
          documentIssuer: documentIssuerInput.value.trim(),
          isGraduate: isGraduateInput?.value || "",
          hasDisability: hasDisabilityInput?.value || ""
        };
        saveToLocalStorage(documentData);

        // 2) –î–æ—Å—Ç–∞—ë–º –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–§–ò–û –∏ –¥—Ä.) –∏–∑ localStorage
        const personalDataRaw = localStorage.getItem("studentFormData");
        if (!personalDataRaw) {
          alert("–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ñ–æ—Ä–º—É.");
          window.location.href = "form-personal.html";
          return;
        }
        let personalData;
        try {
          personalData = JSON.parse(personalDataRaw);
        } catch (e) {
          alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–≤–æ–¥.");
          window.location.href = "form-personal.html";
          return;
        }
        if (!personalData.firstName || !personalData.lastName || !personalData.phone ||
            personalData.firstName.trim() === "" || personalData.lastName.trim() === "" || personalData.phone.trim() === "") {
          alert("–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.");
          window.location.href = "form-personal.html";
          return;
        }

        // 3) –°–æ–±–∏—Ä–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –±—ç–∫
        const formData = new FormData();
        // –§–ò–û –∏ –ø–æ–ª—è –±—ç–∫—É (—Å–º. upload.js)
        formData.append("firstName", personalData.firstName || "");
        formData.append("lastName", personalData.lastName || "");
        formData.append("middleName", personalData.middleName || "");
        formData.append("iin", personalData.iin || "");
        formData.append("phone", personalData.phone || "");
        formData.append("email", documentData.email || "");
        formData.append("university", personalData.university || "");
        formData.append("room", personalData.room || "");
        formData.append("block", personalData.block || "");
        formData.append("registrationAddress", documentData.registrationAddress || "");
        // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
        formData.append("documentNumber", documentData.documentNumber || "");
        formData.append("documentIssueDate", documentData.documentIssueDate || "");
        formData.append("documentIssuer", documentData.documentIssuer || "");
        formData.append("hasDisability", documentData.hasDisability || "");
        formData.append("isGraduate", documentData.isGraduate || "");

        // 4) –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º —Ñ–∞–π–ª—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –ø–æ–ª–µ–π
        formData.append("idCard", idCardInput.files[0]);
        formData.append("universityProof", universityProofInput.files[0]);
        formData.append("fluorography", fluorographyInput.files[0]);
        formData.append("dormReferral", dormReferralInput.files[0]);
        formData.append("selfie", selfieInput.files[0]); // —Ç–æ–ª—å–∫–æ image/*

        // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è, –¥–æ–±–∞–≤–∏–º –∫–∞–∫ query (?moveInDate=...)
        const moveInDate = personalData.moveInDate || personalData.settlementDate || "";
        const uploadUrl = moveInDate ? `${UPLOAD_URL}?moveInDate=${encodeURIComponent(moveInDate)}` : UPLOAD_URL;

        // 5) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫ –∏ –∂–¥—ë–º –æ—Ç–≤–µ—Ç
        nextButton.disabled = true;
        nextButton.querySelector(".btn-label").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(uploadUrl, {
          method: "POST",
          body: formData
        })
          .then(async (res) => {
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.success === false) {
              const msg = data.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤";
              throw new Error(msg);
            }
            showToast("–î–æ–∫—É–º–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
            // –ø–µ—Ä–µ—Ö–æ–¥–∏–º –¥–∞–ª—å—à–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
            window.location.href = "pick-room.html";
          })
          .catch((err) => {
            console.error(err);
            showToast(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã");
          })
          .finally(() => {
            nextButton.disabled = false;
            nextButton.querySelector(".btn-label").textContent = "–î–∞–ª–µ–µ";
          });
      };

      // –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.remove("show");
        void toast.offsetWidth;
        toast.classList.add("show");
        clearTimeout(toast.hideTimeout);
        toast.hideTimeout = setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π
      function showError(el, message) {
        removeError(el);
        const error = document.createElement("div");
        if (el.type === "radio") {
          const group = document.querySelectorAll(`input[name="${el.name}"]`);
          const groupWrapper = group[0].closest(".gender-selection");
          group.forEach((input) => {
            input.classList.add("field-error-input");
            if (input.parentElement) {
              input.parentElement.classList.add("field-error-input");
              input.parentElement.style.border = "";
            }
          });
          if (
            groupWrapper &&
            !groupWrapper.nextElementSibling?.classList.contains("field-error")
          ) {
            const error = document.createElement("div");
            error.className = "field-error";
            error.textContent = message;
            groupWrapper.insertAdjacentElement("afterend", error);
          }
        } else {
          error.className = "field-error";
          error.textContent = message;
          el.insertAdjacentElement("afterend", error);
          el.classList.add("field-error-input");
          el.style.border = "";
        }
      }

      function removeError(el) {
        if (el.type === "radio") {
          const group = document.querySelectorAll(`input[name="${el.name}"]`);
          group.forEach((input) => {
            input.classList.remove("field-error-input");
            if (input.parentElement) {
              input.parentElement.classList.remove("field-error-input");
              input.parentElement.style.border = "";
            }
          });
          // –¢–∞–∫–∂–µ —É–¥–∞–ª–∏–º –æ—à–∏–±–∫—É –ø–æ—Å–ª–µ .gender-selection
          const groupWrapper = el.closest(".gender-selection");
          const next = groupWrapper?.nextElementSibling;
          if (next && next.classList.contains("field-error")) {
            next.remove();
          }
        } else {
          const next = el.nextElementSibling;
          if (next && next.classList.contains("field-error")) {
            next.remove();
          }
          el.classList.remove("field-error-input");
          el.style.border = "";
        }
      }

      function validateOnBlur(el, message, pattern = null) {
        el.addEventListener("blur", () => {
          removeError(el);
          if (!el.value.trim()) {
            showError(el, message);
          } else if (pattern && !pattern.test(el.value.trim())) {
            showError(el, message);
          }
        });
      }

      // –ú—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è –Ω–∞ blur:
      validateOnBlur(
        documentNumberInput,
        "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è",
        /^\d+$/
      );
      validateOnBlur(
        documentIssueDateInput,
        "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤—ã–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞"
      );
      validateOnBlur(
        documentIssuerInput,
        "–í–≤–µ–¥–∏—Ç–µ, –∫–µ–º –≤—ã–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç"
      );
      // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ blur –¥–ª—è email, registrationCity, registrationAddress
      validateOnBlur(document.getElementById("email"), "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email", /^[^\s@]+@[^\s@]+\.[^\s@]+$/);
      validateOnBlur(document.getElementById("registrationCity"), "–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
      validateOnBlur(document.getElementById("registrationAddress"), "–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");

      // –ê–∫—Ç–∏–≤–∞—Ü–∏—è .selected —É –≤—ã–±—Ä–∞–Ω–Ω–æ–π radio-–∫–Ω–æ–ø–∫–∏
      document
        .querySelectorAll('.gender-card input[type="radio"]')
        .forEach((radio) => {
          radio.addEventListener("change", () => {
            const group = radio.closest(".gender-selection");
            if (group) {
              group
                .querySelectorAll(".gender-card")
                .forEach((card) => card.classList.remove("selected"));
            }
            radio.parentElement.classList.add("selected");
            removeError(radio); // —É–¥–∞–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
          });
        });

      // --- ROOM SELECTION PATCH (visual increment on pick-room) ---
      // This code should be added in pick-room.html, not here.
      // Example for reference:
      // div.addEventListener("click", () => {
      //   room.occupied++;
      //   div.querySelector("div:nth-child(2)").textContent = `${room.occupied}/${room.places}`;
      //   div.classList.add("selected");
      //   localStorage.setItem("selectedRoom", JSON.stringify(room));
      // });
    </script>
  </body>
</html>
