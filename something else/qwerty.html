<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–û–±—â–µ–∂–∏—Ç–∏–µ: –ë–ª–æ–∫–∏, –ö–æ–º–Ω–∞—Ç—ã, –°—Ç—É–¥–µ–Ω—Ç—ã –∏ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</title>
    <style>
      .student-entry p {
        margin-bottom: 8px;
      }
      input.valid {
        border: 2px solid #28a745 !important;
      }
      .tooltip {
        display: inline-block;
        position: relative;
      }
      .tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: -24px;
        left: 0;
        background: #333;
        color: white;
        padding: 4px 8px;
        font-size: 0.75em;
        border-radius: 4px;
        white-space: nowrap;
        z-index: 10;
      }
      .field-error {
        color: red;
        margin-top: -6px;
        margin-bottom: 8px;
        font-size: 0.85em;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 10px;
        background-color: #f0f2f5;
        font-size: 14px;
      }
      header {
        text-align: center;
        margin-bottom: 10px;
      }
      header h1 {
        margin: 0;
        padding: 10px;
        color: #004d99;
        font-size: 1.5em;
      }
      #searchInput {
        width: 100%;
        max-width: 300px;
        padding: 8px;
        margin: 10px auto;
        display: block;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }
      button.header-btn {
        display: inline-block;
        margin: 5px 5px 15px;
        padding: 6px 12px;
        background-color: #004d99;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
      }
      button.header-btn:hover {
        background-color: #003366;
      }
      #notificationsBtn {
        background-color: #d9534f;
      }
      #notificationsBtn:hover {
        background-color: #c9302c;
      }
      .stats-global {
        text-align: center;
        font-size: 0.9em;
        margin-bottom: 10px;
      }
      .blocks-container {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 10px;
        height: calc(100vh - 180px);
        overflow: hidden;
      }
      .block-column {
        background-color: #fff;
        padding: 10px;
        margin: 5px;
        flex: 1 1 300px;
        min-width: 250px;
        max-height: 100%;
        overflow-y: auto;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }
      .block-column h2 {
        text-align: center;
        margin-bottom: 5px;
        color: #333;
        font-size: 1.1em;
      }
      .block-stats {
        text-align: center;
        font-size: 0.8em;
        color: #555;
        margin-bottom: 5px;
      }
      .floor {
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
      }
      .floor h3 {
        margin: 0;
        padding: 5px 8px;
        background-color: #e9ecef;
        cursor: pointer;
        font-size: 1em;
        color: #555;
      }
      .room-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: none;
      }
      .room-list li {
        padding: 5px 8px;
        border-bottom: 1px solid #ddd;
        background-color: #fafafa;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        font-size: 0.9em;
      }
      .room-list li:last-child {
        border-bottom: none;
      }
      .room-list li span {
        margin-right: 5px;
      }
      .occupied {
        color: #d9534f;
      }
      .free {
        color: #5cb85c;
      }
      .btn {
        padding: 4px 8px;
        background-color: #004d99;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
        margin: 2px;
      }
      .btn:hover {
        background-color: #003366;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background-color: #fff;
        padding: 0; /* —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π padding, –æ–Ω —É–∂–µ –µ—Å—Ç—å –≤ header/body */
        border-radius: 4px;
        width: 90%;
        max-width: 400px;
        position: relative;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* —Å–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–µ–µ */
      }

      .modal-header {
        position: sticky;
        top: 0;
        background-color: #fff;
        z-index: 1;
        border-bottom: 1px solid #ccc;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 1.1em;
      }
      .close {
        font-size: 1.2em;
        cursor: pointer;
      }

      .modal-body {
        padding: 10px 15px;
        overflow-y: auto;
        max-height: calc(90vh - 60px); /* 60px ‚Äî –≤—ã—Å–æ—Ç–∞ header */
      }

      form label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        margin-top: 10px;
      }
      form input,
      form select {
        box-sizing: border-box;
        width: 100%;
        padding: 6px;
        margin-top: 3px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9em;
      }
      @media (max-width: 400px) {
        form input,
        form select,
        .btn {
          font-size: 0.85em;
          padding: 5px;
        }

        .modal-content {
          width: 95%;
          max-width: none;
        }

        .btn {
          width: 100%;
          max-width: 200px;
          margin: 10px auto;
        }
        .student-entry p {
          font-size: 0.9em;
        }
        .student-entry .btn {
          width: 100%;
          margin-top: 6px;
        }
      }

      @media (max-width: 768px) {
        .blocks-container {
          flex-direction: column;
          height: auto;
          overflow: visible;
        }

        .block-column {
          max-height: none;
          overflow: visible;
          margin-bottom: 15px;
        }

        .room-list li {
          flex-direction: column;
          align-items: flex-start;
        }

        .btn {
          font-size: 0.9em;
          padding: 6px 10px;
          width: 100%;
          box-sizing: border-box;
        }
      }
      html,
      body {
        height: auto;
        min-height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
      }
      .currency-input {
        position: relative;
      }
      .currency-input input {
        padding-right: 24px;
      }
      .tenge-symbol {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #555;
        pointer-events: none;
      }

      input[type="date"],
      .flatpickr-input {
        height: 42px;
        font-size: 1rem;
      }

      .flatpickr-calendar {
        font-size: 1.3rem;
        z-index: 9999 !important;
        width: 360px !important;
        padding: 16px !important;
        line-height: 1.6;
      }
      .flatpickr-day.selected,
      .flatpickr-day.startRange,
      .flatpickr-day.endRange,
      .flatpickr-day.selected:hover {
        background: #004d99 !important;
        border-color: #004d99 !important;
      }
      .toast {
      background-color: #333;
      color: white;
      padding: 10px 16px;
      margin-top: 10px;
      border-radius: 6px;
      font-size: 0.9em;
      min-width: 220px;
      max-width: 300px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      animation: fadeInOut 2.3s forwards;
      opacity: 0;
      word-break: break-word;
    }

    .toast.success {
      background-color: #28a745; /* –ó–µ–ª–µ–Ω—ã–π */
    }

    .toast.error {
      background-color: #dc3545; /* –ö—Ä–∞—Å–Ω—ã–π */
    }

    .toast.info {
      background-color: #004d99; /* —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π */
    }

    .toast.warning {
      background-color: #ffc107; /* –ñ–µ–ª—Ç—ã–π */
      color: #333;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(100%); }
      10% { opacity: 1; transform: translateX(0); }
      90% { opacity: 1; transform: translateX(0); }
      100% { opacity: 0; transform: translateX(100%); }
    }
    #toastContainer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      pointer-events: none; /* —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –º–µ—à–∞—é—Ç –Ω–∞–∂–∏–º–∞—Ç—å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–∞–π—Ç–∞ */
    }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
  </head>
  <body>
    <header>
      <h1>–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–æ–Ω–¥ "–ê—Å—Ç–∞–Ω–∞-20"</h1>

      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û –∏–ª–∏ –ò–ò–ù" />

      <button id="notificationsBtn" class="header-btn">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
      <button id="archiveBtn" class="header-btn">–ê—Ä—Ö–∏–≤ –≤—ã–±—ã–≤—à–∏—Ö</button>
      <button id="todayAddedBtn" class="header-btn">–°–µ–≥–æ–¥–Ω—è –¥–æ–±–∞–≤–∏–ª–∏</button>
    </header>

    <section class="stats-global" id="globalStats"></section>

    <div class="blocks-container" id="blocksContainer"></div>

    <div class="modal" id="dossierModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–î–æ—Å—å–µ (–∫–æ–º–Ω–∞—Ç–∞: <span id="dossierRoom"></span>)</h2>
          <span class="close" id="closeDossierModal">&times;</span>
        </div>
        <div class="modal-body">
          <div id="dossierContent"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="addStudentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ (–∫–æ–º–Ω–∞—Ç–∞: <span id="addRoomLabel"></span>)</h2>
          <span class="close" id="closeAddModal">&times;</span>
        </div>
        <div class="modal-body">
          <form id="addStudentForm">
            <div id="formErrorSummary" class="field-error" style="text-align:left; display:none;"></div>
            <label>
              –ö–æ–º–Ω–∞—Ç–∞:
              <input type="text" id="inputRoom" readonly />
            </label>
            <label>
              –§–ò–û:
              <input
                type="text"
                id="inputFio"
                placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                required
              />
            </label>
            <label>
              –ò–ò–ù:
              <input
                type="text"
                id="inputIin"
                inputmode="numeric"
                maxlength="12"
                pattern="\d{12}"
                required
              />
            </label>
            <label>
              –¢–µ–ª–µ—Ñ–æ–Ω:
              <div style="display: flex; align-items: center; gap: 8px">
                <input
                  type="text"
                  id="inputPhone"
                  inputmode="tel"
                  placeholder="+7 700 000 0001"
                  required
                  style="flex: 1"
                />
                <button
                  type="button"
                  class="btn"
                  onclick="copyPhone('inputPhone')"
                >
                  üìã
                </button>
              </div>
            </label>
            <label>
              –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç:
              <select id="inputUniversity" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</option>
                <option value="AITU">AITU</option>
                <option value="ENU">ENU</option>
                <option value="NU">NU</option>
                <option value="YESSENOV">YESSENOV</option>
                <option value="MNU">MNU</option>
                <option value="NARXOZ">NARXOZ</option>
              </select>
            </label>
            <label>
              –†–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫:
              <select id="inputRelative" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                <option value="–ú–∞–º–∞">–ú–∞–º–∞</option>
                <option value="–ü–∞–ø–∞">–ü–∞–ø–∞</option>
                <option value="–ë—Ä–∞—Ç">–ë—Ä–∞—Ç</option>
                <option value="–°–µ—Å—Ç—Ä–∞">–°–µ—Å—Ç—Ä–∞</option>
                <option value="–ò–Ω–æ–µ">–ò–Ω–æ–µ</option>
              </select>
            </label>
            <label>
              –¢–µ–ª–µ—Ñ–æ–Ω —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞:
              <div style="display: flex; align-items: center; gap: 8px">
                <input
                  type="text"
                  id="inputRelativePhone"
                  inputmode="tel"
                  placeholder="+7 700 000 0001"
                  required
                  style="flex: 1"
                />
                <button
                  type="button"
                  class="btn"
                  onclick="copyPhone('inputRelativePhone')"
                >
                  üìã
                </button>
              </div>
            </label>
            <label>
              –°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã:
              <div class="currency-input">
                <input
                  type="number"
                  id="inputPayment"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                  required
                />
                <span class="tenge-symbol">‚Ç∏</span>
              </div>
            </label>
            <label>
              –î–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è:
              <div style="display: flex; align-items: center; gap: 8px">
                <input
                  type="text"
                  id="inputMoveInDate"
                  placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É"
                  required
                  style="flex: 1"
                />
                <button type="button" class="btn" onclick="copyMoveInDate()">
                  üìã
                </button>
              </div>
            </label>
            <label>
              –°—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã (–≤ –º–µ—Å):
              <select id="inputRentalPeriod" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫</option>
                <!-- –û–ø—Ü–∏–∏ –æ—Ç 1 –¥–æ 12 -->
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
              </select>
            </label>
            <label>
              –î–æ–±–∞–≤–∏–≤—à–∏–π (–§–ò–û):
              <div style="display: flex; align-items: center; gap: 8px">
                <select id="inputAddedBy" required style="flex: 1">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –§–ò–û</option>
                  <option value="Yessen Zhumagali">Yessen Zhumagali</option>
                </select>
                <button
                  type="button"
                  class="btn"
                  onclick="copySelectValue('inputAddedBy')"
                >
                  üìã
                </button>
              </div>
            </label>
            <div style="text-align: center">
              <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal" id="departedModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–ê—Ä—Ö–∏–≤ –≤—ã–±—ã–≤—à–∏—Ö</h2>
          <span class="close" id="closeDepartedModal">&times;</span>
        </div>
        <div class="modal-body">
          <div id="departedContent"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="notificationsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
          <span class="close" id="closeNotificationsModal">&times;</span>
        </div>
        <div class="modal-body">
          <div id="notificationsContent"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="todayAddedModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>–°–µ–≥–æ–¥–Ω—è –¥–æ–±–∞–≤–∏–ª–∏</h2>
          <span class="close" id="closeTodayAddedModal">&times;</span>
        </div>
        <div class="modal-body">
          <div id="todayAddedContent"></div>
        </div>
      </div>
    </div>

    <script>
      const distribution = {
        –ê: {
          2: {
            rooms: [
              201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213,
              214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226,
              227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239,
            ],
            places: [
              7, 6, 6, 7, 5, 7, 7, 7, 7, 5, 8, 4, 7, 7, 6, 6, 5, 7, 7, 7, 7, 5,
              7, 7, 7, 7, 5, 6, 7, 5, 7, 7, 7, 7, 5, 7, 7, 6, 6,
            ],
          },
          3: {
            rooms: [
              301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313,
              314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 326,
              327, 328, 329, 330, 331, 332, 333, 334, 335, 336, 337, 338, 339,
            ],
            places: [
              7, 6, 6, 7, 5, 7, 7, 7, 7, 5, 8, 4, 7, 7, 6, 6, 5, 7, 7, 7, 7, 5,
              7, 7, 7, 7, 5, 6, 7, 5, 7, 7, 7, 7, 5, 7, 7, 6, 6,
            ],
          },
          4: {
            rooms: [
              401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413,
              414, 415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 426,
              427, 428, 429, 430, 431, 432, 433, 434, 435, 436, 437, 438, 439,
            ],
            places: [
              7, 6, 6, 7, 5, 7, 7, 7, 7, 5, 8, 4, 7, 7, 6, 6, 5, 7, 7, 7, 7, 5,
              7, 7, 7, 7, 5, 6, 7, 5, 7, 7, 7, 7, 5, 7, 7, 6, 6,
            ],
          },
          5: {
            rooms: [
              501, 502, 503, 504, 505, 506, 507, 508, 509, 510, 511, 512, 513,
              514, 515, 516, 517, 518, 519, 520, 521, 522, 523, 524, 525, 526,
              527, 528, 529, 530, 531, 532, 533, 534, 535, 536, 537, 538, 539,
            ],
            places: [
              7, 6, 6, 7, 5, 7, 7, 7, 7, 5, 8, 4, 7, 7, 6, 6, 5, 7, 7, 7, 7, 5,
              7, 7, 7, 7, 5, 6, 7, 5, 7, 7, 7, 7, 5, 7, 7, 6, 6,
            ],
          },
        },
        –ë: {
          2: {
            rooms: [
              201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213,
              214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226,
              227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239,
            ],
            places: [
              7, 6, 6, 7, 5, 7, 7, 7, 7, 5, 8, 4, 7, 7, 6, 6, 5, 7, 7, 7, 7, 5,
              7, 7, 7, 7, 5, 6, 7, 5, 7, 7, 7, 7, 5, 7, 7, 6, 6,
            ],
          },
          3: {
            rooms: [
              301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313,
              314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 326,
              327, 328, 329, 330, 331, 332, 333, 334, 335, 336, 337, 338, 339,
            ],
            places: [
              7, 6, 6, 7, 5, 7, 7, 7, 7, 5, 8, 4, 7, 7, 6, 6, 5, 7, 7, 7, 7, 5,
              7, 7, 7, 7, 5, 6, 7, 5, 7, 7, 7, 7, 5, 7, 7, 6, 6,
            ],
          },
          4: {
            rooms: [
              401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413,
              414, 415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 426,
              427, 428, 429, 430, 431, 432, 433, 434, 435, 436, 437, 438, 439,
            ],
            places: [
              7, 6, 6, 7, 5, 7, 7, 7, 7, 5, 8, 4, 7, 7, 6, 6, 5, 7, 7, 7, 7, 5,
              7, 7, 7, 7, 5, 6, 7, 5, 7, 7, 7, 7, 5, 7, 7, 6, 6,
            ],
          },
          5: {
            rooms: [
              501, 502, 503, 504, 505, 506, 507, 508, 509, 510, 511, 512, 513,
              514, 515, 516, 517, 518, 519, 520, 521, 522, 523, 524, 525, 526,
              527, 528, 529, 530, 531, 532, 533, 534, 535, 536, 537, 538, 539,
            ],
            places: [
              7, 6, 6, 7, 5, 7, 7, 7, 7, 5, 8, 4, 7, 7, 6, 6, 5, 7, 7, 7, 7, 5,
              7, 7, 7, 7, 5, 6, 7, 5, 7, 7, 7, 7, 5, 7, 7, 6, 6,
            ],
          },
        },
        –í: {
          2: {
            rooms: [
              201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213,
              214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226,
              227, 228,
            ],
            places: [
              7, 6, 6, 7, 4, 6, 6, 4, 6, 6, 5, 5, 3, 7, 3, 7, 5, 7, 7, 6, 6, 3,
              7, 5, 7, 7, 6, 6,
            ],
          },
          3: {
            rooms: [
              301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313,
              314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 326,
              327, 328,
            ],
            places: [
              7, 6, 6, 7, 4, 6, 6, 4, 6, 6, 5, 5, 3, 7, 3, 7, 5, 7, 7, 6, 6, 3,
              7, 5, 7, 7, 6, 6,
            ],
          },
          4: {
            rooms: [
              401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413,
              414, 415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 426,
              427, 428,
            ],
            places: [
              7, 6, 6, 7, 4, 6, 6, 4, 6, 6, 5, 5, 3, 7, 3, 7, 5, 7, 7, 6, 6, 3,
              7, 5, 7, 7, 6, 6,
            ],
          },
          5: {
            rooms: [
              501, 502, 503, 504, 505, 506, 507, 508, 509, 510, 511, 512, 513,
              514, 515, 516, 517, 518, 519, 520, 521, 522, 523, 524, 525, 526,
              527, 528,
            ],
            places: [
              7, 6, 6, 7, 4, 6, 6, 4, 6, 6, 5, 5, 3, 7, 3, 7, 5, 7, 7, 6, 6, 3,
              7, 5, 7, 7, 6, 6,
            ],
          },
        },
      };

      const blocksData = {};
      const roomCapacities = {};

      for (let block in distribution) {
        blocksData[block] = {};
        for (let floor in distribution[block]) {
          const floorData = distribution[block][floor];
          const roomsArray = floorData.rooms.map((roomNum, i) => {
            const roomId = `${block}-${roomNum}`;
            roomCapacities[roomId] = floorData.places[i];
            return roomId;
          });
          blocksData[block][floor] = roomsArray;
        }
      }
      let totalRooms = 0;
      for (let block in blocksData) {
        for (let floor in blocksData[block]) {
          totalRooms += blocksData[block][floor].length;
        }
      }
      console.log("–û–±—â–µ–µ —á–∏—Å–ª–æ –∫–æ–º–Ω–∞—Ç:", totalRooms);

      // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
      let students = {}; // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
      let departedArchive = []; // –ê—Ä—Ö–∏–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞


      let currentRoom = null;
      let currentFiltered = null;

      function addMonths(date, months) {
        let d = new Date(date);
        d.setMonth(d.getMonth() + months);
        return d;
      }

      function generateBlocks() {
        const container = document.getElementById("blocksContainer");
        container.innerHTML = "";

        const searchQuery = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        const isSearching = searchQuery.length > 0;

        let globalCapacity = 0;
        let globalOccupied = 0;
        let globalLeft = 0;
        let globalMatches = 0;

        for (let block in blocksData) {
          let blockCapacity = 0;
          let blockOccupied = 0;
          let blockLeft = 0;
          let blockMatches = 0;

          const blockDiv = document.createElement("div");
          blockDiv.classList.add("block-column");
          blockDiv.innerHTML = `<h2>–ë–ª–æ–∫ ${block}</h2>`;

          const floors = blocksData[block];
          for (let floor in floors) {
            const floorDiv = document.createElement("div");
            floorDiv.classList.add("floor");
            const h3 = document.createElement("h3");
            h3.textContent = `–≠—Ç–∞–∂ ${floor}`;
            h3.addEventListener("click", () => {
              const allLists =
                floorDiv.parentElement.querySelectorAll(".room-list");
              allLists.forEach((list) => {
                if (list !== ul) list.style.display = "none";
              });
              ul.style.display = ul.style.display === "none" ? "block" : "none";
            });
            floorDiv.appendChild(h3);

            const ul = document.createElement("ul");
            ul.classList.add("room-list");
            ul.style.display = "none";

            floors[floor].forEach((room) => {
              const roomCapacity = roomCapacities[room] || 5;
              blockCapacity += roomCapacity;
              globalCapacity += roomCapacity;

              const roomStudents = students[room] || [];
              const activeStudents = roomStudents.filter((s) => !s.left);
              const leftStudents = roomStudents.filter((s) => s.left);
              const fullCount = roomStudents.length;

              let filteredStudents = roomStudents;
              if (isSearching) {
                filteredStudents = roomStudents.filter(
                  (s) =>
                    s.fio.toLowerCase().includes(searchQuery) ||
                    s.iin.toLowerCase().includes(searchQuery)
                );
                if (filteredStudents.length === 0) return;
              }
              const displayCount = isSearching
                ? filteredStudents.filter((s) => !s.left).length
                : activeStudents.length;
              blockOccupied += displayCount;
              globalOccupied += displayCount;
              blockLeft += leftStudents.length;
              globalLeft += leftStudents.length;
              if (isSearching) {
                blockMatches += filteredStudents.length;
                globalMatches += filteredStudents.length;
              }

              const li = document.createElement("li");
              li.innerHTML = `<span class="room-number">${room}</span>
                            <span class="room-status ${
                              displayCount > 0 ? "occupied" : "free"
                            }">
                              ${displayCount}/${roomCapacity}
                            </span>`;

              if (activeStudents.length > 0 || isSearching) {
                const viewBtn = document.createElement("button");
                viewBtn.classList.add("btn");
                viewBtn.textContent = "–ü—Ä–æ—Å–º–æ—Ç—Ä";
                viewBtn.addEventListener("click", () => {
                  const validList = isSearching ? filteredStudents : null;
                  openDossierModal(room, validList);
                });
                li.appendChild(viewBtn);
              }
              const addBtn = document.createElement("button");
              addBtn.classList.add("btn");
              addBtn.textContent = "–î–æ–±–∞–≤–∏—Ç—å";
              if (activeStudents.length < roomCapacity) {
                addBtn.addEventListener("click", () => openAddModal(room));
              } else {
                addBtn.disabled = true;
                addBtn.style.backgroundColor = "#ccc";
                addBtn.style.cursor = "not-allowed";
                addBtn.title = "–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞";
              }
              li.appendChild(addBtn);

              ul.appendChild(li);
            });

            if (ul.childElementCount > 0) {
              floorDiv.appendChild(ul);
              blockDiv.appendChild(floorDiv);
            }
          }

          const blockFree = blockCapacity - blockOccupied;
          let statsHTML = `<div class="block-stats">–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${blockCapacity} –º–µ—Å—Ç | –ó–∞–Ω—è—Ç–æ: ${blockOccupied} | –°–≤–æ–±–æ–¥–Ω–æ: ${blockFree} | –í—ã–±—ã–≤—à–∏–µ: ${blockLeft}</div>`;
          if (isSearching) {
            statsHTML += `<div class="block-stats">–ù–∞–π–¥–µ–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: ${blockMatches}</div>`;
          }
          blockDiv.insertAdjacentHTML("afterbegin", statsHTML);
          container.appendChild(blockDiv);
        }

        const globalFree = globalCapacity - globalOccupied;
        let globalStatsHTML = `–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${globalCapacity} –º–µ—Å—Ç | –ó–∞–Ω—è—Ç–æ: ${globalOccupied} | –°–≤–æ–±–æ–¥–Ω–æ: ${globalFree} | –í—ã–±—ã–≤—à–∏–µ: ${globalLeft}`;
        if (isSearching) {
          globalStatsHTML += ` | –ù–∞–π–¥–µ–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: ${globalMatches}`;
        }
        document.getElementById("globalStats").textContent = globalStatsHTML;
      }

      function openDossierModal(room, filtered = null) {
        currentRoom = room;
        const roomStudents = students[room] || [];
        const listToShow = filtered || roomStudents;
        currentFiltered = listToShow;
        document.getElementById("dossierRoom").textContent = room;
        const dossierContent = document.getElementById("dossierContent");
        dossierContent.innerHTML = "";
        if (listToShow.length === 0) {
          dossierContent.innerHTML = `<p>–°—Ç—É–¥–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`;
        } else {
          listToShow.forEach((student) => {
            dossierContent.innerHTML += `
            <div class="student-entry">
              <p><strong>–§–ò–û:</strong> ${student.fio}</p>
              <p><strong>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∫–æ–º–Ω–∞—Ç—ã:</strong> ${
                roomCapacities[room] || 5
              }</p>
              <p><strong>–ó–∞—Å–µ–ª–µ–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</strong> ${
                (students[room] || []).filter((s) => !s.left).length
              }</p>
              <p><strong>–ò–ò–ù:</strong> ${student.iin}</p>
              <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${student.phone}</p>
              <p><strong>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç:</strong> ${student.university}</p>
              <p><strong>–†–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫:</strong> ${student.relative}</p>
              <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞:</strong> ${
                student.relativePhone
              }</p>
              <p><strong>–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã:</strong> ${Number(
                student.payment
              ).toLocaleString("ru-RU")} ‚Ç∏</p>
              <p><strong>–î–∞—Ç–∞ –∑–∞—Å–µ–ª–µ–Ω–∏—è:</strong> ${student.moveInDate}</p>
              <p><strong>–°—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã:</strong> ${student.rentalPeriod} –º–µ—Å.</p>
              <p><strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã:</strong> ${
                addMonths(
                  new Date(student.moveInDate),
                  parseInt(student.rentalPeriod)
                )
                  .toISOString()
                  .split("T")[0]
              }</p>
              <p><strong>–î–æ–±–∞–≤–∏–ª:</strong> ${student.addedBy}</p>
              <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${
                student.left ? "–í—ã–±—ã–≤—à–∏–π" : "–ê–∫—Ç–∏–≤–µ–Ω"
              }</p>
              <button class="btn" onclick="deleteStudent('${room}', '${
              student.iin
            }')">–£–¥–∞–ª–∏—Ç—å</button>
              ${
                !student.left
                  ? `<button class="btn" onclick="markStudentLeft('${room}', '${student.iin}')">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–±—ã–≤—à–µ–≥–æ</button>`
                  : ""
              }
              <hr>
            </div>
          `;
          });
        }
        document.getElementById("dossierModal").style.display = "flex";
      }

      function closeDossierModal() {
        document.getElementById("dossierModal").style.display = "none";
        currentRoom = null;
        currentFiltered = null;
      }

      function openAddModal(room) {
        currentRoom = room;
        document.getElementById("inputRoom").value = room;
        document.getElementById("addRoomLabel").textContent = room;
        document.getElementById("addStudentModal").style.display = "flex";
        // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—è, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞—á–∞–ª –∑–∞–ø–æ–ª–Ω—è—Ç—å —Ñ–æ—Ä–º—É
        // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã ‚Äî —Å—Ä–∞–∑—É –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        // setTimeout(() => validateForm(), 50);
      }

      function closeAddModal() {
        document.getElementById("addStudentModal").style.display = "none";
        // –ù–µ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –æ–Ω–∏ –æ—Å—Ç–∞–ª–∏—Å—å –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
      }

      document
        .getElementById("addStudentForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
          document.querySelectorAll(".field-error").forEach(el => el.remove());

          const fioEl = document.getElementById("inputFio");
          const iinInput = document.getElementById("inputIin");
          const phoneInput = document.getElementById("inputPhone");
          const universityEl = document.getElementById("inputUniversity");
          const relativeEl = document.getElementById("inputRelative");
          const relativePhoneInput =
            document.getElementById("inputRelativePhone");
          const paymentEl = document.getElementById("inputPayment");
          const rentalPeriodEl = document.getElementById("inputRentalPeriod");
          const addedByEl = document.getElementById("inputAddedBy");
          const moveInDateEl = document.getElementById("inputMoveInDate");

          // Reset border styles
          [
            fioEl,
            iinInput,
            phoneInput,
            universityEl,
            relativeEl,
            relativePhoneInput,
            paymentEl,
            rentalPeriodEl,
            addedByEl,
            moveInDateEl,
          ].forEach((el) => {
            el.style.border = "";
          });

          let isValid = true;

          // Validate required fields
          [
            fioEl,
            iinInput,
            phoneInput,
            universityEl,
            relativeEl,
            relativePhoneInput,
            paymentEl,
            rentalPeriodEl,
            addedByEl,
            moveInDateEl,
          ].forEach((el) => {
            if (!el.value.trim()) {
              el.style.border = "2px solid red";
              isValid = false;
            }
          });

          const iinPattern = /^\d{12}$/;
          const phonePattern = /^\+7 \d{3} \d{3} \d{4}$/;

          if (!iinPattern.test(iinInput.value.trim())) {
            iinInput.style.border = "2px solid red";
            isValid = false;
          }
          if (!phonePattern.test(phoneInput.value.trim())) {
            phoneInput.style.border = "2px solid red";
            isValid = false;
          }
          if (!phonePattern.test(relativePhoneInput.value.trim())) {
            relativePhoneInput.style.border = "2px solid red";
            isValid = false;
          }
          if (phoneInput.value.trim() === relativePhoneInput.value.trim()) {
            phoneInput.style.border = "2px solid red";
            relativePhoneInput.style.border = "2px solid red";
            const phoneError = document.createElement("div");
            phoneError.className = "field-error";
            phoneError.style.color = "red";
            phoneError.style.marginTop = "-8px";
            phoneError.style.fontSize = "0.85em";
            phoneError.textContent = "–ù–µ–ª—å–∑—è –≤–≤–æ–¥–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤!";
            phoneInput.closest("label").insertAdjacentElement("afterend", phoneError);
            relativePhoneInput.closest("label").insertAdjacentElement("afterend", phoneError.cloneNode(true));
            isValid = false;
          }

          // === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ò–ò–ù —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ===
          const newIin = iinInput.value.trim();
          for (let roomKey in students) {
            if (students[roomKey].some(s => s.iin === newIin && !s.left)) {
              showError(iinInput, "–°—Ç—É–¥–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –ò–ò–ù —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
              isValid = false;
              break;
            }
          }

          // === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã –±–æ–ª—å—à–µ 0 ===
          if (parseFloat(paymentEl.value.trim()) <= 0) {
            showError(paymentEl, "–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0");
            isValid = false;
          }

          if (!isValid) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
            return;
          }

          const room = document.getElementById("inputRoom").value.trim();
          if (!room) return;
          if (!students[room]) {
            students[room] = [];
          }
          if (students[room].length >= (roomCapacities[room] || 5)) {
            alert(
              `–í —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ${roomCapacities[room] || 5} –º–µ—Å—Ç!`
            );
            return;
          }

          const addDate = new Date().toISOString().split("T")[0];
          students[room].push({
            fio: fioEl.value.trim(),
            iin: iinInput.value.trim(),
            phone: phoneInput.value.trim(),
            university: universityEl.value.trim(),
            relative: relativeEl.value,
            relativePhone: relativePhoneInput.value.trim(),
            payment: paymentEl.value.trim(),
            rentalPeriod: rentalPeriodEl.value,
            moveInDate: moveInDateEl.value,
            left: false,
            addDate,
            addedBy: addedByEl.value.trim(),
          });
          generateBlocks();
          showToast("–°—Ç—É–¥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!", "success");
          // –†—É—á–Ω–æ–π —Å–±—Ä–æ—Å –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –∏ –æ—à–∏–±–æ–∫ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
          document.getElementById("addStudentForm").reset();
          document.querySelectorAll(".field-error").forEach(el => el.remove());
          const summary = document.getElementById("formErrorSummary");
          if (summary) {
            summary.innerHTML = "";
            summary.style.display = "none";
          }
          [
            fioEl, iinInput, phoneInput, universityEl, relativeEl,
            relativePhoneInput, paymentEl, rentalPeriodEl, addedByEl, moveInDateEl
          ].forEach(el => el.classList.remove("tooltip", "field-error", "valid"));
          closeAddModal();
        });

      function deleteStudent(room, iin) {
        if (students[room]) {
          const index = students[room].findIndex((s) => s.iin === iin);
          if (index !== -1) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å –ò–ò–ù ${iin} –∏–∑ –∫–æ–º–Ω–∞—Ç—ã ${room}?`)) {
              showToast("–°—Ç—É–¥–µ–Ω—Ç —É–¥–∞–ª–µ–Ω!", "info");
              students[room].splice(index, 1);
              generateBlocks();
              const searchQuery = document
                .getElementById("searchInput")
                .value.trim()
                .toLowerCase();
              if (searchQuery) {
                const filtered = (students[room] || []).filter(
                  (s) =>
                    s.fio.toLowerCase().includes(searchQuery) ||
                    s.iin.toLowerCase().includes(searchQuery)
                );
                openDossierModal(room, filtered);
              } else {
                openDossierModal(room);
              }
            }
          }
        }
      }

      function markStudentLeft(room, iin) {
        if (students[room]) {
          const student = students[room].find((s) => s.iin === iin);
          if (student && !student.left) {
            if (confirm(`–û—Ç–º–µ—Ç–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å –ò–ò–ù ${iin} –∫–∞–∫ –≤—ã–±—ã–≤—à–µ–≥–æ?`)) {
              showToast("–°—Ç—É–¥–µ–Ω—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –≤—ã–±—ã–≤—à–∏–π!", "warning");
              student.left = true;
              const today = new Date().toISOString().split("T")[0];
              student.leftDate = today;
              departedArchive.push({
                room,
                student: { ...student },
                leftDate: today,
              });
              generateBlocks();
              const searchQuery = document
                .getElementById("searchInput")
                .value.trim()
                .toLowerCase();
              if (searchQuery) {
                const filtered = (students[room] || []).filter(
                  (s) =>
                    s.fio.toLowerCase().includes(searchQuery) ||
                    s.iin.toLowerCase().includes(searchQuery)
                );
                openDossierModal(room, filtered);
              } else {
                openDossierModal(room);
              }
            }
          }
        }
      }

      function openDepartedModal() {
        const modal = document.getElementById("departedModal");
        const content = document.getElementById("departedContent");
        content.innerHTML = "";
        if (departedArchive.length === 0) {
          content.innerHTML = `<p>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</p>`;
        } else {
          departedArchive.forEach((entry) => {
            content.innerHTML += `
            <div class="student-entry">
              <p><strong>–ö–æ–º–Ω–∞—Ç–∞:</strong> ${entry.room}</p>
              <p><strong>–§–ò–û:</strong> ${entry.student.fio}</p>
              <p><strong>–ò–ò–ù:</strong> ${entry.student.iin}</p>
              <p><strong>–î–æ–±–∞–≤–∏–ª:</strong> ${entry.student.addedBy}</p>
              <p><strong>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:</strong> ${entry.student.addDate}</p>
              <p><strong>–î–∞—Ç–∞ –≤—ã–±—ã–≤–∞–Ω–∏—è:</strong> ${entry.leftDate}</p>
              <hr>
            </div>
          `;
          });
        }
        modal.style.display = "flex";
      }

      function closeDepartedModal() {
        document.getElementById("departedModal").style.display = "none";
      }

      function openNotificationsModal() {
        const modal = document.getElementById("notificationsModal");
        const content = document.getElementById("notificationsContent");
        content.innerHTML = "";
        const today = new Date();
        let expiredStudents = [];
        for (let room in students) {
          students[room].forEach((student) => {
            if (!student.left) {
              let moveInDate = new Date(student.moveInDate);
              let rentalMonths = parseInt(student.rentalPeriod, 10);
              let expireDate = addMonths(moveInDate, rentalMonths);
              if (today >= expireDate) {
                expiredStudents.push({
                  room,
                  student,
                  expireDate: expireDate.toISOString().split("T")[0],
                });
              }
            }
          });
        }
        content.innerHTML += `<p><strong>–°—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç—ë–∫—à–∏–º —Å—Ä–æ–∫–æ–º –∞—Ä–µ–Ω–¥—ã:</strong> ${expiredStudents.length}</p>`;
        if (expiredStudents.length === 0) {
          content.innerHTML += `<p>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>`;
        } else {
          expiredStudents.forEach((entry) => {
            content.innerHTML += `
            <div class="student-entry">
              <p><strong>–ö–æ–º–Ω–∞—Ç–∞:</strong> ${entry.room}</p>
              <p><strong>–§–ò–û:</strong> ${entry.student.fio}</p>
              <p><strong>–î–æ–±–∞–≤–∏–ª:</strong> ${entry.student.addedBy}</p>
              <p><strong>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:</strong> ${entry.student.addDate}</p>
              <p><strong>–°—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã (–º–µ—Å):</strong> ${entry.student.rentalPeriod}</p>
              <p><strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã:</strong> ${entry.expireDate}</p>
              <hr>
            </div>
          `;
          });
        }
        modal.style.display = "flex";
      }

      function closeNotificationsModal() {
        document.getElementById("notificationsModal").style.display = "none";
      }

      function openTodayAddedModal() {
        const modal = document.getElementById("todayAddedModal");
        const content = document.getElementById("todayAddedContent");
        content.innerHTML = "";
        const today = new Date().toISOString().split("T")[0];
        let addersSet = new Set();
        let settledSet = new Set();

        for (let room in students) {
          students[room].forEach((student) => {
            if (student.addDate === today) {
              addersSet.add(student.addedBy);
              settledSet.add(student.fio);
            }
          });
        }
        const adders = Array.from(addersSet);
        const settled = Array.from(settledSet);
        content.innerHTML += `<p><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–æ–±–∞–≤–∏–≤—à–∏—Ö —Å–µ–≥–æ–¥–Ω—è:</strong> ${adders.length}</p>`;
        if (adders.length === 0) {
          content.innerHTML += `<p>–°–µ–≥–æ–¥–Ω—è –Ω–∏–∫—Ç–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª —Å—Ç—É–¥–µ–Ω—Ç–æ–≤.</p>`;
        } else {
          content.innerHTML += `<p><strong>–§–ò–û –¥–æ–±–∞–≤–∏–≤—à–∏—Ö:</strong></p>`;
          adders.forEach((name) => {
            content.innerHTML += `<p>${name}</p>`;
          });
        }
        content.innerHTML += `<p><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è:</strong> ${settled.length}</p>`;
        if (settled.length === 0) {
          content.innerHTML += `<p>–°–µ–≥–æ–¥–Ω—è –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞—Å–µ–ª–∏–ª—Å—è.</p>`;
        } else {
          content.innerHTML += `<p><strong>–§–ò–û –∑–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö:</strong></p>`;
          settled.forEach((name) => {
            content.innerHTML += `<p>${name}</p>`;
          });
        }
        modal.style.display = "flex";
      }

      function closeTodayAddedModal() {
        document.getElementById("todayAddedModal").style.display = "none";
      }

      document
        .getElementById("closeDossierModal")
        .addEventListener("click", closeDossierModal);
      document
        .getElementById("closeAddModal")
        .addEventListener("click", closeAddModal);
      document
        .getElementById("closeDepartedModal")
        .addEventListener("click", closeDepartedModal);
      document
        .getElementById("closeNotificationsModal")
        .addEventListener("click", closeNotificationsModal);
      document
        .getElementById("closeTodayAddedModal")
        .addEventListener("click", closeTodayAddedModal);

      window.addEventListener("click", (event) => {
        const dossierModal = document.getElementById("dossierModal");
        const addModal = document.getElementById("addStudentModal");
        const departedModal = document.getElementById("departedModal");
        const notificationsModal =
          document.getElementById("notificationsModal");
        const todayAddedModal = document.getElementById("todayAddedModal");
        if (event.target === dossierModal) closeDossierModal();
        if (event.target === addModal) closeAddModal();
        if (event.target === departedModal) closeDepartedModal();
        if (event.target === notificationsModal) closeNotificationsModal();
        if (event.target === todayAddedModal) closeTodayAddedModal();
      });

      document
        .getElementById("searchInput")
        .addEventListener("input", generateBlocks);
      document
        .getElementById("archiveBtn")
        .addEventListener("click", openDepartedModal);
      document
        .getElementById("notificationsBtn")
        .addEventListener("click", openNotificationsModal);
      document
        .getElementById("todayAddedBtn")
        .addEventListener("click", openTodayAddedModal);

      // fetchDataFromServer(); // –æ—Ç–∫–ª—é—á–µ–Ω–æ, –¥–∞–Ω–Ω—ã–µ —Ç–µ–ø–µ—Ä—å –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ WebSocket

      // --- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å —Ç—É–ª—Ç–∏–ø–∞–º–∏ –∏ summary –æ—à–∏–±–æ–∫ ---
      function showError(el, message) {
        removeError(el);
        el.classList.remove("valid");
        el.style.border = "2px solid red";
        el.setAttribute("data-tooltip", message);
        el.classList.add("tooltip");

        const summary = document.getElementById("formErrorSummary");
        if (summary && !summary.innerHTML.includes(message)) {
          summary.style.display = "block";
          summary.innerHTML += `<div>‚Ä¢ ${message}</div>`;
        }
      }

      function removeError(el) {
        el.style.border = "";
        el.classList.remove("tooltip");
        el.removeAttribute("data-tooltip");
        el.classList.remove("field-error");
        el.classList.add("valid");

        const summary = document.getElementById("formErrorSummary");
        if (summary) {
          summary.innerHTML = "";
          summary.style.display = "none";
        }
      }

      function sanitizeNumericInput(event) {
        const original = event.target.value;
        const cleaned = original.replace(/\D/g, "");
        event.target.value = cleaned;
      }

      // –ú–∞—Å–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +7 XXX XXX XXXX
      function formatPhoneInput(event) {
        let input = event.target.value.replace(/\D/g, "");
        if (input.startsWith("7")) {
          input = input.slice(1); // remove leading 7 if present
        }
        input = input.slice(0, 10); // max 10 digits after +7
        let formatted = "+7 ";
        if (input.length > 0) {
          formatted += input.substring(0, 3);
        }
        if (input.length >= 4) {
          formatted += " " + input.substring(3, 6);
        }
        if (input.length >= 7) {
          formatted += " " + input.substring(6, 10);
        }
        event.target.value = formatted.trim();
      }

      const phoneInput = document.getElementById("inputPhone");
      const relativePhoneInput = document.getElementById("inputRelativePhone");
      const iinInput = document.getElementById("inputIin");

      const fioEl = document.getElementById("inputFio");
      const universityEl = document.getElementById("inputUniversity");
      const relativeEl = document.getElementById("inputRelative");
      const paymentEl = document.getElementById("inputPayment");
      const rentalPeriodEl = document.getElementById("inputRentalPeriod");
      const addedByEl = document.getElementById("inputAddedBy");
      document.addEventListener("DOMContentLoaded", function () {
        flatpickr("#inputMoveInDate", {
          dateFormat: "Y-m-d",
          defaultDate: new Date(),
          locale: "ru",
          minDate: null,
        });
      });

      [
        fioEl,
        iinInput,
        phoneInput,
        universityEl,
        relativeEl,
        relativePhoneInput,
        paymentEl,
        rentalPeriodEl,
        addedByEl,
      ].forEach((el) => {
        el.addEventListener("focus", function () {
          el.style.border = "";
        });
      });

      // === –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ blur (–ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞) ===
      function showError(el, message) {
        removeError(el);
        const error = document.createElement("div");
        error.className = "field-error";
        error.textContent = message;
        el.closest("label").insertAdjacentElement("afterend", error);
        el.style.border = "2px solid red";
      }
      function removeError(el) {
        el.style.border = "";
        const next = el.closest("label").nextElementSibling;
        if (next && next.classList && next.classList.contains("field-error")) {
          next.remove();
        }
      }

      fioEl.addEventListener("blur", () => {
        removeError(fioEl);
        if (!fioEl.value.trim()) showError(fioEl, "–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
      });
      iinInput.addEventListener("blur", () => {
        removeError(iinInput);
        if (!/^\d{12}$/.test(iinInput.value.trim())) showError(iinInput, "–í–≤–µ–¥–∏—Ç–µ –ò–ò–ù –∏–∑ 12 —Ü–∏—Ñ—Ä");
      });
      paymentEl.addEventListener("blur", () => {
        removeError(paymentEl);
        if (!paymentEl.value.trim()) showError(paymentEl, "–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
      });
      const moveInDateEl = document.getElementById("inputMoveInDate");
      moveInDateEl.addEventListener("blur", () => {
        removeError(moveInDateEl);
        if (!moveInDateEl.value.trim()) showError(moveInDateEl, "–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
      });


// –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
function validatePhones() {
  removeError(phoneInput);
  removeError(relativePhoneInput);

  const phoneVal = phoneInput.value.trim();
  const relativeVal = relativePhoneInput.value.trim();
  const pattern = /^\+7 \d{3} \d{3} \d{4}$/;

  if (phoneVal && !pattern.test(phoneVal)) {
    showError(phoneInput, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 XXX XXX XXXX");
  }
  if (relativeVal && !pattern.test(relativeVal)) {
    showError(relativePhoneInput, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 XXX XXX XXXX");
  }

  if (pattern.test(phoneVal) && pattern.test(relativeVal) && phoneVal === relativeVal) {
    showError(phoneInput, "–ù–µ–ª—å–∑—è –≤–≤–æ–¥–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤!");
    showError(relativePhoneInput, "–ù–µ–ª—å–∑—è –≤–≤–æ–¥–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤!");
  }
}

phoneInput.addEventListener("input", formatPhoneInput);
relativePhoneInput.addEventListener("input", formatPhoneInput);

phoneInput.addEventListener("blur", validatePhones);
relativePhoneInput.addEventListener("blur", validatePhones);
      iinInput.addEventListener("input", function (e) {
        sanitizeNumericInput(e);
      });

      function copyMoveInDate() {
        const input = document.getElementById("inputMoveInDate");
        if (input && input.value) {
          navigator.clipboard.writeText(input.value).then(() => {
            showToast("–î–∞—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!", "info");
          });
        }
      }

      function copyPhone(id) {
        const input = document.getElementById(id);
        if (input && input.value) {
          const raw = input.value.replace(/\D/g, "");
          navigator.clipboard
            .writeText("+7" + raw.substring(raw.length - 10))
            .then(() => {
              showToast("–¢–µ–ª–µ—Ñ–æ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!", "info");
            });
        }
      }

      function copySelectValue(id) {
        const select = document.getElementById(id);
        if (select && select.value) {
          navigator.clipboard.writeText(select.value).then(() => {
            showToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: " + select.value, "info");
          });
        }
      }


      // --- fetchDataFromServer –æ—Ç–∫–ª—é—á–µ–Ω–∞, —Ç–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ WebSocket ---
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <div id="toastContainer"></div>
    <script>
      function showToast(message = "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ", type = "success") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 2300); // –∏—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 2.3 —Å–µ–∫—É–Ω–¥—ã
      }
    </script>
    <script>
      // --- WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞ ---
      const socket = io("http://localhost:3000");

      socket.on("update", (data) => {
        students = {};
        data.forEach(s => {
          if (!students[s.room]) students[s.room] = [];
          students[s.room].push(s);
        });
        generateBlocks();
        showToast("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö!", "info");
      });

      async function fetchDataFromServer() {
        const res = await fetch("http://localhost:3000/students");
        const data = await res.json();
        students = {};
        data.forEach(s => {
          if (!students[s.room]) students[s.room] = [];
          students[s.room].push(s);
        });
        generateBlocks();
      }

      document.addEventListener("DOMContentLoaded", fetchDataFromServer);
    </script>
  </body>
</html>